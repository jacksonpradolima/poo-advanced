# Makefile para Ambiente Profissional Python
# ==========================================
#
# Este Makefile demonstra como criar comandos Ãºteis para desenvolvimento,
# testing, qualidade de cÃ³digo e deployment. Ã‰ uma excelente prÃ¡tica para
# padronizar operaÃ§Ãµes comuns em projetos Python profissionais.
#
# Uso: make <comando>
# Exemplo: make test, make lint, make setup

# ================================
# CONFIGURAÃ‡Ã•ES GLOBAIS
# ================================

# Definir shell padrÃ£o (importante para compatibilidade)
SHELL := /bin/bash

# VariÃ¡veis do projeto
PROJECT_NAME := aula-02-ambiente-profissional
PYTHON_VERSION := 3.12
VENV_NAME := .venv
PYTHON := $(VENV_NAME)/bin/python
PIP := $(VENV_NAME)/bin/pip
PYTEST := $(VENV_NAME)/bin/pytest
MYPY := $(VENV_NAME)/bin/mypy
RUFF := $(VENV_NAME)/bin/ruff

# Cores para output (tornar comandos mais legÃ­veis)
RESET := \033[0m
BOLD := \033[1m
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
MAGENTA := \033[35m
CYAN := \033[36m

# ================================
# COMANDOS PRINCIPAIS
# ================================

.PHONY: help
help: ## ğŸ“š Mostrar ajuda com todos os comandos disponÃ­veis
	@echo "$(BOLD)$(BLUE)ğŸš€ $(PROJECT_NAME) - Comandos DisponÃ­veis$(RESET)"
	@echo "$(YELLOW)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "$(CYAN)%-20s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "$(BOLD)Exemplos de uso:$(RESET)"
	@echo "  $(GREEN)make setup$(RESET)     - Configura ambiente completo"
	@echo "  $(GREEN)make test$(RESET)      - Executa todos os testes"
	@echo "  $(GREEN)make check$(RESET)     - Verifica qualidade do cÃ³digo"
	@echo "  $(GREEN)make clean$(RESET)     - Limpa arquivos temporÃ¡rios"

# ================================
# SETUP E CONFIGURAÃ‡ÃƒO
# ================================

.PHONY: setup
setup: ## ğŸ”§ Configurar ambiente completo de desenvolvimento
	@echo "$(BOLD)$(BLUE)ğŸ”§ Configurando ambiente de desenvolvimento...$(RESET)"
	@$(MAKE) venv
	@$(MAKE) install-deps
	@$(MAKE) install-hooks
	@echo "$(BOLD)$(GREEN)âœ… Ambiente configurado com sucesso!$(RESET)"
	@echo ""
	@echo "$(YELLOW)PrÃ³ximos passos:$(RESET)"
	@echo "  1. Ative o ambiente virtual: $(CYAN)source $(VENV_NAME)/bin/activate$(RESET)"
	@echo "  2. Execute os testes: $(CYAN)make test$(RESET)"
	@echo "  3. Verifique a qualidade: $(CYAN)make check$(RESET)"

.PHONY: venv
venv: ## ğŸ Criar ambiente virtual
	@echo "$(BOLD)$(BLUE)ğŸ Criando ambiente virtual...$(RESET)"
	@if [ ! -d "$(VENV_NAME)" ]; then \
		python$(PYTHON_VERSION) -m venv $(VENV_NAME); \
		echo "$(GREEN)âœ… Ambiente virtual criado em $(VENV_NAME)$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  Ambiente virtual jÃ¡ existe$(RESET)"; \
	fi

.PHONY: install-deps
install-deps: venv ## ğŸ“¦ Instalar dependÃªncias do projeto
	@echo "$(BOLD)$(BLUE)ğŸ“¦ Instalando dependÃªncias...$(RESET)"
	@$(PIP) install --upgrade pip
	@$(PIP) install -e ".[dev,docs,quality,testing]"
	@echo "$(GREEN)âœ… DependÃªncias instaladas$(RESET)"

.PHONY: install-hooks
install-hooks: venv ## ğŸ£ Instalar pre-commit hooks
	@echo "$(BOLD)$(BLUE)ğŸ£ Instalando pre-commit hooks...$(RESET)"
	@$(VENV_NAME)/bin/pre-commit install
	@$(VENV_NAME)/bin/pre-commit install --hook-type commit-msg
	@echo "$(GREEN)âœ… Pre-commit hooks instalados$(RESET)"

# ================================
# TESTES E QUALIDADE
# ================================

.PHONY: test
test: ## ğŸ§ª Executar todos os testes
	@echo "$(BOLD)$(BLUE)ğŸ§ª Executando testes...$(RESET)"
	@$(PYTEST) -v --cov=solucoes --cov-report=term-missing --cov-report=html
	@echo "$(GREEN)âœ… Testes concluÃ­dos$(RESET)"

.PHONY: test-fast
test-fast: ## âš¡ Executar testes rÃ¡pidos (apenas falhas anteriores)
	@echo "$(BOLD)$(BLUE)âš¡ Executando testes rÃ¡pidos...$(RESET)"
	@$(PYTEST) -x --lf -q

.PHONY: test-unit
test-unit: ## ğŸ”¬ Executar apenas testes unitÃ¡rios
	@echo "$(BOLD)$(BLUE)ğŸ”¬ Executando testes unitÃ¡rios...$(RESET)"
	@$(PYTEST) -m "not integration" -v

.PHONY: test-integration
test-integration: ## ğŸ”— Executar apenas testes de integraÃ§Ã£o
	@echo "$(BOLD)$(BLUE)ğŸ”— Executando testes de integraÃ§Ã£o...$(RESET)"
	@$(PYTEST) -m "integration" -v

.PHONY: benchmark
benchmark: ## ğŸ“Š Executar testes de performance
	@echo "$(BOLD)$(BLUE)ğŸ“Š Executando benchmarks...$(RESET)"
	@$(PYTEST) --benchmark-only --benchmark-sort=mean

.PHONY: coverage
coverage: ## ğŸ“ˆ Gerar relatÃ³rio de cobertura detalhado
	@echo "$(BOLD)$(BLUE)ğŸ“ˆ Gerando relatÃ³rio de cobertura...$(RESET)"
	@$(PYTEST) --cov=solucoes --cov-report=html --cov-report=term-missing
	@echo "$(GREEN)âœ… RelatÃ³rio gerado em htmlcov/index.html$(RESET)"

# ================================
# QUALIDADE DE CÃ“DIGO
# ================================

.PHONY: lint
lint: ## ğŸ” Verificar qualidade do cÃ³digo com ruff
	@echo "$(BOLD)$(BLUE)ğŸ” Verificando qualidade do cÃ³digo...$(RESET)"
	@$(RUFF) check .

.PHONY: format
format: ## ğŸ¨ Formatar cÃ³digo automaticamente
	@echo "$(BOLD)$(BLUE)ğŸ¨ Formatando cÃ³digo...$(RESET)"
	@$(RUFF) format .
	@echo "$(GREEN)âœ… CÃ³digo formatado$(RESET)"

.PHONY: format-check
format-check: ## âœ… Verificar se cÃ³digo estÃ¡ formatado
	@echo "$(BOLD)$(BLUE)âœ… Verificando formataÃ§Ã£o...$(RESET)"
	@$(RUFF) format --check .

.PHONY: typecheck
typecheck: ## ğŸ” Verificar tipos com mypy
	@echo "$(BOLD)$(BLUE)ğŸ” Verificando tipos...$(RESET)"
	@$(MYPY) solucoes

.PHONY: security
security: ## ğŸ” Verificar problemas de seguranÃ§a
	@echo "$(BOLD)$(BLUE)ğŸ” Verificando seguranÃ§a...$(RESET)"
	@$(VENV_NAME)/bin/bandit -r solucoes -f json | jq -r '.results[] | "âš ï¸  \(.filename):\(.line_number) - \(.issue_text)"' || echo "$(GREEN)âœ… Nenhum problema de seguranÃ§a encontrado$(RESET)"

.PHONY: deps-check
deps-check: ## ğŸ›¡ï¸ Verificar vulnerabilidades em dependÃªncias
	@echo "$(BOLD)$(BLUE)ğŸ›¡ï¸ Verificando dependÃªncias...$(RESET)"
	@$(VENV_NAME)/bin/safety check

.PHONY: check
check: lint format-check typecheck security test ## ğŸš€ Executar verificaÃ§Ã£o completa
	@echo "$(BOLD)$(GREEN)ğŸš€ VerificaÃ§Ã£o completa concluÃ­da com sucesso!$(RESET)"

# ================================
# DOCUMENTAÃ‡ÃƒO
# ================================

.PHONY: docs
docs: ## ğŸ“š Gerar documentaÃ§Ã£o
	@echo "$(BOLD)$(BLUE)ğŸ“š Gerando documentaÃ§Ã£o...$(RESET)"
	@$(VENV_NAME)/bin/pdoc --html --output-dir docs/ solucoes
	@echo "$(GREEN)âœ… DocumentaÃ§Ã£o gerada em docs/$(RESET)"

.PHONY: docs-serve
docs-serve: ## ğŸŒ Servir documentaÃ§Ã£o localmente
	@echo "$(BOLD)$(BLUE)ğŸŒ Servindo documentaÃ§Ã£o em http://localhost:8080$(RESET)"
	@$(VENV_NAME)/bin/pdoc --http localhost:8080 solucoes

# ================================
# EXECUÃ‡ÃƒO DE APLICAÃ‡Ã•ES
# ================================

.PHONY: run-calc
run-calc: ## ğŸ§® Executar calculadora de impostos
	@echo "$(BOLD)$(BLUE)ğŸ§® Executando calculadora de impostos...$(RESET)"
	@$(PYTHON) solucoes/nivel1/calculadora_impostos_solucao.py

.PHONY: run-tasks
run-tasks: ## ğŸ“‹ Executar gerenciador de tarefas
	@echo "$(BOLD)$(BLUE)ğŸ“‹ Executando gerenciador de tarefas...$(RESET)"
	@$(PYTHON) solucoes/nivel1/gerenciador_tarefas_solucao.py

.PHONY: demo
demo: ## ğŸ­ Executar demonstraÃ§Ã£o de todas as funcionalidades
	@echo "$(BOLD)$(BLUE)ğŸ­ DemonstraÃ§Ã£o das aplicaÃ§Ãµes$(RESET)"
	@echo ""
	@echo "$(YELLOW)1. Calculadora de Impostos:$(RESET)"
	@echo "   $(CYAN)make run-calc$(RESET)"
	@echo ""
	@echo "$(YELLOW)2. Gerenciador de Tarefas:$(RESET)"
	@echo "   $(CYAN)make run-tasks$(RESET)"
	@echo ""
	@echo "$(YELLOW)3. Testes Automatizados:$(RESET)"
	@echo "   $(CYAN)make test$(RESET)"

# ================================
# LIMPEZA E MANUTENÃ‡ÃƒO
# ================================

.PHONY: clean
clean: ## ğŸ§¹ Limpar arquivos temporÃ¡rios
	@echo "$(BOLD)$(BLUE)ğŸ§¹ Limpando arquivos temporÃ¡rios...$(RESET)"
	@find . -type f -name "*.pyc" -delete
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf .pytest_cache .mypy_cache htmlcov .coverage dist build
	@echo "$(GREEN)âœ… Limpeza concluÃ­da$(RESET)"

.PHONY: clean-venv
clean-venv: ## ğŸ—‘ï¸ Remover ambiente virtual
	@echo "$(BOLD)$(BLUE)ğŸ—‘ï¸ Removendo ambiente virtual...$(RESET)"
	@rm -rf $(VENV_NAME)
	@echo "$(GREEN)âœ… Ambiente virtual removido$(RESET)"

.PHONY: reset
reset: clean clean-venv ## ğŸ”„ Reset completo do projeto
	@echo "$(BOLD)$(BLUE)ğŸ”„ Reset completo do projeto...$(RESET)"
	@echo "$(GREEN)âœ… Projeto resetado$(RESET)"
	@echo "$(YELLOW)Execute 'make setup' para reconfigurar$(RESET)"

# ================================
# DESENVOLVIMENTO E DEBUGGING
# ================================

.PHONY: shell
shell: ## ğŸš Abrir shell Python interativo
	@echo "$(BOLD)$(BLUE)ğŸš Abrindo shell Python...$(RESET)"
	@$(PYTHON) -i -c "
import sys
print('ğŸ Python', sys.version)
print('ğŸ“ Projeto: $(PROJECT_NAME)')
print('ğŸ’¡ Dica: Import suas classes e teste interativamente!')
print()

# Imports Ãºteis
from solucoes.nivel1.calculadora_impostos_solucao import *
from solucoes.nivel1.gerenciador_tarefas_solucao import *
"

.PHONY: notebook
notebook: ## ğŸ““ Abrir Jupyter Lab
	@echo "$(BOLD)$(BLUE)ğŸ““ Abrindo Jupyter Lab...$(RESET)"
	@$(VENV_NAME)/bin/jupyter lab

.PHONY: debug
debug: ## ğŸ› Executar testes em modo debug
	@echo "$(BOLD)$(BLUE)ğŸ› Executando testes em modo debug...$(RESET)"
	@$(PYTEST) -v -s --pdb --pdbcls=IPython.terminal.debugger:Pdb

# ================================
# CI/CD E DEPLOYMENT
# ================================

.PHONY: ci-check
ci-check: ## ğŸ¤– VerificaÃ§Ã£o completa para CI/CD
	@echo "$(BOLD)$(BLUE)ğŸ¤– Executando verificaÃ§Ã£o CI/CD...$(RESET)"
	@$(MAKE) lint
	@$(MAKE) format-check
	@$(MAKE) typecheck
	@$(MAKE) security
	@$(MAKE) deps-check
	@$(MAKE) test
	@echo "$(BOLD)$(GREEN)âœ… VerificaÃ§Ã£o CI/CD passou!$(RESET)"

.PHONY: build
build: ## ğŸ“¦ Construir pacote para distribuiÃ§Ã£o
	@echo "$(BOLD)$(BLUE)ğŸ“¦ Construindo pacote...$(RESET)"
	@$(PYTHON) -m build
	@echo "$(GREEN)âœ… Pacote construÃ­do em dist/$(RESET)"

.PHONY: release-check
release-check: ## ğŸš€ Verificar se estÃ¡ pronto para release
	@echo "$(BOLD)$(BLUE)ğŸš€ Verificando preparaÃ§Ã£o para release...$(RESET)"
	@$(MAKE) ci-check
	@$(MAKE) build
	@echo "$(BOLD)$(GREEN)âœ… Pronto para release!$(RESET)"

# ================================
# INFORMAÃ‡Ã•ES E STATUS
# ================================

.PHONY: status
status: ## ğŸ“Š Mostrar status do projeto
	@echo "$(BOLD)$(BLUE)ğŸ“Š Status do Projeto$(RESET)"
	@echo "$(YELLOW)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(CYAN)Projeto:$(RESET) $(PROJECT_NAME)"
	@echo "$(CYAN)Python:$(RESET) $(PYTHON_VERSION)"
	@echo "$(CYAN)Ambiente Virtual:$(RESET) $(if $(wildcard $(VENV_NAME)),$(GREEN)âœ… Ativo$(RESET),$(RED)âŒ NÃ£o encontrado$(RESET))"
	@echo ""
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "$(CYAN)DependÃªncias instaladas:$(RESET)"; \
		$(PIP) list --format=columns | head -10; \
		echo "..."; \
		echo ""; \
		echo "$(CYAN)Ãšltima execuÃ§Ã£o de testes:$(RESET)"; \
		if [ -f ".coverage" ]; then \
			echo "$(GREEN)âœ… Cobertura disponÃ­vel$(RESET)"; \
		else \
			echo "$(YELLOW)âš ï¸  Execute 'make test' para gerar cobertura$(RESET)"; \
		fi; \
	fi

.PHONY: info
info: ## â„¹ï¸ InformaÃ§Ãµes detalhadas do ambiente
	@echo "$(BOLD)$(BLUE)â„¹ï¸  InformaÃ§Ãµes do Ambiente$(RESET)"
	@echo "$(YELLOW)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(RESET)"
	@echo "$(CYAN)Sistema Operacional:$(RESET) $$(uname -s) $$(uname -r)"
	@echo "$(CYAN)Arquitetura:$(RESET) $$(uname -m)"
	@echo "$(CYAN)Python do sistema:$(RESET) $$(python3 --version)"
	@echo "$(CYAN)Pip do sistema:$(RESET) $$(pip3 --version)"
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "$(CYAN)Python do venv:$(RESET) $$($$(PYTHON) --version)"; \
		echo "$(CYAN)Pip do venv:$(RESET) $$($$(PIP) --version)"; \
	fi
	@echo "$(CYAN)DiretÃ³rio atual:$(RESET) $$(pwd)"
	@echo "$(CYAN)Tamanho do projeto:$(RESET) $$(du -sh . | cut -f1)"

# ================================
# COMANDOS ESPECIAIS
# ================================

.PHONY: install-uv
install-uv: ## âš¡ Instalar UV (gerenciador de pacotes rÃ¡pido)
	@echo "$(BOLD)$(BLUE)âš¡ Instalando UV...$(RESET)"
	@curl -LsSf https://astral.sh/uv/install.sh | sh
	@echo "$(GREEN)âœ… UV instalado$(RESET)"
	@echo "$(YELLOW)Dica: Use 'uv venv' e 'uv pip install' para velocidade mÃ¡xima$(RESET)"

.PHONY: profile
profile: ## ğŸ“Š Analisar performance do cÃ³digo
	@echo "$(BOLD)$(BLUE)ğŸ“Š Analisando performance...$(RESET)"
	@$(PYTHON) -m cProfile -o profile.stats solucoes/nivel1/calculadora_impostos_solucao.py
	@$(PYTHON) -c "
import pstats
p = pstats.Stats('profile.stats')
p.sort_stats('cumulative').print_stats(10)
"
	@echo "$(GREEN)âœ… Profile salvo em profile.stats$(RESET)"

# ================================
# HOOKS PRE-COMMIT MANUAIS
# ================================

.PHONY: pre-commit
pre-commit: ## ğŸ£ Executar todos os hooks do pre-commit manualmente
	@echo "$(BOLD)$(BLUE)ğŸ£ Executando hooks do pre-commit...$(RESET)"
	@$(VENV_NAME)/bin/pre-commit run --all-files

.PHONY: update-hooks
update-hooks: ## ğŸ”„ Atualizar hooks do pre-commit
	@echo "$(BOLD)$(BLUE)ğŸ”„ Atualizando hooks...$(RESET)"
	@$(VENV_NAME)/bin/pre-commit autoupdate
	@echo "$(GREEN)âœ… Hooks atualizados$(RESET)"

# ================================
# COMANDO PADRÃƒO
# ================================

# Comando executado quando apenas 'make' Ã© digitado
.DEFAULT_GOAL := help

# Prevenir tratamento de nomes como arquivos
.SUFFIXES:


<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Constru√ß√£o e Consumo de APIs REST &#8212; Programa√ß√£o Orientada a Objetos II (Avan√ßado)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=a8e58a58"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://wavedrom.com/skins/default.js"></script>
    <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/aulas/aula-09-14-construcao-consumo-apis-rest/README';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="prev" title="Refatora√ß√£o de C√≥digos, Code Smells e Integra√ß√£o com SonarCloud" href="../aula-07-08-refatoracao-code-smells-sonarcloud/README.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../README.html">
  
  
  
  
  
  
    <p class="title logo__title">Programa√ß√£o Orientada a Objetos II (Avan√ßado)</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    Programa√ß√£o Orientada a Objetos II (POOII) - Python
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Aulas da Disciplina</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aula-01-02-boas-praticas-design-patters/README.html">Boas Pr√°ticas e Design Patterns Cl√°ssicos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aula-03-04-ambiente-profissional-python/README.html">Ambiente Profissional de Projetos Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aula-05-06-git-ci-cd-github-actions/README.html">Git e CI/CD com GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aula-07-08-refatoracao-code-smells-sonarcloud/README.html">Refatora√ß√£o de C√≥digos, Code Smells e Integra√ß√£o com SonarCloud</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Constru√ß√£o e Consumo de APIs REST</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Constru√ß√£o e Consumo de APIs REST</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sumario">Sum√°rio</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abertura-e-engajamento">1. Abertura e Engajamento</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-motivador">1.1. Problema Motivador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contexto-historico-e-relevancia-atual">1.2. Contexto Hist√≥rico e Relev√¢ncia Atual</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentos-teoricos">2. Fundamentos Te√≥ricos</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definicao-e-principios-de-apis-rest">2.1. Defini√ß√£o e Princ√≠pios de APIs REST</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#terminologia-essencial-e-definicoes-formais">2.1.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-dos-principios-rest">2.1.2. Estrutura Conceitual dos Princ√≠pios REST</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-de-consequencias-e-trade-offs">2.1.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-critica-e-faq">2.1.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fastapi-arquitetura-e-ecossistema">2.2. FastAPI: Arquitetura e Ecossistema</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.2.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-do-fastapi">2.2.2. Estrutura Conceitual do FastAPI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.2.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.2.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pydantic-para-validacao-de-dados">2.3. Pydantic para Valida√ß√£o de Dados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.3.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-da-validacao">2.3.2. Estrutura Conceitual da Valida√ß√£o</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.3.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.3.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tratamento-de-erros-e-consumo-de-apis-externas">2.4. Tratamento de Erros e Consumo de APIs Externas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">2.4.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-do-tratamento-de-erros">2.4.2. Estrutura Conceitual do Tratamento de Erros</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">2.4.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">2.4.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacao-pratica-e-implementacao">3. Aplica√ß√£o Pr√°tica e Implementa√ß√£o</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estudo-de-caso-guiado">3.1. Estudo de Caso Guiado</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-1-configuracao-do-ambiente-e-estrutura-do-projeto">Passo 1: Configura√ß√£o do Ambiente e Estrutura do Projeto</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-2-definindo-modelos-de-dados-com-pydantic">Passo 2: Definindo Modelos de Dados com Pydantic</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-3-criando-rotas-restful-com-fastapi">Passo 3: Criando Rotas RESTful com FastAPI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-4-implementando-consumo-de-apis-externas">Passo 4: Implementando Consumo de APIs Externas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-5-implementando-sistema-de-cache">Passo 5: Implementando Sistema de Cache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-6-configuracao-da-aplicacao-principal">Passo 6: Configura√ß√£o da Aplica√ß√£o Principal</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-7-testes-automatizados">Passo 7: Testes Automatizados</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exemplos-de-codigo-comentado">3.2. Exemplos de C√≥digo Comentado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ferramentas-bibliotecas-e-ecossistema">3.3. Ferramentas, Bibliotecas e Ecossistema</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-principais">Depend√™ncias Principais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-de-desenvolvimento-e-teste">Depend√™ncias de Desenvolvimento e Teste</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-de-infraestrutura">Depend√™ncias de Infraestrutura</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#recursos-nativos-do-python">Recursos Nativos do Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decisoes-arquiteturais">Decis√µes Arquiteturais</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#topicos-avancados-e-nuances">4. T√≥picos Avan√ßados e Nuances</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autenticacao-e-autorizacao">4.1. Autentica√ß√£o e Autoriza√ß√£o</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-de-jwt-json-web-tokens">4.1.1. Implementa√ß√£o de JWT (JSON Web Tokens)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#api-keys-e-rate-limiting">4.1.2. API Keys e Rate Limiting</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estrategias-de-resiliencia-e-confiabilidade">4.2. Estrat√©gias de Resili√™ncia e Confiabilidade</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#circuit-breaker-pattern">4.2.1. Circuit Breaker Pattern</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bulk-operations-e-otimizacao-de-performance">4.2.2. Bulk Operations e Otimiza√ß√£o de Performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#caching-strategies-avancadas">4.2.3. Caching Strategies Avan√ßadas</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#otimizacao-de-performance-e-scalability">4.3. Otimiza√ß√£o de Performance e Scalability</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-optimization-patterns">4.3.1. Database Optimization Patterns</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sintese-e-perspectivas-futuras">5. S√≠ntese e Perspectivas Futuras</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recapitulacao-e-consolidacao-de-conhecimentos">5.1. Recapitula√ß√£o e Consolida√ß√£o de Conhecimentos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jornada-de-aprendizado-percorrida">5.1.1. Jornada de Aprendizado Percorrida</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#competencias-desenvolvidas">5.1.2. Compet√™ncias Desenvolvidas</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tendencias-e-tecnologias-emergentes">5.2. Tend√™ncias e Tecnologias Emergentes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphql-vs-rest-evolucao-ou-substituicao">5.2.1. GraphQL vs REST: Evolu√ß√£o ou Substitui√ß√£o?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#arquiteturas-serverless-e-edge-computing">5.2.2. Arquiteturas Serverless e Edge Computing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ai-ml-integration-em-apis">5.2.3. AI/ML Integration em APIs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#integracao-com-ecossistemas-modernos">5.3. Integra√ß√£o com Ecossistemas Modernos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#microservices-e-service-mesh">5.3.1. Microservices e Service Mesh</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cloud-native-e-kubernetes">5.3.2. Cloud Native e Kubernetes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#oportunidades-de-carreira-e-mercado">5.4. Oportunidades de Carreira e Mercado</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#panorama-do-mercado-de-apis">5.4.1. Panorama do Mercado de APIs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacao-para-o-mercado-de-trabalho">5.4.2. Prepara√ß√£o para o Mercado de Trabalho</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reflexoes-finais-e-proximos-passos">5.5. Reflex√µes Finais e Pr√≥ximos Passos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sintese-da-jornada-de-aprendizado">5.5.1. S√≠ntese da Jornada de Aprendizado</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mapa-mental">5.5.2. Mapa Mental</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#impacto-transformador-das-apis">5.5.3. Impacto Transformador das APIs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#chamada-para-acao">5.5.4. Chamada para A√ß√£o</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#referencias-e-leituras-adicionais">Refer√™ncias e Leituras Adicionais</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="construcao-e-consumo-de-apis-rest">
<h1>Constru√ß√£o e Consumo de APIs REST<a class="headerlink" href="#construcao-e-consumo-de-apis-rest" title="Link to this heading">#</a></h1>
<section id="sumario">
<h2>Sum√°rio<a class="headerlink" href="#sumario" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#constru%C3%A7%C3%A3o-e-consumo-de-apis-rest"><span class="xref myst">Constru√ß√£o e Consumo de APIs REST</span></a></p>
<ul>
<li><p><a class="reference internal" href="#sum%C3%A1rio"><span class="xref myst">Sum√°rio</span></a></p></li>
<li><p><a class="reference internal" href="#1-abertura-e-engajamento"><span class="xref myst">1. Abertura e Engajamento</span></a></p>
<ul>
<li><p><a class="reference internal" href="#11-problema-motivador"><span class="xref myst">1.1. Problema Motivador</span></a></p></li>
<li><p><a class="reference internal" href="#12-contexto-hist%C3%B3rico-e-relev%C3%A2ncia-atual"><span class="xref myst">1.2. Contexto Hist√≥rico e Relev√¢ncia Atual</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#2-fundamentos-te%C3%B3ricos"><span class="xref myst">2. Fundamentos Te√≥ricos</span></a></p>
<ul>
<li><p><a class="reference internal" href="#21-defini%C3%A7%C3%A3o-e-princ%C3%ADpios-de-apis-rest"><span class="xref myst">2.1. Defini√ß√£o e Princ√≠pios de APIs REST</span></a></p>
<ul>
<li><p><a class="reference internal" href="#211-terminologia-essencial-e-defini%C3%A7%C3%B5es-formais"><span class="xref myst">2.1.1. Terminologia Essencial e Defini√ß√µes Formais</span></a></p></li>
<li><p><a class="reference internal" href="#212-estrutura-conceitual-dos-princ%C3%ADpios-rest"><span class="xref myst">2.1.2. Estrutura Conceitual dos Princ√≠pios REST</span></a></p></li>
<li><p><a class="reference internal" href="#213-an%C3%A1lise-de-consequ%C3%AAncias-e-trade-offs"><span class="xref myst">2.1.3. An√°lise de Consequ√™ncias e Trade-offs</span></a></p></li>
<li><p><a class="reference internal" href="#214-an%C3%A1lise-cr%C3%ADtica-e-faq"><span class="xref myst">2.1.4. An√°lise Cr√≠tica e FAQ</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#22-fastapi-arquitetura-e-ecossistema"><span class="xref myst">2.2. FastAPI: Arquitetura e Ecossistema</span></a></p>
<ul>
<li><p><a class="reference internal" href="#221-terminologia-essencial-e-defini%C3%A7%C3%B5es-formais"><span class="xref myst">2.2.1. Terminologia Essencial e Defini√ß√µes Formais</span></a></p></li>
<li><p><a class="reference internal" href="#222-estrutura-conceitual-do-fastapi"><span class="xref myst">2.2.2. Estrutura Conceitual do FastAPI</span></a></p></li>
<li><p><a class="reference internal" href="#223-an%C3%A1lise-de-consequ%C3%AAncias-e-trade-offs"><span class="xref myst">2.2.3. An√°lise de Consequ√™ncias e Trade-offs</span></a></p></li>
<li><p><a class="reference internal" href="#224-an%C3%A1lise-cr%C3%ADtica-e-faq"><span class="xref myst">2.2.4. An√°lise Cr√≠tica e FAQ</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#23-pydantic-para-valida%C3%A7%C3%A3o-de-dados"><span class="xref myst">2.3. Pydantic para Valida√ß√£o de Dados</span></a></p>
<ul>
<li><p><a class="reference internal" href="#231-terminologia-essencial-e-defini%C3%A7%C3%B5es-formais"><span class="xref myst">2.3.1. Terminologia Essencial e Defini√ß√µes Formais</span></a></p></li>
<li><p><a class="reference internal" href="#232-estrutura-conceitual-da-valida%C3%A7%C3%A3o"><span class="xref myst">2.3.2. Estrutura Conceitual da Valida√ß√£o</span></a></p></li>
<li><p><a class="reference internal" href="#233-an%C3%A1lise-de-consequ%C3%AAncias-e-trade-offs"><span class="xref myst">2.3.3. An√°lise de Consequ√™ncias e Trade-offs</span></a></p></li>
<li><p><a class="reference internal" href="#234-an%C3%A1lise-cr%C3%ADtica-e-faq"><span class="xref myst">2.3.4. An√°lise Cr√≠tica e FAQ</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#24-tratamento-de-erros-e-consumo-de-apis-externas"><span class="xref myst">2.4. Tratamento de Erros e Consumo de APIs Externas</span></a></p>
<ul>
<li><p><a class="reference internal" href="#241-terminologia-essencial-e-defini%C3%A7%C3%B5es-formais"><span class="xref myst">2.4.1. Terminologia Essencial e Defini√ß√µes Formais</span></a></p></li>
<li><p><a class="reference internal" href="#242-estrutura-conceitual-do-tratamento-de-erros"><span class="xref myst">2.4.2. Estrutura Conceitual do Tratamento de Erros</span></a></p></li>
<li><p><a class="reference internal" href="#243-an%C3%A1lise-de-consequ%C3%AAncias-e-trade-offs"><span class="xref myst">2.4.3. An√°lise de Consequ√™ncias e Trade-offs</span></a></p></li>
<li><p><a class="reference internal" href="#244-an%C3%A1lise-cr%C3%ADtica-e-faq"><span class="xref myst">2.4.4. An√°lise Cr√≠tica e FAQ</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#3-aplica%C3%A7%C3%A3o-pr%C3%A1tica-e-implementa%C3%A7%C3%A3o"><span class="xref myst">3. Aplica√ß√£o Pr√°tica e Implementa√ß√£o</span></a></p>
<ul>
<li><p><a class="reference internal" href="#31-estudo-de-caso-guiado"><span class="xref myst">3.1. Estudo de Caso Guiado</span></a></p>
<ul>
<li><p><a class="reference internal" href="#passo-1-configura%C3%A7%C3%A3o-do-ambiente-e-estrutura-do-projeto"><span class="xref myst">Passo 1: Configura√ß√£o do Ambiente e Estrutura do Projeto</span></a></p></li>
<li><p><a class="reference internal" href="#passo-2-definindo-modelos-de-dados-com-pydantic"><span class="xref myst">Passo 2: Definindo Modelos de Dados com Pydantic</span></a></p></li>
<li><p><a class="reference internal" href="#passo-3-criando-rotas-restful-com-fastapi"><span class="xref myst">Passo 3: Criando Rotas RESTful com FastAPI</span></a></p></li>
<li><p><a class="reference internal" href="#passo-4-implementando-consumo-de-apis-externas"><span class="xref myst">Passo 4: Implementando Consumo de APIs Externas</span></a></p></li>
<li><p><a class="reference internal" href="#passo-5-implementando-sistema-de-cache"><span class="xref myst">Passo 5: Implementando Sistema de Cache</span></a></p></li>
<li><p><a class="reference internal" href="#passo-6-configura%C3%A7%C3%A3o-da-aplica%C3%A7%C3%A3o-principal"><span class="xref myst">Passo 6: Configura√ß√£o da Aplica√ß√£o Principal</span></a></p></li>
<li><p><a class="reference internal" href="#passo-7-testes-automatizados"><span class="xref myst">Passo 7: Testes Automatizados</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#32-exemplos-de-c%C3%B3digo-comentado"><span class="xref myst">3.2. Exemplos de C√≥digo Comentado</span></a></p></li>
<li><p><a class="reference internal" href="#33-ferramentas-bibliotecas-e-ecossistema"><span class="xref myst">3.3. Ferramentas, Bibliotecas e Ecossistema</span></a></p>
<ul>
<li><p><a class="reference internal" href="#depend%C3%AAncias-principais"><span class="xref myst">Depend√™ncias Principais</span></a></p></li>
<li><p><a class="reference internal" href="#depend%C3%AAncias-de-desenvolvimento-e-teste"><span class="xref myst">Depend√™ncias de Desenvolvimento e Teste</span></a></p></li>
<li><p><a class="reference internal" href="#depend%C3%AAncias-de-infraestrutura"><span class="xref myst">Depend√™ncias de Infraestrutura</span></a></p></li>
<li><p><a class="reference internal" href="#recursos-nativos-do-python"><span class="xref myst">Recursos Nativos do Python</span></a></p></li>
<li><p><a class="reference internal" href="#decis%C3%B5es-arquiteturais"><span class="xref myst">Decis√µes Arquiteturais</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#4-t%C3%B3picos-avan%C3%A7ados-e-nuances"><span class="xref myst">4. T√≥picos Avan√ßados e Nuances</span></a></p>
<ul>
<li><p><a class="reference internal" href="#41-autentica%C3%A7%C3%A3o-e-autoriza%C3%A7%C3%A3o"><span class="xref myst">4.1. Autentica√ß√£o e Autoriza√ß√£o</span></a></p>
<ul>
<li><p><a class="reference internal" href="#411-implementa%C3%A7%C3%A3o-de-jwt-json-web-tokens"><span class="xref myst">4.1.1. Implementa√ß√£o de JWT (JSON Web Tokens)</span></a></p></li>
<li><p><a class="reference internal" href="#412-api-keys-e-rate-limiting"><span class="xref myst">4.1.2. API Keys e Rate Limiting</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#42-estrat%C3%A9gias-de-resili%C3%AAncia-e-confiabilidade"><span class="xref myst">4.2. Estrat√©gias de Resili√™ncia e Confiabilidade</span></a></p>
<ul>
<li><p><a class="reference internal" href="#421-circuit-breaker-pattern"><span class="xref myst">4.2.1. Circuit Breaker Pattern</span></a></p></li>
<li><p><a class="reference internal" href="#422-bulk-operations-e-otimiza%C3%A7%C3%A3o-de-performance"><span class="xref myst">4.2.2. Bulk Operations e Otimiza√ß√£o de Performance</span></a></p></li>
<li><p><a class="reference internal" href="#423-caching-strategies-avan%C3%A7adas"><span class="xref myst">4.2.3. Caching Strategies Avan√ßadas</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#43-otimiza%C3%A7%C3%A3o-de-performance-e-scalability"><span class="xref myst">4.3. Otimiza√ß√£o de Performance e Scalability</span></a></p>
<ul>
<li><p><a class="reference internal" href="#431-database-optimization-patterns"><span class="xref myst">4.3.1. Database Optimization Patterns</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#5-s%C3%ADntese-e-perspectivas-futuras"><span class="xref myst">5. S√≠ntese e Perspectivas Futuras</span></a></p>
<ul>
<li><p><a class="reference internal" href="#51-recapitula%C3%A7%C3%A3o-e-consolida%C3%A7%C3%A3o-de-conhecimentos"><span class="xref myst">5.1. Recapitula√ß√£o e Consolida√ß√£o de Conhecimentos</span></a></p>
<ul>
<li><p><a class="reference internal" href="#511-jornada-de-aprendizado-percorrida"><span class="xref myst">5.1.1. Jornada de Aprendizado Percorrida</span></a></p></li>
<li><p><a class="reference internal" href="#512-compet%C3%AAncias-desenvolvidas"><span class="xref myst">5.1.2. Compet√™ncias Desenvolvidas</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#52-tend%C3%AAncias-e-tecnologias-emergentes"><span class="xref myst">5.2. Tend√™ncias e Tecnologias Emergentes</span></a></p>
<ul>
<li><p><a class="reference internal" href="#521-graphql-vs-rest-evolu%C3%A7%C3%A3o-ou-substitui%C3%A7%C3%A3o"><span class="xref myst">5.2.1. GraphQL vs REST: Evolu√ß√£o ou Substitui√ß√£o?</span></a></p></li>
<li><p><a class="reference internal" href="#522-arquiteturas-serverless-e-edge-computing"><span class="xref myst">5.2.2. Arquiteturas Serverless e Edge Computing</span></a></p></li>
<li><p><a class="reference internal" href="#523-aiml-integration-em-apis"><span class="xref myst">5.2.3. AI/ML Integration em APIs</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#53-integra%C3%A7%C3%A3o-com-ecossistemas-modernos"><span class="xref myst">5.3. Integra√ß√£o com Ecossistemas Modernos</span></a></p>
<ul>
<li><p><a class="reference internal" href="#531-microservices-e-service-mesh"><span class="xref myst">5.3.1. Microservices e Service Mesh</span></a></p></li>
<li><p><a class="reference internal" href="#532-cloud-native-e-kubernetes"><span class="xref myst">5.3.2. Cloud Native e Kubernetes</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#54-oportunidades-de-carreira-e-mercado"><span class="xref myst">5.4. Oportunidades de Carreira e Mercado</span></a></p>
<ul>
<li><p><a class="reference internal" href="#541-panorama-do-mercado-de-apis"><span class="xref myst">5.4.1. Panorama do Mercado de APIs</span></a></p></li>
<li><p><a class="reference internal" href="#542-prepara%C3%A7%C3%A3o-para-o-mercado-de-trabalho"><span class="xref myst">5.4.2. Prepara√ß√£o para o Mercado de Trabalho</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#55-reflex%C3%B5es-finais-e-pr%C3%B3ximos-passos"><span class="xref myst">5.5. Reflex√µes Finais e Pr√≥ximos Passos</span></a></p>
<ul>
<li><p><a class="reference internal" href="#551-s%C3%ADntese-da-jornada-de-aprendizado"><span class="xref myst">5.5.1. S√≠ntese da Jornada de Aprendizado</span></a></p></li>
<li><p><a class="reference internal" href="#552-mapa-mental"><span class="xref myst">5.5.2. Mapa Mental</span></a></p></li>
<li><p><a class="reference internal" href="#553-impacto-transformador-das-apis"><span class="xref myst">5.5.3. Impacto Transformador das APIs</span></a></p></li>
<li><p><a class="reference internal" href="#554-chamada-para-a%C3%A7%C3%A3o"><span class="xref myst">5.5.4. Chamada para A√ß√£o</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#refer%C3%AAncias-e-leituras-adicionais"><span class="xref myst">Refer√™ncias e Leituras Adicionais</span></a></p></li>
</ul>
</li>
</ul>
</section>
<hr class="docutils" />
<section id="abertura-e-engajamento">
<h2>1. Abertura e Engajamento<a class="headerlink" href="#abertura-e-engajamento" title="Link to this heading">#</a></h2>
<section id="problema-motivador">
<h3>1.1. Problema Motivador<a class="headerlink" href="#problema-motivador" title="Link to this heading">#</a></h3>
<p>Imagine um aplicativo de delivery que conecta restaurantes, entregadores e clientes em tempo real. Como garantir que o aplicativo m√≥vel do cliente consiga consultar o card√°pio atualizado de centenas de restaurantes? Como o sistema de pagamento pode se comunicar com o banco de forma segura? Como o sistema de rastreamento informa a localiza√ß√£o do entregador em tempo real? Como diferentes equipes de desenvolvimento podem trabalhar simultaneamente em partes distintas do sistema sem conflitos?</p>
<p>A resposta est√° nas <strong>APIs REST</strong> (Application Programming Interfaces - Representational State Transfer). Elas s√£o a ponte que permite que sistemas completamente diferentes conversem entre si de forma padronizada, confi√°vel e escal√°vel. Sem APIs bem constru√≠das, vivemos em ilhas isoladas de software - cada aplica√ß√£o seria um mundo fechado, incapaz de compartilhar dados ou funcionalidades.</p>
<p>No contexto atual de microservi√ßos, cloud computing e aplica√ß√µes distribu√≠das, dominar a constru√ß√£o e consumo de APIs REST n√£o √© apenas uma habilidade desej√°vel - √© uma necessidade fundamental para qualquer desenvolvedor que queira criar solu√ß√µes modernas e integradas. Este cap√≠tulo ir√° equip√°-lo com as ferramentas conceituais e pr√°ticas necess√°rias para projetar, implementar e consumir APIs robustas, seguras e bem documentadas.</p>
</section>
<section id="contexto-historico-e-relevancia-atual">
<h3>1.2. Contexto Hist√≥rico e Relev√¢ncia Atual<a class="headerlink" href="#contexto-historico-e-relevancia-atual" title="Link to this heading">#</a></h3>
<p>A arquitetura REST foi conceituada por <strong>Roy Fielding</strong> em sua disserta√ß√£o de doutorado em 2000, intitulada ‚ÄúArchitectural Styles and the Design of Network-based Software Architectures‚Äù, na Universidade da Calif√≥rnia, Irvine. Fielding, que tamb√©m foi um dos principais arquitetos do protocolo HTTP, estabeleceu os princ√≠pios fundamentais que definem como sistemas distribu√≠dos devem se comunicar de forma eficiente e escal√°vel.</p>
<p>Antes do REST, a integra√ß√£o entre sistemas era dominada por protocolos complexos como SOAP (Simple Object Access Protocol) e RPC (Remote Procedure Call), que exigiam configura√ß√µes elaboradas e geravam overhead significativo. A abordagem de Fielding revolucionou a √°rea ao propor um estilo arquitetural simples, baseado nos padr√µes j√° estabelecidos da web, aproveitando a infraestrutura HTTP existente.</p>
<p>A partir dos anos 2000, empresas como Amazon, Google e Twitter come√ßaram a adotar APIs REST para expor seus servi√ßos, criando ecossistemas de desenvolvimento que permitiram a explos√£o de aplica√ß√µes web e m√≥veis. A API do Twitter, lan√ßada em 2006, demonstrou o poder das APIs abertas ao possibilitar que desenvolvedores criassem milhares de aplica√ß√µes cliente diferentes, desde clientes desktop at√© an√°lises de sentimento em tempo real.</p>
<p><strong>Relev√¢ncia Massiva Atual:</strong></p>
<p>Hoje, APIs REST s√£o a espinha dorsal da economia digital. Segundo pesquisas recentes:</p>
<ul class="simple">
<li><p>Mais de 83% das transa√ß√µes de tr√°fego web envolvem APIs</p></li>
<li><p>O mercado global de APIs foi avaliado em <span class="math notranslate nohighlight">\(6,2 bilh√µes em 2023 e projeta-se crescimento para \)</span>31,1 bilh√µes at√© 2031</p></li>
<li><p>Empresas como Stripe processam bilh√µes de transa√ß√µes atrav√©s de suas APIs REST</p></li>
<li><p>Plataformas como GitHub, Slack, Shopify e Salesforce constru√≠ram ecossistemas inteiros baseados em APIs REST</p></li>
</ul>
<p>As aplica√ß√µes modernas s√£o fundamentalmente diferentes: aplica√ß√µes m√≥veis consomem APIs, sistemas de IoT enviam dados via APIs, intelig√™ncia artificial √© disponibilizada como servi√ßo atrav√©s de APIs (OpenAI, Google AI), e at√© mesmo infraestruturas de cloud computing (AWS, Azure, GCP) s√£o controladas inteiramente via APIs REST.</p>
<p>Dominar APIs REST hoje √© dominar a linguagem universal dos sistemas distribu√≠dos modernos.</p>
</section>
</section>
<hr class="docutils" />
<section id="fundamentos-teoricos">
<h2>2. Fundamentos Te√≥ricos<a class="headerlink" href="#fundamentos-teoricos" title="Link to this heading">#</a></h2>
<section id="definicao-e-principios-de-apis-rest">
<h3>2.1. Defini√ß√£o e Princ√≠pios de APIs REST<a class="headerlink" href="#definicao-e-principios-de-apis-rest" title="Link to this heading">#</a></h3>
<section id="terminologia-essencial-e-definicoes-formais">
<h4>2.1.1. Terminologia Essencial e Defini√ß√µes Formais<a class="headerlink" href="#terminologia-essencial-e-definicoes-formais" title="Link to this heading">#</a></h4>
<p><strong>API REST (Representational State Transfer API)</strong> √© um estilo arquitetural para sistemas distribu√≠dos que define um conjunto de restri√ß√µes e propriedades baseadas no protocolo HTTP. Uma API REST permite que clientes acessem e manipulem representa√ß√µes de recursos atrav√©s de opera√ß√µes padronizadas e sem estado (stateless).</p>
<p><strong>Defini√ß√£o Formal:</strong> Uma API REST √© uma interface de programa√ß√£o que adere aos princ√≠pios REST, expondo recursos atrav√©s de URIs √∫nicos e permitindo opera√ß√µes sobre esses recursos usando m√©todos HTTP padr√£o (GET, POST, PUT, DELETE), onde cada requisi√ß√£o cont√©m toda a informa√ß√£o necess√°ria para ser processada.</p>
<blockquote>
<div><p><strong>üí° Analogia para Entender</strong></p>
<p>Imagine uma biblioteca municipal gigante. Cada livro tem um endere√ßo √∫nico (estante, prateleira, posi√ß√£o) - isso √© como uma URI identificando um recurso. Voc√™ pode consultar um livro (GET), adicionar um novo livro ao acervo (POST), atualizar informa√ß√µes de um livro (PUT), ou remover um livro (DELETE). O bibliotec√°rio n√£o precisa lembrar do que voc√™ fez antes - cada pedido √© independente e cont√©m todas as informa√ß√µes necess√°rias. A biblioteca funciona com regras padronizadas que qualquer pessoa pode entender e usar.</p>
</div></blockquote>
</section>
<section id="estrutura-conceitual-dos-principios-rest">
<h4>2.1.2. Estrutura Conceitual dos Princ√≠pios REST<a class="headerlink" href="#estrutura-conceitual-dos-principios-rest" title="Link to this heading">#</a></h4>
<p>REST √© fundamentado em <strong>seis princ√≠pios arquiteturais</strong> que garantem escalabilidade, simplicidade e confiabilidade:</p>
<p><strong>1. Interface Uniforme (Uniform Interface)</strong></p>
<p>A interface entre clientes e servidores deve ser padronizada e consistente. Isso envolve:</p>
<ul class="simple">
<li><p><strong>Identifica√ß√£o de recursos</strong>: Cada recurso deve ter um identificador √∫nico (URI)</p></li>
<li><p><strong>Manipula√ß√£o atrav√©s de representa√ß√µes</strong>: Recursos s√£o manipulados enviando representa√ß√µes (JSON, XML)</p></li>
<li><p><strong>Mensagens auto-descritivas</strong>: Cada mensagem deve conter informa√ß√µes suficientes para ser compreendida</p></li>
<li><p><strong>HATEOAS (Hypermedia as the Engine of Application State)</strong>: Respostas incluem links para a√ß√µes relacionadas</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pseudoc√≥digo</span> <span class="n">da</span> <span class="n">Interface</span> <span class="n">Uniforme</span><span class="p">:</span>
<span class="n">RECURSO</span> <span class="n">identificado</span> <span class="n">por</span> <span class="n">URI</span> <span class="n">√∫nica</span>
<span class="n">OPERA√á√ÉO</span> <span class="n">definida</span> <span class="n">por</span> <span class="n">HTTP</span> <span class="n">method</span>
<span class="n">REPRESENTA√á√ÉO</span> <span class="n">em</span> <span class="n">formato</span> <span class="n">padronizado</span> <span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
<span class="n">RESPOSTA</span> <span class="n">auto</span><span class="o">-</span><span class="n">descritiva</span> <span class="n">com</span> <span class="n">status</span> <span class="n">code</span>
</pre></div>
</div>
<p><strong>2. Stateless (Sem Estado)</strong></p>
<p>Cada requisi√ß√£o do cliente deve conter toda a informa√ß√£o necess√°ria para ser processada. O servidor n√£o armazena contexto do cliente entre requisi√ß√µes.</p>
<pre  class="mermaid">
        graph LR
    A[Cliente] --&gt;|Requisi√ß√£o Completa| B[Servidor]
    B --&gt;|Resposta| A
    C[Pr√≥xima Requisi√ß√£o] --&gt;|Informa√ß√£o Completa| B
    B --&gt;|Resposta| C
    
    note1[Servidor n√£o mant√©m estado]
    note2[Cada requisi√ß√£o √© independente]
    </pre><p><strong>3. Cache√°vel (Cacheable)</strong></p>
<p>Respostas devem ser impl√≠cita ou explicitamente rotuladas como cache√°veis ou n√£o-cache√°veis para melhorar performance e escalabilidade.</p>
<p><strong>4. Sistema em Camadas (Layered System)</strong></p>
<p>A arquitetura pode ser composta por camadas hier√°rquicas, onde cada componente s√≥ conhece a camada imediatamente adjacente.</p>
<pre  class="mermaid">
        graph TD
    A[Cliente] --&gt; B[Load Balancer]
    B --&gt; C[API Gateway]
    C --&gt; D[Servidor de Aplica√ß√£o]
    D --&gt; E[Banco de Dados]
    
    F[Cache Layer] -.-&gt; C
    G[Authentication Layer] -.-&gt; C
    </pre><p><strong>5. C√≥digo sob Demanda (Code on Demand) - Opcional</strong></p>
<p>Servidores podem estender temporariamente a funcionalidade do cliente enviando c√≥digo execut√°vel (JavaScript, applets).</p>
<p><strong>6. Cliente-Servidor (Client-Server)</strong></p>
<p>Separa√ß√£o clara de responsabilidades: clientes gerenciam interface de usu√°rio, servidores gerenciam dados e l√≥gica de neg√≥cio.</p>
</section>
<section id="analise-de-consequencias-e-trade-offs">
<h4>2.1.3. An√°lise de Consequ√™ncias e Trade-offs<a class="headerlink" href="#analise-de-consequencias-e-trade-offs" title="Link to this heading">#</a></h4>
<p><strong>Vantagens dos Princ√≠pios REST:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Princ√≠pio</p></th>
<th class="head"><p>Vantagens</p></th>
<th class="head"><p>Impactos Positivos</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Interface Uniforme</strong></p></td>
<td><p>Simplicidade, interoperabilidade</p></td>
<td><p>Facilita integra√ß√£o, reduz curva de aprendizado</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Stateless</strong></p></td>
<td><p>Escalabilidade, confiabilidade</p></td>
<td><p>Permite horizontal scaling, facilita debugging</p></td>
</tr>
<tr class="row-even"><td><p><strong>Cache√°vel</strong></p></td>
<td><p>Performance, redu√ß√£o de carga</p></td>
<td><p>Melhora tempo de resposta, economiza recursos</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Sistema em Camadas</strong></p></td>
<td><p>Flexibilidade, modularidade</p></td>
<td><p>Facilita manuten√ß√£o, permite evolu√ß√£o independente</p></td>
</tr>
<tr class="row-even"><td><p><strong>Cliente-Servidor</strong></p></td>
<td><p>Portabilidade, evolu√ß√£o independente</p></td>
<td><p>Desenvolvimento paralelo, reutiliza√ß√£o</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Desvantagens e Limita√ß√µes:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Limita√ß√£o</p></th>
<th class="head"><p>Cen√°rio Problem√°tico</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Stateless</strong></p></td>
<td><p>Overhead de dados repetidos</p></td>
<td><p>Aplica√ß√µes com sess√µes complexas</p></td>
</tr>
<tr class="row-odd"><td><p><strong>HTTP Overhead</strong></p></td>
<td><p>Verbosity do protocolo</p></td>
<td><p>Aplica√ß√µes real-time cr√≠ticas</p></td>
</tr>
<tr class="row-even"><td><p><strong>Granularidade</strong></p></td>
<td><p>Dificuldade com opera√ß√µes complexas</p></td>
<td><p>Transa√ß√µes que envolvem m√∫ltiplos recursos</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Caching Complexo</strong></p></td>
<td><p>Invalida√ß√£o de cache</p></td>
<td><p>Dados frequentemente alterados</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="analise-critica-e-faq">
<h4>2.1.4. An√°lise Cr√≠tica e FAQ<a class="headerlink" href="#analise-critica-e-faq" title="Link to this heading">#</a></h4>
<p><strong>Limita√ß√µes Arquiteturais:</strong></p>
<ol class="arabic simple">
<li><p><strong>Overhead de Rede</strong>: REST pode ser ineficiente para opera√ß√µes que envolvem m√∫ltiplos recursos relacionados</p></li>
<li><p><strong>Granularidade</strong>: Nem sempre √© natural mapear opera√ß√µes de neg√≥cio complexas para opera√ß√µes CRUD simples</p></li>
<li><p><strong>Consist√™ncia Eventual</strong>: Em sistemas distribu√≠dos, pode haver inconsist√™ncias tempor√°rias entre recursos</p></li>
</ol>
<p><strong>FAQ: Perguntas Frequentes sobre REST</strong></p>
<p><strong>Q: Quando REST n√£o √© a melhor escolha?</strong>
A: Para aplica√ß√µes real-time (use WebSockets), opera√ß√µes complexas que n√£o mapeiam bem para CRUD (use GraphQL ou RPC), ou quando performance extrema √© cr√≠tica (use gRPC).</p>
<p><strong>Q: Como implementar transa√ß√µes em REST?</strong>
A: REST n√£o suporta transa√ß√µes nativas. Use padr√µes como Saga Pattern, Compensating Actions, ou APIs de transa√ß√£o espec√≠ficas.</p>
<p><strong>Q: REST APIs devem sempre retornar JSON?</strong>
A: N√£o necessariamente. REST √© agn√≥stico ao formato - pode usar JSON, XML, HTML, ou qualquer formato apropriado. JSON tornou-se padr√£o por sua simplicidade e suporte universal.</p>
<p><strong>Q: Como versionar APIs REST?</strong>
A: Principais abordagens: versionamento na URL (/v1/users), headers (Accept: application/vnd.api+json;version=1), ou query parameters (?version=1). Cada abordagem tem trade-offs espec√≠ficos.</p>
</section>
</section>
<section id="fastapi-arquitetura-e-ecossistema">
<h3>2.2. FastAPI: Arquitetura e Ecossistema<a class="headerlink" href="#fastapi-arquitetura-e-ecossistema" title="Link to this heading">#</a></h3>
<section id="id1">
<h4>2.2.1. Terminologia Essencial e Defini√ß√µes Formais<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p><strong>FastAPI</strong> √© um framework web moderno e de alta performance para constru√ß√£o de APIs REST em Python, baseado em padr√µes abertos como OpenAPI e JSON Schema. Desenvolvido por Sebasti√°n Ram√≠rez em 2018, FastAPI combina simplicidade de desenvolvimento com performance pr√≥xima a Node.js e Go.</p>
<p><strong>Defini√ß√£o Formal:</strong> FastAPI √© um framework ass√≠ncrono que utiliza type hints do Python para automatizar valida√ß√£o de dados, serializa√ß√£o, documenta√ß√£o e gera√ß√£o de esquemas OpenAPI, proporcionando desenvolvimento r√°pido com valida√ß√£o autom√°tica e documenta√ß√£o interativa.</p>
<p><strong>Caracter√≠sticas Distintivas:</strong></p>
<ul class="simple">
<li><p><strong>Type Hints Nativo</strong>: Utiliza annotations do Python 3.6+ para definir tipos</p></li>
<li><p><strong>Ass√≠ncrono por Padr√£o</strong>: Suporte nativo para async/await</p></li>
<li><p><strong>Auto-documenta√ß√£o</strong>: Gera documenta√ß√£o Swagger/OpenAPI automaticamente</p></li>
<li><p><strong>Valida√ß√£o Autom√°tica</strong>: Integra√ß√£o nativa com Pydantic para valida√ß√£o</p></li>
<li><p><strong>Performance</strong>: Baseado em Starlette (framework ass√≠ncrono) e Uvicorn (servidor ASGI)</p></li>
</ul>
<blockquote>
<div><p><strong>üí° Analogia para Entender</strong></p>
<p>FastAPI √© como um assistente pessoal altamente inteligente para constru√ß√£o de APIs. Imagine que voc√™ tem um assistente que, quando voc√™ fala ‚Äúpreciso de uma fun√ß√£o que recebe nome e idade‚Äù, automaticamente cria n√£o apenas a fun√ß√£o, mas tamb√©m: verifica se nome √© texto e idade √© n√∫mero, gera documenta√ß√£o explicando como usar, cria exemplos de teste, e at√© mesmo constr√≥i uma interface visual para testar. Tudo isso apenas observando como voc√™ escreve seu c√≥digo Python normal.</p>
</div></blockquote>
</section>
<section id="estrutura-conceitual-do-fastapi">
<h4>2.2.2. Estrutura Conceitual do FastAPI<a class="headerlink" href="#estrutura-conceitual-do-fastapi" title="Link to this heading">#</a></h4>
<p><strong>1. Arquitetura em Camadas</strong></p>
<pre  class="mermaid">
        graph TD
    A[Cliente HTTP] --&gt; B[Uvicorn - Servidor ASGI]
    B --&gt; C[Starlette - Framework Base]
    C --&gt; D[FastAPI - Layer de Alto N√≠vel]
    D --&gt; E[Pydantic - Valida√ß√£o]
    D --&gt; F[OpenAPI - Documenta√ß√£o]
    D --&gt; G[Dependency Injection - Inje√ß√£o de Depend√™ncias]
    
    H[Type Hints] -.-&gt; E
    H -.-&gt; F
    I[Async/Await] -.-&gt; C
    </pre><p><strong>2. Componentes Fundamentais</strong></p>
<p><strong>Path Operations (Opera√ß√µes de Rota):</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conceito: Decorador que mapeia HTTP method + path para fun√ß√£o Python</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># GET + path pattern</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>  <span class="c1"># fun√ß√£o ass√≠ncrona com type hint</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</pre></div>
</div>
<p><strong>Dependency Injection System:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conceito: Sistema que automaticamente injeta depend√™ncias</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_database</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Database</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_users</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">Database</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">get_users</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Automatic Request/Response Models:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conceito: Modelos Pydantic automaticamente validam e serializam dados</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">):</span>  <span class="c1"># Valida√ß√£o autom√°tica</span>
    <span class="k">return</span> <span class="n">user</span>  <span class="c1"># Serializa√ß√£o autom√°tica</span>
</pre></div>
</div>
<p><strong>3. Fluxo de Processamento de Requisi√ß√£o</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. REQUEST RECEPTION
   Cliente ‚Üí Uvicorn ‚Üí Starlette
   
2. ROUTING
   Starlette identifica path operation correspondente
   
3. DEPENDENCY RESOLUTION
   FastAPI resolve depend√™ncias (database, auth, etc.)
   
4. VALIDATION
   Pydantic valida dados de entrada conforme type hints
   
5. EXECUTION
   Fun√ß√£o de endpoint √© executada (async ou sync)
   
6. SERIALIZATION
   Pydantic serializa resposta para JSON
   
7. RESPONSE
   Starlette ‚Üí Uvicorn ‚Üí Cliente
</pre></div>
</div>
<p><strong>4. Sistema de Type Hints e Valida√ß√£o</strong></p>
<p>FastAPI revoluciona desenvolvimento Python ao tornar type hints funcionais:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[\w\.-]+@[\w\.-]+\.\w+$&#39;</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># FastAPI automaticamente:</span>
<span class="c1"># 1. Valida que &#39;name&#39; tem 1-100 caracteres</span>
<span class="c1"># 2. Verifica regex do email</span>
<span class="c1"># 3. Gera schema OpenAPI</span>
<span class="c1"># 4. Cria documenta√ß√£o interativa</span>
<span class="c1"># 5. Serializa datetime para ISO format</span>
</pre></div>
</div>
</section>
<section id="id2">
<h4>2.2.3. An√°lise de Consequ√™ncias e Trade-offs<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p><strong>Vantagens do FastAPI:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Benef√≠cio</p></th>
<th class="head"><p>Impacto Pr√°tico</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Type Safety</strong></p></td>
<td><p>Detec√ß√£o de erros em tempo de desenvolvimento</p></td>
<td><p>Reduz bugs, melhora IDE support</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Auto-documenta√ß√£o</strong></p></td>
<td><p>Swagger/ReDoc gerado automaticamente</p></td>
<td><p>Economia de tempo, documenta√ß√£o sempre atualizada</p></td>
</tr>
<tr class="row-even"><td><p><strong>Performance</strong></p></td>
<td><p>Compar√°vel a Node.js/Go</p></td>
<td><p>Suporta alta concorr√™ncia</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Developer Experience</strong></p></td>
<td><p>Syntax limpa, menos boilerplate</p></td>
<td><p>Desenvolvimento mais r√°pido</p></td>
</tr>
<tr class="row-even"><td><p><strong>Standards Compliance</strong></p></td>
<td><p>OpenAPI, JSON Schema</p></td>
<td><p>Interoperabilidade, tooling ecosystem</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Limita√ß√µes e Trade-offs:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Limita√ß√£o</p></th>
<th class="head"><p>Contexto</p></th>
<th class="head"><p>Alternativa</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Learning Curve</strong></p></td>
<td><p>Type hints avan√ßados podem confundir iniciantes</p></td>
<td><p>Flask para projetos simples</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Ecosystem Maturity</strong></p></td>
<td><p>Menos plugins que Django/Flask</p></td>
<td><p>Avalia√ß√£o caso a caso</p></td>
</tr>
<tr class="row-even"><td><p><strong>Memory Usage</strong></p></td>
<td><p>Overhead do Pydantic</p></td>
<td><p>Considerar performance cr√≠tica</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Debugging Complexity</strong></p></td>
<td><p>Stack traces podem ser complexas em async</p></td>
<td><p>Logging estruturado</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Quando Usar FastAPI vs Alternativas:</strong></p>
<pre  class="mermaid">
        graph TD
    A[Projeto API?] --&gt; B{Tamanho/Complexidade?}
    B --&gt;|Simples/R√°pido| C[Flask]
    B --&gt;|M√©dio/Grande| D{Performance Cr√≠tica?}
    D --&gt;|Sim| E[FastAPI]
    D --&gt;|N√£o| F{Full Stack?}
    F --&gt;|Sim| G[Django]
    F --&gt;|N√£o| E
    
    H[Microservi√ßos] --&gt; E
    I[Documenta√ß√£o Autom√°tica Necess√°ria] --&gt; E
    J[Type Safety Importante] --&gt; E
    </pre></section>
<section id="id3">
<h4>2.2.4. An√°lise Cr√≠tica e FAQ<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p><strong>Pontos de Aten√ß√£o:</strong></p>
<ol class="arabic simple">
<li><p><strong>Complexity Creep</strong>: Type hints complexos podem tornar c√≥digo dif√≠cil de ler</p></li>
<li><p><strong>Async Programming</strong>: Requer entendimento s√≥lido de programa√ß√£o ass√≠ncrona</p></li>
<li><p><strong>Debugging</strong>: Stack traces em c√≥digo ass√≠ncrono podem ser mais dif√≠ceis de interpretar</p></li>
<li><p><strong>Version Compatibility</strong>: Depend√™ncia de Python 3.6+ pode ser limitante em ambientes legados</p></li>
</ol>
<p><strong>FAQ: FastAPI</strong></p>
<p><strong>Q: FastAPI √© apenas para APIs ou pode servir HTML?</strong>
A: Embora otimizado para APIs, FastAPI pode servir templates HTML usando Jinja2 e arquivos est√°ticos, mas n√£o √© sua for√ßa principal.</p>
<p><strong>Q: Como FastAPI compara com Django REST Framework?</strong>
A: FastAPI √© mais r√°pido e tem documenta√ß√£o autom√°tica, mas Django tem ecossistema mais maduro. Use FastAPI para APIs puras, Django para aplica√ß√µes full-stack complexas.</p>
<p><strong>Q: Async √© obrigat√≥rio no FastAPI?</strong>
A: N√£o. Fun√ß√µes s√≠ncronas tamb√©m funcionam, mas fun√ß√µes async aproveitam melhor a performance do framework.</p>
<p><strong>Q: Como fazer deploy de aplica√ß√µes FastAPI?</strong>
A: Use Uvicorn para desenvolvimento, Gunicorn+Uvicorn para produ√ß√£o, ou containers Docker com imagens baseadas em python:alpine.</p>
</section>
</section>
<section id="pydantic-para-validacao-de-dados">
<h3>2.3. Pydantic para Valida√ß√£o de Dados<a class="headerlink" href="#pydantic-para-validacao-de-dados" title="Link to this heading">#</a></h3>
<section id="id4">
<h4>2.3.1. Terminologia Essencial e Defini√ß√µes Formais<a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p><strong>Pydantic</strong> √© uma biblioteca Python que utiliza type hints para valida√ß√£o de dados e parsing, garantindo que dados de entrada correspondam aos tipos e restri√ß√µes especificados. Desenvolvida por Samuel Colvin, √© a base do sistema de valida√ß√£o do FastAPI.</p>
<p><strong>Defini√ß√£o Formal:</strong> Pydantic √© um sistema de valida√ß√£o e serializa√ß√£o de dados que converte dados de entrada (JSON, dicion√°rios, etc.) em objetos Python tipados, aplicando valida√ß√µes autom√°ticas baseadas em type annotations e regras customizadas, garantindo integridade e consist√™ncia dos dados.</p>
<p><strong>Conceitos Fundamentais:</strong></p>
<ul class="simple">
<li><p><strong>BaseModel</strong>: Classe base para cria√ß√£o de modelos de dados</p></li>
<li><p><strong>Field</strong>: Defini√ß√£o de restri√ß√µes e metadados para campos</p></li>
<li><p><strong>Validators</strong>: Fun√ß√µes customizadas para valida√ß√µes complexas</p></li>
<li><p><strong>Parsing</strong>: Convers√£o autom√°tica de tipos</p></li>
<li><p><strong>Serialization</strong>: Convers√£o de objetos Python para dicion√°rios/JSON</p></li>
</ul>
<blockquote>
<div><p><strong>üí° Analogia para Entender</strong></p>
<p>Pydantic √© como um inspetor de qualidade rigoroso em uma f√°brica. Imagine uma linha de produ√ß√£o onde chegam pe√ßas de diferentes fornecedores (dados JSON de diferentes clientes). O inspetor (Pydantic) verifica cada pe√ßa: tem o tamanho certo? Material correto? Especifica√ß√µes atendidas? Se algo est√° errado, ele rejeita imediatamente e diz exatamente qual o problema. Se est√° tudo certo, ele aprova e organiza a pe√ßa no lugar adequado da linha de montagem (objeto Python tipado).</p>
</div></blockquote>
</section>
<section id="estrutura-conceitual-da-validacao">
<h4>2.3.2. Estrutura Conceitual da Valida√ß√£o<a class="headerlink" href="#estrutura-conceitual-da-validacao" title="Link to this heading">#</a></h4>
<p><strong>1. Hierarquia de Valida√ß√£o</strong></p>
<pre  class="mermaid">
        graph TD
    A[Raw Data - JSON/Dict] --&gt; B[Type Coercion]
    B --&gt; C[Field Validation]
    C --&gt; D[Model Validation]
    D --&gt; E[Root Validation]
    E --&gt; F[Python Object]
    
    G[Validation Error] -.-&gt; C
    G -.-&gt; D
    G -.-&gt; E
    
    H[Custom Validators] -.-&gt; C
    H -.-&gt; D
    </pre><p><strong>2. Tipos de Valida√ß√£o por Camada</strong></p>
<p><strong>Type Coercion (Coer√ß√£o de Tipos):</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Event</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Coer√ß√£o autom√°tica: string ‚Üí int</span>
    <span class="n">event_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># Coer√ß√£o autom√°tica: string ISO ‚Üí datetime</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="c1"># Valida√ß√£o opcional</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Input: {&quot;event_id&quot;: &quot;123&quot;, &quot;timestamp&quot;: &quot;2024-01-15T10:30:00&quot;}</span>
<span class="c1"># Output: Event(event_id=123, timestamp=datetime(...), description=None)</span>
</pre></div>
</div>
<p><strong>Field-Level Validation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Valida√ß√£o de comprimento e pattern</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_]+$&#39;</span><span class="p">)</span>
    <span class="c1"># Valida√ß√£o de range</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>  <span class="c1"># greater equal, less equal</span>
    <span class="c1"># Valida√ß√£o de email</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;^[\w\.-]+@[\w\.-]+\.\w+$&#39;</span><span class="p">)</span>
    
    <span class="c1"># Validator customizado</span>
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">username_must_not_be_admin</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;administrator&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Username cannot be a reserved word&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
<p><strong>Model-Level Validation:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UserRegistration</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">confirm_password</span><span class="p">:</span> <span class="nb">str</span>
    
    <span class="c1"># Valida√ß√£o que envolve m√∫ltiplos campos</span>
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">passwords_match</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Passwords do not match&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
<p><strong>3. Sistema de Serializa√ß√£o e Deserializa√ß√£o</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Conceito: Transforma√ß√£o bidirecional entre formatos</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">in_stock</span><span class="p">:</span> <span class="nb">bool</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="c1"># Configura√ß√µes de serializa√ß√£o</span>
        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">float</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Arredondar pre√ßos</span>
        <span class="p">}</span>

<span class="c1"># Deserializa√ß√£o (JSON ‚Üí Object)</span>
<span class="n">json_data</span> <span class="o">=</span> <span class="s1">&#39;{&quot;name&quot;: &quot;Laptop&quot;, &quot;price&quot;: 999.99, &quot;in_stock&quot;: true}&#39;</span>
<span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">parse_raw</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

<span class="c1"># Serializa√ß√£o (Object ‚Üí Dict/JSON)</span>
<span class="n">product_dict</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<span class="n">product_json</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>4. Fluxo de Processamento de Dados</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INPUT DATA (JSON/Dict/Form)
‚Üì
1. PREPROCESSING
   - Remove campos extras (se strict=True)
   - Aplica alias de campos
‚Üì
2. TYPE COERCION
   - String ‚Üí Int, Float, Bool, DateTime
   - Convers√µes seguras e validadas
‚Üì
3. FIELD VALIDATION
   - Constraints (min, max, regex)
   - Custom field validators
‚Üì
4. MODEL VALIDATION
   - Root validators
   - Cross-field validation
‚Üì
5. OBJECT CREATION
   - Inst√¢ncia Python tipada
   - Acesso via atributos (dot notation)
‚Üì
OUTPUT: Validated Python Object
</pre></div>
</div>
</section>
<section id="id5">
<h4>2.3.3. An√°lise de Consequ√™ncias e Trade-offs<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<p><strong>Benef√≠cios da Valida√ß√£o Pydantic:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Benef√≠cio</p></th>
<th class="head"><p>Impacto no Desenvolvimento</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Type Safety</strong></p></td>
<td><p>Erros detectados em runtime</p></td>
<td><p>Menos bugs em produ√ß√£o</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Automatic Coercion</strong></p></td>
<td><p>Convers√£o inteligente de tipos</p></td>
<td><p>Menos c√≥digo de parsing manual</p></td>
</tr>
<tr class="row-even"><td><p><strong>Clear Error Messages</strong></p></td>
<td><p>Mensagens descritivas de erro</p></td>
<td><p>Debugging mais r√°pido</p></td>
</tr>
<tr class="row-odd"><td><p><strong>JSON Schema Generation</strong></p></td>
<td><p>Schema autom√°tico para documenta√ß√£o</p></td>
<td><p>API documentation gratuita</p></td>
</tr>
<tr class="row-even"><td><p><strong>IDE Support</strong></p></td>
<td><p>Autocomplete e type checking</p></td>
<td><p>Produtividade aumentada</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Custos e Limita√ß√µes:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Limita√ß√£o</p></th>
<th class="head"><p>Contexto</p></th>
<th class="head"><p>Mitiga√ß√£o</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Performance Overhead</strong></p></td>
<td><p>Valida√ß√£o adiciona lat√™ncia</p></td>
<td><p>Cache de modelos, otimiza√ß√£o de validators</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Memory Usage</strong></p></td>
<td><p>Objetos Pydantic consomem mais mem√≥ria</p></td>
<td><p>Usar dataclasses para casos simples</p></td>
</tr>
<tr class="row-even"><td><p><strong>Learning Curve</strong></p></td>
<td><p>Validators complexos exigem pr√°tica</p></td>
<td><p>Come√ßar com valida√ß√µes simples</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Strict Validation</strong></p></td>
<td><p>Pode ser restritivo demais</p></td>
<td><p>Configurar adequadamente parsing</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Compara√ß√£o com Alternativas:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Pydantic</p></th>
<th class="head"><p>Marshmallow</p></th>
<th class="head"><p>Cerberus</p></th>
<th class="head"><p>Manual Validation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Type Hints</strong></p></td>
<td><p>‚úÖ Nativo</p></td>
<td><p>‚ùå Separado</p></td>
<td><p>‚ùå Schema dict</p></td>
<td><p>‚ùå Manual</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Performance</strong></p></td>
<td><p>‚úÖ R√°pido</p></td>
<td><p>‚ö†Ô∏è M√©dio</p></td>
<td><p>‚ö†Ô∏è M√©dio</p></td>
<td><p>‚úÖ R√°pido</p></td>
</tr>
<tr class="row-even"><td><p><strong>Error Messages</strong></p></td>
<td><p>‚úÖ Claras</p></td>
<td><p>‚úÖ Boas</p></td>
<td><p>‚ö†Ô∏è B√°sicas</p></td>
<td><p>‚ùå Customizadas</p></td>
</tr>
<tr class="row-odd"><td><p><strong>JSON Schema</strong></p></td>
<td><p>‚úÖ Autom√°tico</p></td>
<td><p>‚ö†Ô∏è Plugin</p></td>
<td><p>‚ùå Manual</p></td>
<td><p>‚ùå Manual</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id6">
<h4>2.3.4. An√°lise Cr√≠tica e FAQ<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<p><strong>Armadilhas Comuns:</strong></p>
<ol class="arabic simple">
<li><p><strong>Over-validation</strong>: Validar dados que j√° foram validados anteriormente</p></li>
<li><p><strong>Complex Validators</strong>: Validators muito complexos que dificultam debugging</p></li>
<li><p><strong>Circular Dependencies</strong>: Modelos que se referenciam mutuamente</p></li>
<li><p><strong>Performance</strong>: N√£o considerar overhead em aplica√ß√µes de alta frequ√™ncia</p></li>
</ol>
<p><strong>FAQ: Pydantic</strong></p>
<p><strong>Q: Pydantic √© apenas para APIs ou tem outros usos?</strong>
A: Pydantic √© √∫til para qualquer parsing/valida√ß√£o de dados: arquivos de configura√ß√£o, ETL de dados, valida√ß√£o de formul√°rios, parsing de logs estruturados.</p>
<p><strong>Q: Como lidar com dados aninhados complexos?</strong>
A: Use nested models, Union types para polimorfismo, e validators customizados para l√≥gica complexa:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">country</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span>  <span class="c1"># Lista de objetos aninhados</span>
</pre></div>
</div>
<p><strong>Q: Pydantic funciona com databases/ORMs?</strong>
A: Sim! SQLModel (do criador do FastAPI) combina Pydantic com SQLAlchemy. Tamb√©m √© compat√≠vel com tortoise-orm, peewee, e outros.</p>
<p><strong>Q: Como customizar mensagens de erro?</strong>
A: Use validators customizados, configure error templates, ou processe ValidationError para formata√ß√£o espec√≠fica:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_age</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Idade deve ser positiva&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</section>
</section>
<section id="tratamento-de-erros-e-consumo-de-apis-externas">
<h3>2.4. Tratamento de Erros e Consumo de APIs Externas<a class="headerlink" href="#tratamento-de-erros-e-consumo-de-apis-externas" title="Link to this heading">#</a></h3>
<section id="id7">
<h4>2.4.1. Terminologia Essencial e Defini√ß√µes Formais<a class="headerlink" href="#id7" title="Link to this heading">#</a></h4>
<p><strong>Tratamento de Erros em APIs</strong> refere-se √†s estrat√©gias e t√©cnicas para capturar, processar e responder adequadamente a condi√ß√µes excepcionais que podem ocorrer durante o processamento de requisi√ß√µes HTTP. Inclui tanto erros internos (bugs, falhas de sistema) quanto erros de cliente (dados inv√°lidos, recursos inexistentes).</p>
<p><strong>Consumo de APIs Externas</strong> √© o processo de fazer requisi√ß√µes HTTP program√°ticas para servi√ßos de terceiros, incluindo autentica√ß√£o, parsing de respostas, tratamento de falhas de rede, e implementa√ß√£o de pol√≠ticas de retry e circuit breaker para garantir robustez e confiabilidade.</p>
<p><strong>Conceitos Fundamentais:</strong></p>
<ul class="simple">
<li><p><strong>Exception Handlers</strong>: Fun√ß√µes que interceptam e processam erros espec√≠ficos</p></li>
<li><p><strong>HTTP Status Codes</strong>: C√≥digos padronizados que indicam o resultado de requisi√ß√µes</p></li>
<li><p><strong>Retry Policies</strong>: Estrat√©gias para repetir requisi√ß√µes falhadas</p></li>
<li><p><strong>Circuit Breaker</strong>: Padr√£o que previne cascata de falhas em servi√ßos dependentes</p></li>
<li><p><strong>Backoff Strategies</strong>: Algoritmos para determinar intervalos entre tentativas</p></li>
<li><p><strong>Timeout Management</strong>: Controle de tempo limite para requisi√ß√µes</p></li>
</ul>
<blockquote>
<div><p><strong>üí° Analogia para Entender</strong></p>
<p>Tratamento de erros √© como um sistema de emerg√™ncia em um hospital. Quando algo d√° errado (paciente chega ferido), h√° protocolos claros: triage classifica a severidade, m√©dicos especializados tratam cada tipo de emerg√™ncia, h√° planos de backup se equipamentos falham, e sistemas de comunica√ß√£o mant√™m todos informados. Consumir APIs externas √© como consultar especialistas externos - √†s vezes eles est√£o ocupados (timeout), √†s vezes n√£o respondem (network error), ent√£o voc√™ precisa de estrat√©gias para tentar novamente ou encontrar alternativas.</p>
</div></blockquote>
</section>
<section id="estrutura-conceitual-do-tratamento-de-erros">
<h4>2.4.2. Estrutura Conceitual do Tratamento de Erros<a class="headerlink" href="#estrutura-conceitual-do-tratamento-de-erros" title="Link to this heading">#</a></h4>
<p><strong>1. Taxonomia de Erros em APIs</strong></p>
<pre  class="mermaid">
        graph TD
    A[API Errors] --&gt; B[Client Errors 4xx]
    A --&gt; C[Server Errors 5xx]
    A --&gt; D[Network Errors]
    A --&gt; E[Application Errors]
    
    B --&gt; B1[400 Bad Request]
    B --&gt; B2[401 Unauthorized]
    B --&gt; B3[404 Not Found]
    B --&gt; B4[422 Unprocessable Entity]
    
    C --&gt; C1[500 Internal Server Error]
    C --&gt; C2[502 Bad Gateway]
    C --&gt; C3[503 Service Unavailable]
    C --&gt; C4[504 Gateway Timeout]
    
    D --&gt; D1[Connection Timeout]
    D --&gt; D2[DNS Resolution]
    D --&gt; D3[SSL/TLS Errors]
    
    E --&gt; E1[Business Logic Errors]
    E --&gt; E2[Data Validation Errors]
    E --&gt; E3[Authorization Errors]
    </pre><p><strong>2. Hierarquia de Exception Handlers</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="c1"># Handler espec√≠fico para ValidationError</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captura erros de valida√ß√£o Pydantic e retorna resposta formatada.</span>
<span class="sd">    Prioridade: ALTA (espec√≠fico)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Validation Error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;request_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Handler para HTTPException</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">http_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">HTTPException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captura HTTPExceptions e padroniza formato.</span>
<span class="sd">    Prioridade: M√âDIA (intermedi√°rio)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="c1"># Handler gen√©rico para qualquer Exception</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">general_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captura qualquer erro n√£o tratado.</span>
<span class="sd">    Prioridade: BAIXA (catch-all)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled error: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal Server Error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Something went wrong on our end&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
<p><strong>3. Padr√µes de Consumo de APIs Externas</strong></p>
<p><strong>Estrutura de Cliente HTTP Robusto:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RobustAPIClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cliente HTTP com retry, timeout e circuit breaker integrados.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
            <span class="n">limits</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span><span class="n">max_connections</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="nd">@retry</span><span class="p">(</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># M√°ximo 3 tentativas</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>  <span class="c1"># Backoff exponencial</span>
        <span class="n">reraise</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa requisi√ß√£o HTTP com retry autom√°tico.</span>
<span class="sd">        </span>
<span class="sd">        Estrat√©gia de Retry:</span>
<span class="sd">        - Tentativa 1: imediato</span>
<span class="sd">        - Tentativa 2: ap√≥s 4 segundos</span>
<span class="sd">        - Tentativa 3: ap√≥s 8 segundos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Levanta exce√ß√£o para status codes que devem causar retry</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p><strong>4. Estrat√©gias de Backoff e Circuit Breaker</strong></p>
<pre  class="mermaid">
        graph TD
    A[Request] --&gt; B{Circuit Open?}
    B --&gt;|Yes| C[Immediate Failure]
    B --&gt;|No| D[Execute Request]
    D --&gt; E{Success?}
    E --&gt;|Yes| F[Reset Failure Count]
    E --&gt;|No| G[Increment Failure Count]
    G --&gt; H{Threshold Reached?}
    H --&gt;|Yes| I[Open Circuit]
    H --&gt;|No| J[Apply Backoff]
    J --&gt; K[Retry Request]
    
    I --&gt; L[Wait Half-Open Timeout]
    L --&gt; M[Half-Open State]
    M --&gt; N[Test Request]
    N --&gt;|Success| O[Close Circuit]
    N --&gt;|Failure| I
    </pre><p><strong>Implementa√ß√£o de Circuit Breaker:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">CLOSED</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>      <span class="c1"># Funcionamento normal</span>
    <span class="n">OPEN</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>         <span class="c1"># Bloqueando requisi√ß√µes</span>
    <span class="n">HALF_OPEN</span> <span class="o">=</span> <span class="s2">&quot;half_open&quot;</span>  <span class="c1"># Testando recupera√ß√£o</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementa padr√£o Circuit Breaker para prevenir cascata de falhas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">failure_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">,</span>
        <span class="n">expected_exception</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="ne">Exception</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span> <span class="o">=</span> <span class="n">failure_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_exception</span> <span class="o">=</span> <span class="n">expected_exception</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executa fun√ß√£o com prote√ß√£o de circuit breaker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Circuit breaker is OPEN&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_success</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_failure</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset circuit breaker ap√≥s sucesso.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementa falhas e abre circuit se necess√°rio.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>2.4.3. An√°lise de Consequ√™ncias e Trade-offs<a class="headerlink" href="#id8" title="Link to this heading">#</a></h4>
<p><strong>Benef√≠cios das Estrat√©gias Robustas:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Estrat√©gia</p></th>
<th class="head"><p>Benef√≠cio</p></th>
<th class="head"><p>Cen√°rio de Aplica√ß√£o</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Retry com Backoff</strong></p></td>
<td><p>Resil√™ncia a falhas tempor√°rias</p></td>
<td><p>APIs com instabilidade ocasional</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Circuit Breaker</strong></p></td>
<td><p>Previne cascata de falhas</p></td>
<td><p>Microservi√ßos interdependentes</p></td>
</tr>
<tr class="row-even"><td><p><strong>Timeout Configur√°vel</strong></p></td>
<td><p>Evita requisi√ß√µes infinitas</p></td>
<td><p>APIs com lat√™ncia vari√°vel</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Structured Error Responses</strong></p></td>
<td><p>Debugging facilitado</p></td>
<td><p>Desenvolvimento e monitoramento</p></td>
</tr>
<tr class="row-even"><td><p><strong>Logging Contextual</strong></p></td>
<td><p>Observabilidade</p></td>
<td><p>Troubleshooting em produ√ß√£o</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Custos e Complexidade:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Aspecto</p></th>
<th class="head"><p>Custo</p></th>
<th class="head"><p>Mitiga√ß√£o</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Lat√™ncia Adicional</strong></p></td>
<td><p>Retries aumentam tempo de resposta</p></td>
<td><p>Configurar timeouts apropriados</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Complexidade de C√≥digo</strong></p></td>
<td><p>Mais l√≥gica para manter</p></td>
<td><p>Usar bibliotecas testadas (tenacity, circuitbreaker)</p></td>
</tr>
<tr class="row-even"><td><p><strong>Resource Usage</strong></p></td>
<td><p>Mais conex√µes, mem√≥ria</p></td>
<td><p>Limitar pool de conex√µes</p></td>
</tr>
<tr class="row-odd"><td><p><strong>False Positives</strong></p></td>
<td><p>Circuit breaker pode fechar APIs funcionais</p></td>
<td><p>Tune thresholds baseado em m√©tricas</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Padr√µes de Erro por Tipo de API:</strong></p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Tipo de API</p></th>
<th class="head"><p>Padr√µes Comuns</p></th>
<th class="head"><p>Estrat√©gia Recomendada</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Payment APIs</strong></p></td>
<td><p>Rate limiting, transient failures</p></td>
<td><p>Retry conservador, idempot√™ncia</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Social Media APIs</strong></p></td>
<td><p>Rate limits rigorosos</p></td>
<td><p>Backoff exponencial, caching</p></td>
</tr>
<tr class="row-even"><td><p><strong>Weather/Data APIs</strong></p></td>
<td><p>Timeouts longos, dados grandes</p></td>
<td><p>Timeout estendido, streaming</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Internal Microservices</strong></p></td>
<td><p>Network blips, deploy rolling</p></td>
<td><p>Circuit breaker, health checks</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="id9">
<h4>2.4.4. An√°lise Cr√≠tica e FAQ<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<p><strong>Armadilhas no Tratamento de Erros:</strong></p>
<ol class="arabic simple">
<li><p><strong>Generic Error Messages</strong>: Erros muito gen√©ricos dificultam debugging</p></li>
<li><p><strong>Information Leakage</strong>: Expor stack traces em produ√ß√£o √© risco de seguran√ßa</p></li>
<li><p><strong>Retry Storms</strong>: Retries agressivos podem sobrecarregar APIs j√° inst√°veis</p></li>
<li><p><strong>Silent Failures</strong>: Falhar silenciosamente sem logs apropriados</p></li>
<li><p><strong>Inconsistent Error Format</strong>: Diferentes formatos confundem clientes</p></li>
</ol>
<p><strong>FAQ: Tratamento de Erros e APIs Externas</strong></p>
<p><strong>Q: Quando usar retry vs circuit breaker?</strong>
A: Use retry para falhas transientes (network blips, timeouts ocasionais). Use circuit breaker quando um servi√ßo inteiro est√° inst√°vel e voc√™ quer evitar sobrecarreg√°-lo ainda mais.</p>
<p><strong>Q: Como determinar configura√ß√µes de timeout?</strong>
A: Analise m√©tricas hist√≥ricas da API: timeout = P95 da lat√™ncia + margem de seguran√ßa. Para APIs cr√≠ticas, considere m√∫ltiplos timeouts (connection, read, total).</p>
<p><strong>Q: Devo cachear respostas de erro?</strong>
A: Depende do tipo de erro. Cache 404s por tempo limitado, nunca cache 500s (podem ser transientes), cache rate limit responses at√© reset.</p>
<p><strong>Q: Como implementar idempot√™ncia em requisi√ß√µes?</strong>
A: Use idempotency keys em headers, implemente deduplica√ß√£o no lado servidor, e documente quais opera√ß√µes s√£o naturalmente idempotentes (GET, PUT, DELETE).</p>
<p><strong>Q: Como monitorar sa√∫de de APIs externas?</strong>
A: Implemente health checks peri√≥dicos, colete m√©tricas (lat√™ncia, error rate, throughput), configure alertas baseados em SLAs, e tenha dashboards de observabilidade.</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="aplicacao-pratica-e-implementacao">
<h2>3. Aplica√ß√£o Pr√°tica e Implementa√ß√£o<a class="headerlink" href="#aplicacao-pratica-e-implementacao" title="Link to this heading">#</a></h2>
<section id="estudo-de-caso-guiado">
<h3>3.1. Estudo de Caso Guiado<a class="headerlink" href="#estudo-de-caso-guiado" title="Link to this heading">#</a></h3>
<p>Vamos construir um <strong>Sistema de Gerenciamento de Biblioteca Digital</strong> que demonstra todos os conceitos estudados. Este sistema permitir√° gerenciar livros, autores e empr√©stimos, al√©m de consumir APIs externas para enriquecer informa√ß√µes bibliogr√°ficas.</p>
<p><strong>Contextualiza√ß√£o do Problema:</strong> Nossa biblioteca precisa de uma API moderna que permita:</p>
<ul class="simple">
<li><p>Catalogar livros e autores</p></li>
<li><p>Gerenciar empr√©stimos e devolu√ß√µes</p></li>
<li><p>Enriquecer dados bibliogr√°ficos via APIs externas (Google Books, OpenLibrary)</p></li>
<li><p>Fornecer documenta√ß√£o autom√°tica para desenvolvedores</p></li>
<li><p>Garantir robustez com tratamento de erros apropriado</p></li>
</ul>
<section id="passo-1-configuracao-do-ambiente-e-estrutura-do-projeto">
<h4>Passo 1: Configura√ß√£o do Ambiente e Estrutura do Projeto<a class="headerlink" href="#passo-1-configuracao-do-ambiente-e-estrutura-do-projeto" title="Link to this heading">#</a></h4>
<p>Primeiro, vamos configurar nosso projeto com as depend√™ncias necess√°rias:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># requirements.txt</span>
<span class="n">fastapi</span><span class="o">==</span><span class="mf">0.104.1</span>
<span class="n">uvicorn</span><span class="p">[</span><span class="n">standard</span><span class="p">]</span><span class="o">==</span><span class="mf">0.24.0</span>
<span class="n">pydantic</span><span class="o">==</span><span class="mf">2.5.0</span>
<span class="n">httpx</span><span class="o">==</span><span class="mf">0.25.2</span>
<span class="n">tenacity</span><span class="o">==</span><span class="mf">8.2.3</span>
<span class="n">python</span><span class="o">-</span><span class="n">multipart</span><span class="o">==</span><span class="mf">0.0.6</span>
<span class="n">redis</span><span class="o">==</span><span class="mf">5.0.1</span>  <span class="c1"># Para caching</span>
<span class="n">pytest</span><span class="o">==</span><span class="mf">7.4.3</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">asyncio</span><span class="o">==</span><span class="mf">0.21.1</span>
</pre></div>
</div>
<p><strong>Estrutura de Diret√≥rios:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>biblioteca_api/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # Ponto de entrada da aplica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Modelos Pydantic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ author.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loan.py
‚îÇ   ‚îú‚îÄ‚îÄ routers/             # Rotas organizadas por dom√≠nio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ books.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authors.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loans.py
‚îÇ   ‚îú‚îÄ‚îÄ services/            # L√≥gica de neg√≥cio e clientes externos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ external_apis.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cache.py
‚îÇ   ‚îî‚îÄ‚îÄ core/                # Configura√ß√µes e utilit√°rios
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ config.py
‚îÇ       ‚îî‚îÄ‚îÄ exceptions.py
‚îú‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ README.md
</pre></div>
</div>
</section>
<section id="passo-2-definindo-modelos-de-dados-com-pydantic">
<h4>Passo 2: Definindo Modelos de Dados com Pydantic<a class="headerlink" href="#passo-2-definindo-modelos-de-dados-com-pydantic" title="Link to this heading">#</a></h4>
<p>Come√ßamos definindo nossos modelos de dados com valida√ß√£o robusta:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/models/author.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthorBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modelo base para dados do autor.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Heran√ßa em Pydantic permite reutiliza√ß√£o de campos</span>
<span class="sd">    comuns entre diferentes contextos (cria√ß√£o, resposta, atualiza√ß√£o).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> 
        <span class="n">min_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Nome completo do autor&quot;</span>
    <span class="p">)</span>
    <span class="n">nationality</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Nacionalidade do autor&quot;</span>
    <span class="p">)</span>
    <span class="n">birth_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Data de nascimento do autor&quot;</span>
    <span class="p">)</span>
    <span class="n">biography</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Biografia resumida do autor&quot;</span>
    <span class="p">)</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO CUSTOMIZADA: Garante que o nome contenha apenas</span>
<span class="sd">        caracteres v√°lidos e tenha formato apropriado.</span>
<span class="sd">        </span>
<span class="sd">        BENEF√çCIO: Evita dados inconsistentes no banco de dados</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z√Ä-√ø\s</span><span class="se">\&#39;</span><span class="s1">-\.]+$&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Nome deve conter apenas letras, espa√ßos, h√≠fens e apostrofes&#39;</span>
            <span class="p">)</span>
        
        <span class="c1"># Normaliza capitaliza√ß√£o</span>
        <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;birth_date&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_birth_date</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO DE DATAS: Garante que a data de nascimento</span>
<span class="sd">        seja realista (n√£o no futuro, n√£o muito antiga).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
            
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">today</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data de nascimento n√£o pode ser no futuro&#39;</span><span class="p">)</span>
            
        <span class="c1"># Assumindo que n√£o temos autores com mais de 150 anos</span>
        <span class="n">min_birth_year</span> <span class="o">=</span> <span class="n">today</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">150</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">min_birth_year</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data de nascimento deve ser posterior a </span><span class="si">{</span><span class="n">min_birth_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthorCreate</span><span class="p">(</span><span class="n">AuthorBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modelo para cria√ß√£o de autor.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Separa√ß√£o de responsabilidades - dados necess√°rios</span>
<span class="sd">    para cria√ß√£o podem diferir dos dados de resposta.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthorUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modelo para atualiza√ß√£o de autor.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Todos os campos opcionais para permitir</span>
<span class="sd">    atualiza√ß√µes parciais (PATCH operations).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">nationality</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">birth_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">biography</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Author</span><span class="p">(</span><span class="n">AuthorBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modelo completo do autor (resposta da API).</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Inclui campos gerados pelo sistema (ID, timestamps)</span>
<span class="sd">    que n√£o est√£o presentes na cria√ß√£o.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Identificador √∫nico do autor&quot;</span><span class="p">)</span>
    <span class="n">books_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;N√∫mero de livros publicados&quot;</span><span class="p">)</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="c1"># Permite cria√ß√£o a partir de ORMs (SQLAlchemy, etc.)</span>
        <span class="n">from_attributes</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Exemplo de dados para documenta√ß√£o autom√°tica</span>
        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gabriel Garc√≠a M√°rquez&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nationality&quot;</span><span class="p">:</span> <span class="s2">&quot;Colombiana&quot;</span><span class="p">,</span>
                <span class="s2">&quot;birth_date&quot;</span><span class="p">:</span> <span class="s2">&quot;1927-03-06&quot;</span><span class="p">,</span>
                <span class="s2">&quot;biography&quot;</span><span class="p">:</span> <span class="s2">&quot;Escritor colombiano, ganhador do Pr√™mio Nobel...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;books_count&quot;</span><span class="p">:</span> <span class="mi">12</span>
            <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/models/book.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CONCEITO: Enum para garantir valores v√°lidos de status.</span>
<span class="sd">    </span>
<span class="sd">    BENEF√çCIO: Type safety e documenta√ß√£o autom√°tica dos</span>
<span class="sd">    valores aceitos pela API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AVAILABLE</span> <span class="o">=</span> <span class="s2">&quot;available&quot;</span>
    <span class="n">BORROWED</span> <span class="o">=</span> <span class="s2">&quot;borrowed&quot;</span> 
    <span class="n">MAINTENANCE</span> <span class="o">=</span> <span class="s2">&quot;maintenance&quot;</span>
    <span class="n">LOST</span> <span class="o">=</span> <span class="s2">&quot;lost&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modelo base para livros com valida√ß√µes avan√ßadas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> 
        <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;T√≠tulo do livro&quot;</span>
    <span class="p">)</span>
    <span class="n">isbn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ISBN do livro (10 ou 13 d√≠gitos)&quot;</span>
    <span class="p">)</span>
    <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ID do autor do livro&quot;</span>
    <span class="p">)</span>
    <span class="n">publication_year</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Ano de publica√ß√£o&quot;</span>
    <span class="p">)</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">le</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;N√∫mero de p√°ginas&quot;</span>
    <span class="p">)</span>
    <span class="n">genre</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;G√™nero liter√°rio&quot;</span>
    <span class="p">)</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Resumo do livro&quot;</span>
    <span class="p">)</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;isbn&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_isbn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO COMPLEXA: Valida formato ISBN-10 ou ISBN-13.</span>
<span class="sd">        </span>
<span class="sd">        CONCEITO: Demonstra como implementar valida√ß√µes espec√≠ficas</span>
<span class="sd">        de dom√≠nio usando regex e algoritmos de verifica√ß√£o.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
            
        <span class="c1"># Remove h√≠fens e espa√ßos</span>
        <span class="n">isbn_clean</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[-\s]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        
        <span class="c1"># Valida ISBN-10</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isbn_clean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d</span><span class="si">{9}</span><span class="s1">[\dX]$&#39;</span><span class="p">,</span> <span class="n">isbn_clean</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ISBN-10 deve ter 9 d√≠gitos seguidos de um d√≠gito ou X&#39;</span><span class="p">)</span>
            
            <span class="c1"># Algoritmo de verifica√ß√£o ISBN-10</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isbn_clean</span><span class="p">[:</span><span class="mi">9</span><span class="p">]):</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
            
            <span class="n">check_digit</span> <span class="o">=</span> <span class="n">isbn_clean</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">check_digit</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="mi">10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">check_digit</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">total</span> <span class="o">%</span> <span class="mi">11</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ISBN-10 inv√°lido (falha na verifica√ß√£o)&#39;</span><span class="p">)</span>
                
        <span class="c1"># Valida ISBN-13</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">isbn_clean</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d</span><span class="si">{13}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">isbn_clean</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ISBN-13 deve ter exatamente 13 d√≠gitos&#39;</span><span class="p">)</span>
            
            <span class="c1"># Algoritmo de verifica√ß√£o ISBN-13</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">digit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">isbn_clean</span><span class="p">[:</span><span class="mi">12</span><span class="p">]):</span>
                <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">3</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span>
            
            <span class="n">check_digit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="p">(</span><span class="n">total</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">isbn_clean</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">!=</span> <span class="n">check_digit</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ISBN-13 inv√°lido (falha na verifica√ß√£o)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ISBN deve ter 10 ou 13 d√≠gitos&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">isbn_clean</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;publication_year&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_publication_year</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO TEMPORAL: Garante que o ano de publica√ß√£o</span>
<span class="sd">        seja realista (n√£o no futuro, n√£o muito antigo).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
            
        <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">current_year</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ano de publica√ß√£o n√£o pode ser no futuro&#39;</span><span class="p">)</span>
            
        <span class="c1"># Assumindo que n√£o catalogamos livros anteriores a 1000 d.C.</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Ano de publica√ß√£o deve ser posterior a 1000&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookCreate</span><span class="p">(</span><span class="n">BookBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modelo para cria√ß√£o de livro.&quot;&quot;&quot;</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">BookStatus</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">BookStatus</span><span class="o">.</span><span class="n">AVAILABLE</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Status inicial do livro&quot;</span>
    <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modelo para atualiza√ß√£o parcial de livro.&quot;&quot;&quot;</span>
    <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">isbn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">author_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">publication_year</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
    <span class="n">genre</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BookStatus</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="n">BookBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modelo completo do livro (resposta da API).&quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Identificador √∫nico do livro&quot;</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">BookStatus</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Status atual do livro&quot;</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">date</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Data de cadastro&quot;</span><span class="p">)</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Data da √∫ltima atualiza√ß√£o&quot;</span><span class="p">)</span>
    
    <span class="c1"># Dados enriquecidos de APIs externas</span>
    <span class="n">external_rating</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> 
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
        <span class="n">le</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Avalia√ß√£o de APIs externas&quot;</span>
    <span class="p">)</span>
    <span class="n">cover_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;URL da capa do livro&quot;</span>
    <span class="p">)</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">from_attributes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">schema_extra</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Cem Anos de Solid√£o&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isbn&quot;</span><span class="p">:</span> <span class="s2">&quot;9788535902770&quot;</span><span class="p">,</span>
                <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;publication_year&quot;</span><span class="p">:</span> <span class="mi">1967</span><span class="p">,</span>
                <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="mi">448</span><span class="p">,</span>
                <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="s2">&quot;Realismo M√°gico&quot;</span><span class="p">,</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;A hist√≥ria da fam√≠lia Buend√≠a...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available&quot;</span><span class="p">,</span>
                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2024-01-15&quot;</span><span class="p">,</span>
                <span class="s2">&quot;external_rating&quot;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
                <span class="s2">&quot;cover_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://example.com/cover.jpg&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="passo-3-criando-rotas-restful-com-fastapi">
<h4>Passo 3: Criando Rotas RESTful com FastAPI<a class="headerlink" href="#passo-3-criando-rotas-restful-com-fastapi" title="Link to this heading">#</a></h4>
<p>Agora implementamos as rotas seguindo os princ√≠pios REST:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/routers/books.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..models.book</span><span class="w"> </span><span class="kn">import</span> <span class="n">Book</span><span class="p">,</span> <span class="n">BookCreate</span><span class="p">,</span> <span class="n">BookUpdate</span><span class="p">,</span> <span class="n">BookStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.external_apis</span><span class="w"> </span><span class="kn">import</span> <span class="n">BookEnrichmentService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..services.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheService</span>

<span class="c1"># CONCEITO: APIRouter permite organizar rotas relacionadas</span>
<span class="c1"># em m√≥dulos separados, facilitando manuten√ß√£o e scaling</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/books&quot;</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;books&quot;</span><span class="p">],</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span><span class="mi">404</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro n√£o encontrado&quot;</span><span class="p">}}</span>
<span class="p">)</span>

<span class="c1"># Simula√ß√£o de banco de dados em mem√≥ria para demonstra√ß√£o</span>
<span class="c1"># Em produ√ß√£o, usar SQLAlchemy, MongoDB, etc.</span>
<span class="n">books_db</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Book</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">next_book_id</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Depend√™ncias injetadas</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_enrichment_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">BookEnrichmentService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CONCEITO: Dependency Injection Pattern</span>
<span class="sd">    </span>
<span class="sd">    BENEF√çCIO: Permite f√°cil substitui√ß√£o de implementa√ß√µes</span>
<span class="sd">    para testes, diferentes ambientes, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">BookEnrichmentService</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_cache_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">CacheService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Depend√™ncia para servi√ßo de cache.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CacheService</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Book</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Criar um novo livro&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cria um novo livro no cat√°logo da biblioteca&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_book</span><span class="p">(</span>
    <span class="n">book_data</span><span class="p">:</span> <span class="n">BookCreate</span><span class="p">,</span>
    <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_enrichment_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO CREATE (POST): Cria um novo recurso livro.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS DEMONSTRADOS:</span>
<span class="sd">    - Valida√ß√£o autom√°tica via Pydantic</span>
<span class="sd">    - Enriquecimento de dados via API externa</span>
<span class="sd">    - Response model para documenta√ß√£o</span>
<span class="sd">    - Status code apropriado (201 Created)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">next_book_id</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># VALIDA√á√ÉO DE NEG√ìCIO: Verifica se author_id existe</span>
        <span class="c1"># Em produ√ß√£o, isso seria uma consulta ao banco</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_author_exists</span><span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">author_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autor com ID </span><span class="si">{</span><span class="n">book_data</span><span class="o">.</span><span class="n">author_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># ENRIQUECIMENTO DE DADOS: Busca informa√ß√µes externas</span>
        <span class="n">external_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">enrichment_service</span><span class="o">.</span><span class="n">enrich_book_data</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">isbn</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">isbn</span>
        <span class="p">)</span>
        
        <span class="c1"># CRIA√á√ÉO DO OBJETO: Combina dados locais e externos</span>
        <span class="n">new_book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">next_book_id</span><span class="p">,</span>
            <span class="o">**</span><span class="n">book_data</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span>
            <span class="n">external_rating</span><span class="o">=</span><span class="n">external_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">),</span>
            <span class="n">cover_url</span><span class="o">=</span><span class="n">external_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cover_url&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">books_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_book</span><span class="p">)</span>
        <span class="n">next_book_id</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Livro criado com sucesso: ID </span><span class="si">{</span><span class="n">new_book</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_book</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao criar livro: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Erro interno do servidor ao criar livro&quot;</span>
        <span class="p">)</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">Book</span><span class="p">],</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Listar livros&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Lista todos os livros com filtros opcionais&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_books</span><span class="p">(</span>
    <span class="n">status_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BookStatus</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filtrar por status do livro&quot;</span>
    <span class="p">),</span>
    <span class="n">genre</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filtrar por g√™nero&quot;</span>
    <span class="p">),</span>
    <span class="n">author_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filtrar por autor&quot;</span>
    <span class="p">),</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span> 
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
        <span class="n">le</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;N√∫mero m√°ximo de resultados&quot;</span>
    <span class="p">),</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> 
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;N√∫mero de registros a pular&quot;</span>
    <span class="p">),</span>
    <span class="n">cache_service</span><span class="p">:</span> <span class="n">CacheService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_cache_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO READ (GET): Lista recursos com filtros e pagina√ß√£o.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS DEMONSTRADOS:</span>
<span class="sd">    - Query parameters para filtros</span>
<span class="sd">    - Pagina√ß√£o com limit/offset</span>
<span class="sd">    - Cache para otimiza√ß√£o</span>
<span class="sd">    - Documenta√ß√£o autom√°tica de par√¢metros</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># CHAVE DE CACHE: Combina todos os par√¢metros</span>
    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;books_list:</span><span class="si">{</span><span class="n">status_filter</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">genre</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">author_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># TENTATIVA DE CACHE: Verifica se resultado est√° cached</span>
    <span class="n">cached_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_result</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache hit para listagem de livros: </span><span class="si">{</span><span class="n">cache_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached_result</span>
    
    <span class="c1"># APLICA√á√ÉO DE FILTROS: Usa list comprehension para efici√™ncia</span>
    <span class="n">filtered_books</span> <span class="o">=</span> <span class="n">books_db</span>
    
    <span class="k">if</span> <span class="n">status_filter</span><span class="p">:</span>
        <span class="n">filtered_books</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filtered_books</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">status_filter</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">genre</span><span class="p">:</span>
        <span class="n">filtered_books</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filtered_books</span> 
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">genre</span> <span class="ow">and</span> <span class="n">genre</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">genre</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">]</span>
    
    <span class="k">if</span> <span class="n">author_id</span><span class="p">:</span>
        <span class="n">filtered_books</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">filtered_books</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">author_id</span> <span class="o">==</span> <span class="n">author_id</span><span class="p">]</span>
    
    <span class="c1"># PAGINA√á√ÉO: Aplica offset e limit</span>
    <span class="n">paginated_books</span> <span class="o">=</span> <span class="n">filtered_books</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">limit</span><span class="p">]</span>
    
    <span class="c1"># ARMAZENAMENTO EM CACHE: Cache por 5 minutos</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">paginated_books</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Listagem retornada: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">paginated_books</span><span class="p">)</span><span class="si">}</span><span class="s2"> livros&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">paginated_books</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Book</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Obter livro por ID&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Retorna um livro espec√≠fico pelo seu ID&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_book</span><span class="p">(</span>
    <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">cache_service</span><span class="p">:</span> <span class="n">CacheService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_cache_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO READ (GET): Obt√©m um recurso espec√≠fico.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS DEMONSTRADOS:</span>
<span class="sd">    - Path parameter tipado</span>
<span class="sd">    - Cache individual de recursos</span>
<span class="sd">    - Tratamento de erro 404</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;book:</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># VERIFICA√á√ÉO DE CACHE</span>
    <span class="n">cached_book</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cached_book</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cached_book</span>
    
    <span class="c1"># BUSCA NO &quot;BANCO DE DADOS&quot;</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">book</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Livro com ID </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># ARMAZENAMENTO EM CACHE</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">book</span><span class="p">,</span> <span class="n">expire</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">book</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Book</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Atualizar livro completamente&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Substitui todos os dados de um livro&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_book_full</span><span class="p">(</span>
    <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">book_update</span><span class="p">:</span> <span class="n">BookCreate</span><span class="p">,</span>  <span class="c1"># Requer todos os campos</span>
    <span class="n">cache_service</span><span class="p">:</span> <span class="n">CacheService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_cache_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO UPDATE (PUT): Substitui√ß√£o completa do recurso.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO REST: PUT deve substituir o recurso inteiro,</span>
<span class="sd">    n√£o apenas campos espec√≠ficos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">book</span> <span class="o">=</span> <span class="n">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">book</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Livro com ID </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># VALIDA√á√ÉO DE NEG√ìCIO</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_author_exists</span><span class="p">(</span><span class="n">book_update</span><span class="o">.</span><span class="n">author_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autor com ID </span><span class="si">{</span><span class="n">book_update</span><span class="o">.</span><span class="n">author_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># ATUALIZA√á√ÉO COMPLETA: Preserva ID e metadados</span>
    <span class="n">updated_book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="o">**</span><span class="n">book_update</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
        <span class="n">updated_at</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span>
        <span class="n">external_rating</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">external_rating</span><span class="p">,</span>
        <span class="n">cover_url</span><span class="o">=</span><span class="n">book</span><span class="o">.</span><span class="n">cover_url</span>
    <span class="p">)</span>
    
    <span class="c1"># SUBSTITUI√á√ÉO NO &quot;BANCO&quot;</span>
    <span class="n">book_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">books_db</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">book_id</span><span class="p">)</span>
    <span class="n">books_db</span><span class="p">[</span><span class="n">book_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_book</span>
    
    <span class="c1"># INVALIDA√á√ÉO DE CACHE</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;book:</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete_pattern</span><span class="p">(</span><span class="s2">&quot;books_list:*&quot;</span><span class="p">)</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> atualizado completamente&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_book</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">Book</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Atualizar livro parcialmente&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Atualiza apenas os campos fornecidos&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_book_partial</span><span class="p">(</span>
    <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">book_update</span><span class="p">:</span> <span class="n">BookUpdate</span><span class="p">,</span>  <span class="c1"># Campos opcionais</span>
    <span class="n">cache_service</span><span class="p">:</span> <span class="n">CacheService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_cache_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO UPDATE (PATCH): Atualiza√ß√£o parcial do recurso.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO REST: PATCH permite atualizar apenas campos</span>
<span class="sd">    espec√≠ficos sem afetar o restante do recurso.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">book</span> <span class="o">=</span> <span class="n">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">book</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Livro com ID </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># DADOS PARA ATUALIZA√á√ÉO: Remove campos None</span>
    <span class="n">update_data</span> <span class="o">=</span> <span class="n">book_update</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># VALIDA√á√ÉO CONDICIONAL: S√≥ valida author_id se fornecido</span>
    <span class="k">if</span> <span class="s1">&#39;author_id&#39;</span> <span class="ow">in</span> <span class="n">update_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_author_exists</span><span class="p">(</span><span class="n">update_data</span><span class="p">[</span><span class="s1">&#39;author_id&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autor com ID </span><span class="si">{</span><span class="n">update_data</span><span class="p">[</span><span class="s1">&#39;author_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># ATUALIZA√á√ÉO PARCIAL: Usa copy/update pattern</span>
    <span class="n">book_dict</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
    <span class="n">book_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">update_data</span><span class="p">)</span>
    <span class="n">book_dict</span><span class="p">[</span><span class="s1">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    
    <span class="n">updated_book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="o">**</span><span class="n">book_dict</span><span class="p">)</span>
    
    <span class="c1"># SUBSTITUI√á√ÉO NO &quot;BANCO&quot;</span>
    <span class="n">book_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">books_db</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">book_id</span><span class="p">)</span>
    <span class="n">books_db</span><span class="p">[</span><span class="n">book_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_book</span>
    
    <span class="c1"># INVALIDA√á√ÉO DE CACHE</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;book:</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete_pattern</span><span class="p">(</span><span class="s2">&quot;books_list:*&quot;</span><span class="p">)</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> atualizado parcialmente: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">update_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_book</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
    <span class="s2">&quot;/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_204_NO_CONTENT</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Remover livro&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Remove um livro do cat√°logo&quot;</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_book</span><span class="p">(</span>
    <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">cache_service</span><span class="p">:</span> <span class="n">CacheService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_cache_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    OPERA√á√ÉO DELETE: Remove recurso do sistema.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS DEMONSTRADOS:</span>
<span class="sd">    - Status 204 No Content para dele√ß√£o bem-sucedida</span>
<span class="sd">    - Valida√ß√£o de regras de neg√≥cio</span>
<span class="sd">    - Limpeza de cache relacionado</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">book</span> <span class="o">=</span> <span class="n">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">book</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Livro com ID </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># REGRA DE NEG√ìCIO: N√£o permite deletar livros emprestados</span>
    <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">BookStatus</span><span class="o">.</span><span class="n">BORROWED</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;N√£o √© poss√≠vel deletar livro emprestado&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># REMO√á√ÉO DO &quot;BANCO&quot;</span>
    <span class="k">global</span> <span class="n">books_db</span>
    <span class="n">books_db</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">books_db</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">book_id</span><span class="p">]</span>
    
    <span class="c1"># LIMPEZA DE CACHE</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;book:</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">cache_service</span><span class="o">.</span><span class="n">delete_pattern</span><span class="p">(</span><span class="s2">&quot;books_list:*&quot;</span><span class="p">)</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> removido com sucesso&quot;</span><span class="p">)</span>
    <span class="c1"># Retorno vazio com status 204</span>

<span class="c1"># FUN√á√ïES AUXILIARES</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Book</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Busca livro por ID no &#39;banco de dados&#39;.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">book</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books_db</span> <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">book_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_author_exists</span><span class="p">(</span><span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verifica se autor existe (simulado).&quot;&quot;&quot;</span>
    <span class="c1"># Em produ√ß√£o, seria uma consulta ao banco</span>
    <span class="k">return</span> <span class="n">author_id</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="c1"># Simula√ß√£o simples</span>
</pre></div>
</div>
</section>
<section id="passo-4-implementando-consumo-de-apis-externas">
<h4>Passo 4: Implementando Consumo de APIs Externas<a class="headerlink" href="#passo-4-implementando-consumo-de-apis-externas" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/services/external_apis.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tenacity</span><span class="w"> </span><span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">stop_after_attempt</span><span class="p">,</span> <span class="n">wait_exponential</span><span class="p">,</span> <span class="n">retry_if_exception_type</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookEnrichmentService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Servi√ßo para enriquecer dados de livros usando APIs externas.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Separation of Concerns - isola l√≥gica de integra√ß√£o</span>
<span class="sd">    externa da l√≥gica de neg√≥cio principal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONFIGURA√á√ÉO: Inicializa cliente HTTP com configura√ß√µes</span>
<span class="sd">        otimizadas para consumo de APIs externas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span>
                <span class="n">connect</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>  <span class="c1"># Tempo para estabelecer conex√£o</span>
                <span class="n">read</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>    <span class="c1"># Tempo para ler resposta</span>
                <span class="n">total</span><span class="o">=</span><span class="mf">35.0</span>    <span class="c1"># Tempo total m√°ximo</span>
            <span class="p">),</span>
            <span class="n">limits</span><span class="o">=</span><span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span>
                <span class="n">max_connections</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>        <span class="c1"># Pool de conex√µes</span>
                <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="mi">20</span>  <span class="c1"># Conex√µes keep-alive</span>
            <span class="p">),</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;BibliotecaAPI/1.0 (Educational Purpose)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
            <span class="p">}</span>
        <span class="p">)</span>
    
    <span class="nd">@retry</span><span class="p">(</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
        <span class="n">wait</span><span class="o">=</span><span class="n">wait_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
        <span class="n">retry</span><span class="o">=</span><span class="n">retry_if_exception_type</span><span class="p">((</span><span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_safe_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PADR√ÉO RETRY: Executa requisi√ß√µes com retry autom√°tico.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIA:</span>
<span class="sd">        - Retry apenas em erros de rede/timeout</span>
<span class="sd">        - Backoff exponencial para n√£o sobrecarregar</span>
<span class="sd">        - M√°ximo 3 tentativas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="c1"># TRATAMENTO DE STATUS: Lan√ßa exce√ß√£o para 5xx</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="n">response</span>
            
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="c1"># Re-raise para trigger retry</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 4xx errors n√£o devem fazer retry</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Client error </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enrich_book_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">isbn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ENRIQUECIMENTO PRINCIPAL: Combina dados de m√∫ltiplas APIs.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIA:</span>
<span class="sd">        - Tenta m√∫ltiplas fontes em paralelo</span>
<span class="sd">        - Combina resultados de forma inteligente</span>
<span class="sd">        - Falha gracefully se APIs estiverem indispon√≠veis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># EXECU√á√ÉO PARALELA: M√∫ltiplas APIs simultaneamente</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_google_books_data</span><span class="p">(</span><span class="n">isbn</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_openlibrary_data</span><span class="p">(</span><span class="n">isbn</span><span class="p">))</span>
        
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_goodreads_data</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>
        
        <span class="c1"># AGUARDA TODAS AS RESPOSTAS (com timeout)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Timeout ao buscar dados externos&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        
        <span class="c1"># CONSOLIDA√á√ÉO DE DADOS: Combina resultados</span>
        <span class="n">enriched_data</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># ESTRAT√âGIA DE MERGE: Prioriza dados mais completos</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enriched_data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">enriched_data</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                        <span class="n">enriched_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="k">return</span> <span class="n">enriched_data</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_google_books_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INTEGRA√á√ÉO GOOGLE BOOKS API: Busca dados bibliogr√°ficos.</span>
<span class="sd">        </span>
<span class="sd">        DOCUMENTA√á√ÉO: https://developers.google.com/books/docs/v1/using</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.googleapis.com/books/v1/volumes&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;isbn:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;maxResults&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">{}</span>
            
            <span class="c1"># EXTRA√á√ÉO DE DADOS: Parse da resposta da API</span>
            <span class="n">book_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;volumeInfo&quot;</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cover_url&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imageLinks&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thumbnail&quot;</span><span class="p">),</span>
                <span class="s2">&quot;page_count&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pageCount&quot;</span><span class="p">),</span>
                <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;published_date&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publishedDate&quot;</span><span class="p">),</span>
                <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro na API Google Books: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_openlibrary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INTEGRA√á√ÉO OPENLIBRARY API: Dados bibliogr√°ficos alternativos.</span>
<span class="sd">        </span>
<span class="sd">        DOCUMENTA√á√ÉO: https://openlibrary.org/developers/api</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://openlibrary.org/api/books&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bibkeys&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ISBN:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;jscmd&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span>
            <span class="p">}</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">book_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ISBN:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="k">if</span> <span class="n">book_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            
            <span class="n">book_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">book_key</span><span class="p">]</span>
            
            <span class="c1"># MAPEAMENTO DE DADOS: Adapta formato da API</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excerpts&quot;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cover_url&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cover&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medium&quot;</span><span class="p">),</span>
                <span class="s2">&quot;subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subjects&quot;</span><span class="p">,</span> <span class="p">[])],</span>
                <span class="s2">&quot;publish_date&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publish_date&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro na API OpenLibrary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_goodreads_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SIMULA√á√ÉO GOODREADS: API real requer autentica√ß√£o complexa.</span>
<span class="sd">        </span>
<span class="sd">        CONCEITO: Demonstra como lidar com APIs que t√™m</span>
<span class="sd">        requisitos de autentica√ß√£o mais rigorosos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Em produ√ß√£o, usar API key e OAuth</span>
            <span class="c1"># Por ora, simula resposta baseada no t√≠tulo</span>
            
            <span class="c1"># SIMULA√á√ÉO REALISTA: Dados baseados em padr√µes reais</span>
            <span class="n">simulated_rating</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">+</span> <span class="mf">3.0</span>  <span class="c1"># Rating 3.0-8.0</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">simulated_rating</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="s2">&quot;reviews_count&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">title</span><span class="p">))</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">,</span>
                <span class="s2">&quot;popularity_score&quot;</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">title</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro simulando dados Goodreads: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;LIMPEZA: Fecha cliente HTTP adequadamente.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="passo-5-implementando-sistema-de-cache">
<h4>Passo 5: Implementando Sistema de Cache<a class="headerlink" href="#passo-5-implementando-sistema-de-cache" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/services/cache.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">redis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CacheService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Servi√ßo de cache using Redis para otimizar performance.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Cache Pattern - armazena resultados frequentemente</span>
<span class="sd">    acessados para reduzir lat√™ncia e carga no sistema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;redis://localhost:6379&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONFIGURA√á√ÉO REDIS: Inicializa conex√£o com configura√ß√µes</span>
<span class="sd">        otimizadas para alta disponibilidade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span>
            <span class="n">redis_url</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
            <span class="n">decode_responses</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Permitir dados bin√°rios</span>
            <span class="n">max_connections</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="n">retry_on_timeout</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_ttl</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># 5 minutos padr√£o</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RECUPERA√á√ÉO DE CACHE: Busca valor por chave.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIA:</span>
<span class="sd">        - Serializa√ß√£o autom√°tica via pickle para objetos complexos</span>
<span class="sd">        - Logging para monitoramento de cache hits/misses</span>
<span class="sd">        - Tratamento graceful de erros de conex√£o</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cached_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">cached_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache miss: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># DESERIALIZA√á√ÉO: Converte bytes para objeto Python</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">:</span>
                <span class="c1"># Fallback para JSON se pickle falhar</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cached_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                
        <span class="k">except</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redis connection error para chave: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro inesperado no cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> 
        <span class="n">expire</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ARMAZENAMENTO EM CACHE: Salva valor com TTL opcional.</span>
<span class="sd">        </span>
<span class="sd">        CONCEITOS:</span>
<span class="sd">        - TTL (Time To Live) para expira√ß√£o autom√°tica</span>
<span class="sd">        - Serializa√ß√£o eficiente via pickle</span>
<span class="sd">        - Error handling para garantir robustez</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># SERIALIZA√á√ÉO: Converte objeto Python para bytes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">serialized_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">serialized_value</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            
            <span class="c1"># CONFIGURA√á√ÉO DE TTL</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="n">expire</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_ttl</span>
            
            <span class="c1"># ARMAZENAMENTO: Set com expira√ß√£o</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">serialized_value</span><span class="p">)</span>
            
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache set: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (TTL: </span><span class="si">{</span><span class="n">ttl</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">except</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Redis connection error ao definir: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao definir cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INVALIDA√á√ÉO DE CACHE: Remove chave espec√≠fica.</span>
<span class="sd">        </span>
<span class="sd">        USO: Limpar cache quando dados s√£o atualizados</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache delete: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (existed: </span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao deletar cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INVALIDA√á√ÉO POR PADR√ÉO: Remove m√∫ltiplas chaves.</span>
<span class="sd">        </span>
<span class="sd">        EXEMPLO: delete_pattern(&quot;books_list:*&quot;) remove todos</span>
<span class="sd">        os caches de listagem de livros.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># BUSCA POR PADR√ÉO: Encontra chaves correspondentes</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">scan_iter</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="n">pattern</span><span class="p">):</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
                <span class="c1"># DELE√á√ÉO EM LOTE: Remove todas de uma vez</span>
                <span class="n">deleted_count</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">keys</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache pattern delete: </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">deleted_count</span><span class="si">}</span><span class="s2"> keys)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">deleted_count</span>
            
            <span class="k">return</span> <span class="mi">0</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao deletar pattern: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MONITORAMENTO: Retorna estat√≠sticas do cache.</span>
<span class="sd">        </span>
<span class="sd">        M√âTRICAS √öTEIS:</span>
<span class="sd">        - Hit ratio para an√°lise de efici√™ncia</span>
<span class="sd">        - Uso de mem√≥ria</span>
<span class="sd">        - N√∫mero de chaves ativas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;connected_clients&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connected_clients&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s2">&quot;used_memory_human&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;used_memory_human&quot;</span><span class="p">,</span> <span class="s2">&quot;0B&quot;</span><span class="p">),</span>
                <span class="s2">&quot;keyspace_hits&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyspace_hits&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s2">&quot;keyspace_misses&quot;</span><span class="p">:</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyspace_misses&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s2">&quot;hit_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_hit_ratio</span><span class="p">(</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyspace_hits&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyspace_misses&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao obter stats: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_hit_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hits</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">misses</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calcula taxa de acerto do cache.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">hits</span> <span class="o">+</span> <span class="n">misses</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">hits</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;LIMPEZA: Fecha conex√£o Redis.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="passo-6-configuracao-da-aplicacao-principal">
<h4>Passo 6: Configura√ß√£o da Aplica√ß√£o Principal<a class="headerlink" href="#passo-6-configuracao-da-aplicacao-principal" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/config.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">Field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CONFIGURA√á√ÉO CENTRALIZADA: Usa Pydantic para valida√ß√£o</span>
<span class="sd">    e carregamento de vari√°veis de ambiente.</span>
<span class="sd">    </span>
<span class="sd">    PADR√ÉO 12-FACTOR APP: Configura√ß√£o via ambiente</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Configura√ß√µes da aplica√ß√£o</span>
    <span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;Biblioteca API&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;APP_NAME&quot;</span><span class="p">)</span>
    <span class="n">app_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;APP_VERSION&quot;</span><span class="p">)</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>
    
    <span class="c1"># Configura√ß√µes de API externa</span>
    <span class="n">google_books_api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;GOOGLE_BOOKS_API_KEY&quot;</span><span class="p">)</span>
    <span class="n">request_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;REQUEST_TIMEOUT&quot;</span><span class="p">)</span>
    
    <span class="c1"># Configura√ß√µes de cache</span>
    <span class="n">redis_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;redis://localhost:6379&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;REDIS_URL&quot;</span><span class="p">)</span>
    <span class="n">cache_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;CACHE_TTL&quot;</span><span class="p">)</span>
    
    <span class="c1"># Configura√ß√µes de logging</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">)</span>
    
    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="s2">&quot;.env&quot;</span>
        <span class="n">env_file_encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>

<span class="c1"># Inst√¢ncia global de configura√ß√µes</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/exceptions.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BibliotecaAPIException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EXCE√á√ÉO BASE: Exce√ß√£o customizada para erros de neg√≥cio.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Hierarquia de exce√ß√µes permite tratamento</span>
<span class="sd">    espec√≠fico para diferentes tipos de erro.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthorNotFoundError</span><span class="p">(</span><span class="n">BibliotecaAPIException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o para autor n√£o encontrado.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Autor com ID </span><span class="si">{</span><span class="n">author_id</span><span class="si">}</span><span class="s2"> n√£o foi encontrado&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="n">author_id</span><span class="p">}</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookNotFoundError</span><span class="p">(</span><span class="n">BibliotecaAPIException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o para livro n√£o encontrado.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Livro com ID </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o foi encontrado&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;book_id&quot;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">}</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExternalAPIError</span><span class="p">(</span><span class="n">BibliotecaAPIException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o para falhas em APIs externas.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Falha na API externa </span><span class="si">{</span><span class="n">api_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;api_name&quot;</span><span class="p">:</span> <span class="n">api_name</span><span class="p">,</span> <span class="s2">&quot;error_details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">}</span>
        <span class="p">)</span>

<span class="c1"># Exception Handlers</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">biblioteca_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">BibliotecaAPIException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HANDLER CUSTOMIZADO: Trata exce√ß√µes espec√≠ficas da aplica√ß√£o.</span>
<span class="sd">    </span>
<span class="sd">    PADRONIZA√á√ÉO: Garante formato consistente de erro</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;request_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validation_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HANDLER PYDANTIC: Formata erros de valida√ß√£o de forma amig√°vel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">422</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Dados inv√°lidos fornecidos&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">]),</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">exc</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
            <span class="p">],</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">http_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">HTTPException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HANDLER HTTP: Padroniza respostas HTTPException.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">general_exception_handler</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HANDLER GEN√âRICO: Captura erros n√£o tratados.</span>
<span class="sd">    </span>
<span class="sd">    SEGURAN√áA: N√£o exp√µe detalhes internos em produ√ß√£o</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled exception: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Erro interno do servidor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Algo deu errado. Nossa equipe foi notificada.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/main.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.trustedhost</span><span class="w"> </span><span class="kn">import</span> <span class="n">TrustedHostMiddleware</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BibliotecaAPIException</span><span class="p">,</span> <span class="n">biblioteca_exception_handler</span><span class="p">,</span>
    <span class="n">validation_exception_handler</span><span class="p">,</span> <span class="n">http_exception_handler</span><span class="p">,</span>
    <span class="n">general_exception_handler</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.routers</span><span class="w"> </span><span class="kn">import</span> <span class="n">books</span><span class="p">,</span> <span class="n">authors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.services.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.services.external_apis</span><span class="w"> </span><span class="kn">import</span> <span class="n">BookEnrichmentService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span>

<span class="c1"># CONFIGURA√á√ÉO DE LOGGING</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">log_level</span><span class="p">),</span>
    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LIFECYCLE MANAGEMENT: Gerencia inicializa√ß√£o e limpeza.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Context manager para recursos que precisam</span>
<span class="sd">    ser inicializados/finalizados adequadamente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># INICIALIZA√á√ÉO</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iniciando Biblioteca API...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Aqui seria inicializa√ß√£o de DB, conex√µes, etc.</span>
    <span class="c1"># cache_service = CacheService(settings.redis_url)</span>
    
    <span class="k">yield</span>  <span class="c1"># Aplica√ß√£o roda aqui</span>
    
    <span class="c1"># LIMPEZA</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finalizando Biblioteca API...&quot;</span><span class="p">)</span>
    <span class="c1"># await cache_service.close()</span>

<span class="c1"># CRIA√á√ÉO DA APLICA√á√ÉO</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;API RESTful para gerenciamento de biblioteca digital&quot;</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">app_version</span><span class="p">,</span>
    <span class="n">docs_url</span><span class="o">=</span><span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
    <span class="n">redoc_url</span><span class="o">=</span><span class="s2">&quot;/redoc&quot;</span><span class="p">,</span>
    <span class="n">openapi_url</span><span class="o">=</span><span class="s2">&quot;/openapi.json&quot;</span><span class="p">,</span>
    <span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span>
<span class="p">)</span>

<span class="c1"># MIDDLEWARES</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">CORSMiddleware</span><span class="p">,</span>
    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>  <span class="c1"># Em produ√ß√£o, especificar origins</span>
    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
    <span class="n">TrustedHostMiddleware</span><span class="p">,</span>
    <span class="n">allowed_hosts</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>  <span class="c1"># Em produ√ß√£o, especificar hosts</span>
<span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request_logging_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MIDDLEWARE CUSTOMIZADO: Logging e timing de requisi√ß√µes.</span>
<span class="sd">    </span>
<span class="sd">    OBSERVABILIDADE: Coleta m√©tricas para monitoramento</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># GERA√á√ÉO DE REQUEST ID</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
    
    <span class="c1"># IN√çCIO DO TIMING</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="c1"># LOG DA REQUISI√á√ÉO</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Request started: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="p">)</span>
    
    <span class="c1"># PROCESSAMENTO DA REQUISI√á√ÉO</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="c1"># C√ÅLCULO DE TEMPO DE PROCESSAMENTO</span>
    <span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># LOG DA RESPOSTA</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Request completed: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">process_time</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="p">)</span>
    
    <span class="c1"># ADI√á√ÉO DE HEADERS</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Process-Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">process_time</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># EXCEPTION HANDLERS</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">BibliotecaAPIException</span><span class="p">,</span> <span class="n">biblioteca_exception_handler</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="n">validation_exception_handler</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">HTTPException</span><span class="p">,</span> <span class="n">http_exception_handler</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">general_exception_handler</span><span class="p">)</span>

<span class="c1"># ROUTERS</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">authors</span><span class="o">.</span><span class="n">router</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/api/v1&quot;</span><span class="p">)</span>

<span class="c1"># HEALTH CHECK</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;health&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HEALTH CHECK: Endpoint para verifica√ß√£o de sa√∫de.</span>
<span class="sd">    </span>
<span class="sd">    USO: Load balancers e monitoramento</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;app_name&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">app_version</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="p">}</span>

<span class="c1"># ROOT ENDPOINT</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT RAIZ: Informa√ß√µes b√°sicas da API.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bem-vindo √† </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">app_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">app_version</span><span class="p">,</span>
        <span class="s2">&quot;docs&quot;</span><span class="p">:</span> <span class="s2">&quot;/docs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;redoc&quot;</span><span class="p">:</span> <span class="s2">&quot;/redoc&quot;</span>
    <span class="p">}</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="s2">&quot;app.main:app&quot;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
        <span class="n">reload</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">debug</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="passo-7-testes-automatizados">
<h4>Passo 7: Testes Automatizados<a class="headerlink" href="#passo-7-testes-automatizados" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># tests/test_books.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">app.models.book</span><span class="w"> </span><span class="kn">import</span> <span class="n">BookCreate</span><span class="p">,</span> <span class="n">BookStatus</span>

<span class="c1"># CONFIGURA√á√ÉO DE TESTE</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestBooksAPI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TESTES DE INTEGRA√á√ÉO: Testa endpoints da API de livros.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS TESTADOS:</span>
<span class="sd">    - CRUD operations</span>
<span class="sd">    - Valida√ß√£o de dados</span>
<span class="sd">    - Error handling</span>
<span class="sd">    - Cache behavior</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_book_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE POSITIVO: Cria√ß√£o bem-sucedida de livro.</span>
<span class="sd">        </span>
<span class="sd">        CEN√ÅRIO:</span>
<span class="sd">        - Dados v√°lidos fornecidos</span>
<span class="sd">        - Autor existe</span>
<span class="sd">        - API externa retorna dados</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ARRANGE: Preparar dados de teste</span>
        <span class="n">book_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;O Alquimista&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isbn&quot;</span><span class="p">:</span> <span class="s2">&quot;9788573028751&quot;</span><span class="p">,</span>
            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;publication_year&quot;</span><span class="p">:</span> <span class="mi">1988</span><span class="p">,</span>
            <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="mi">163</span><span class="p">,</span>
            <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="s2">&quot;Fic√ß√£o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="s2">&quot;A hist√≥ria de Santiago...&quot;</span>
        <span class="p">}</span>
        
        <span class="c1"># MOCK: Simular depend√™ncias externas</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;app.services.external_apis.BookEnrichmentService&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_service</span><span class="p">:</span>
            <span class="n">mock_service</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">enrich_book_data</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;rating&quot;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>
                <span class="s2">&quot;cover_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://example.com/cover.jpg&quot;</span>
            <span class="p">}</span>
            
            <span class="c1"># ACT: Executar opera√ß√£o</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book_data</span><span class="p">)</span>
        
        <span class="c1"># ASSERT: Verificar resultados</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">book_data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;isbn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">book_data</span><span class="p">[</span><span class="s2">&quot;isbn&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="s2">&quot;id&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_book_invalid_isbn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE NEGATIVO: ISBN inv√°lido deve retornar erro.</span>
<span class="sd">        </span>
<span class="sd">        VALIDA√á√ÉO: Algoritmo de verifica√ß√£o ISBN</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro Teste&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isbn&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>  <span class="c1"># ISBN inv√°lido</span>
            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;publication_year&quot;</span><span class="p">:</span> <span class="mi">2023</span>
        <span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book_data</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
        <span class="k">assert</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_create_book_missing_required_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE NEGATIVO: Campos obrigat√≥rios ausentes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro Incompleto&quot;</span>
            <span class="c1"># author_id ausente (obrigat√≥rio)</span>
        <span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book_data</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">422</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;author_id&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;details&quot;</span><span class="p">])</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_list_books_with_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE DE FILTROS: Listagem com query parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ARRANGE: Criar livros de teste</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_test_books</span><span class="p">()</span>
        
        <span class="c1"># ACT: Buscar com filtros</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/?genre=fic√ß√£o&amp;limit=5&quot;</span><span class="p">)</span>
        
        <span class="c1"># ASSERT</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span>
        <span class="c1"># Verificar se filtro foi aplicado</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">book</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;fic√ß√£o&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_get_book_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE NEGATIVO: Buscar livro inexistente.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/99999&quot;</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span>
        <span class="k">assert</span> <span class="s2">&quot;n√£o encontrado&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_book_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE PATCH: Atualiza√ß√£o parcial de livro.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ARRANGE: Criar livro</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_test_book</span><span class="p">()</span>
        
        <span class="c1"># ACT: Atualizar apenas t√≠tulo</span>
        <span class="n">update_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;T√≠tulo Atualizado&quot;</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/books/</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">update_data</span><span class="p">)</span>
        
        <span class="c1"># ASSERT</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;T√≠tulo Atualizado&quot;</span>
        <span class="c1"># Outros campos devem permanecer inalterados</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;author_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_delete_borrowed_book_forbidden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE DE REGRA DE NEG√ìCIO: N√£o pode deletar livro emprestado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ARRANGE: Criar livro emprestado</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_test_book</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;borrowed&quot;</span><span class="p">)</span>
        
        <span class="c1"># ACT: Tentar deletar</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/books/</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># ASSERT</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
        <span class="k">assert</span> <span class="s2">&quot;emprestado&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
    
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_external_api_timeout_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE DE RESIL√äNCIA: Comportamento com timeout de API externa.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro Teste&quot;</span><span class="p">,</span>
            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
        
        <span class="c1"># MOCK: Simular timeout</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;app.services.external_apis.BookEnrichmentService&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_service</span><span class="p">:</span>
            <span class="n">mock_service</span><span class="o">.</span><span class="n">return_value</span><span class="o">.</span><span class="n">enrich_book_data</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">()</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book_data</span><span class="p">)</span>
        
        <span class="c1"># ASSERT: Livro deve ser criado mesmo com falha na API externa</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;external_rating&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">test_cache_behavior</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TESTE DE CACHE: Verificar se cache est√° funcionando.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_test_book</span><span class="p">()</span>
        
        <span class="c1"># Primeira requisi√ß√£o (miss)</span>
        <span class="n">response1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/books/</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Segunda requisi√ß√£o (hit - deve ser mais r√°pida)</span>
        <span class="n">response2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/api/v1/books/</span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">assert</span> <span class="n">response1</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">assert</span> <span class="n">response2</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="k">assert</span> <span class="n">response1</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="n">response2</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    
    <span class="c1"># M√âTODOS AUXILIARES</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_test_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;available&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cria livro de teste e retorna ID.&quot;&quot;&quot;</span>
        <span class="n">book_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro de Teste&quot;</span><span class="p">,</span>
            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_test_books</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cria m√∫ltiplos livros de teste.&quot;&quot;&quot;</span>
        <span class="n">books</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fic√ß√£o 1&quot;</span><span class="p">,</span> <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="s2">&quot;fic√ß√£o&quot;</span><span class="p">,</span> <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Romance 1&quot;</span><span class="p">,</span> <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="s2">&quot;romance&quot;</span><span class="p">,</span> <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fic√ß√£o 2&quot;</span><span class="p">,</span> <span class="s2">&quot;genre&quot;</span><span class="p">:</span> <span class="s2">&quot;fic√ß√£o&quot;</span><span class="p">,</span> <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="n">book_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">book</span><span class="p">)</span>
            <span class="n">book_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">book_ids</span>

<span class="c1"># CONFIGURA√á√ÉO PYTEST</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_app</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture para aplica√ß√£o de teste.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="k">as</span> <span class="n">test_client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">test_client</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">reset_database</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset do banco de dados entre testes.&quot;&quot;&quot;</span>
    <span class="c1"># Em produ√ß√£o, usar banco de teste real</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">app.routers.books</span><span class="w"> </span><span class="kn">import</span> <span class="n">books_db</span>
    <span class="n">books_db</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="exemplos-de-codigo-comentado">
<h3>3.2. Exemplos de C√≥digo Comentado<a class="headerlink" href="#exemplos-de-codigo-comentado" title="Link to this heading">#</a></h3>
<p>Al√©m do estudo de caso, aqui est√£o exemplos espec√≠ficos de padr√µes importantes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXEMPLO: Implementa√ß√£o de Middleware Customizado</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">performance_monitoring_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MIDDLEWARE DE PERFORMANCE: Monitora tempo de resposta e recursos.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Middleware permite interceptar requisi√ß√µes e respostas</span>
<span class="sd">    para adicionar funcionalidades transversais (logging, auth, metrics).</span>
<span class="sd">    </span>
<span class="sd">    BENEF√çCIOS:</span>
<span class="sd">    - Observabilidade centralizada</span>
<span class="sd">    - Detec√ß√£o de endpoints lentos</span>
<span class="sd">    - M√©tricas autom√°ticas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># CAPTURA INICIAL: Timestamp e recursos</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="c1"># HEADERS DE REQUEST: Extrair informa√ß√µes √∫teis</span>
    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
    
    <span class="c1"># PROCESSAMENTO: Delegar para pr√≥ximo middleware/endpoint</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># LOG DE ERRO: Capturar falhas n√£o tratadas</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled error in </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    
    <span class="c1"># M√âTRICAS FINAIS: Calcular tempo total</span>
    <span class="n">process_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="c1"># LOGGING ESTRUTURADO: Informa√ß√µes para an√°lise</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Request processed&quot;</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;process_time_ms&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">process_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;user_agent&quot;</span><span class="p">:</span> <span class="n">user_agent</span><span class="p">,</span>
            <span class="s2">&quot;content_length&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
    
    <span class="c1"># HEADERS DE RESPOSTA: Adicionar m√©tricas</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Process-Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">process_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Server-Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># EXEMPLO: Dependency Injection Avan√ßada</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simula√ß√£o de servi√ßo de banco de dados.&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_string</span> <span class="o">=</span> <span class="n">connection_string</span>
        <span class="c1"># Inicializa√ß√£o de conex√£o...</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Retorna conex√£o ativa</span>
        <span class="k">pass</span>

<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_database_service</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">DatabaseService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPENDENCY SINGLETON: Cria inst√¢ncia √∫nica do servi√ßo.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: @lru_cache() garante que apenas uma inst√¢ncia</span>
<span class="sd">    seja criada durante o ciclo de vida da aplica√ß√£o.</span>
<span class="sd">    </span>
<span class="sd">    BENEF√çCIO: Economiza recursos, mant√©m estado consistente</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DatabaseService</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">database_url</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_db_connection</span><span class="p">(</span>
    <span class="n">db_service</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">DatabaseService</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_database_service</span><span class="p">)]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPENDENCY FACTORY: Cria recurso com cleanup autom√°tico.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITO: Generator dependency permite setup/teardown</span>
<span class="sd">    autom√°tico de recursos como conex√µes de banco.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db_service</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">connection</span>  <span class="c1"># Fornece conex√£o para endpoint</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Cleanup autom√°tico</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/books/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_book_with_db</span><span class="p">(</span>
    <span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">DatabaseConnection</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_connection</span><span class="p">)]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT COM DEPEND√äNCIAS: Inje√ß√£o autom√°tica de recursos.</span>
<span class="sd">    </span>
<span class="sd">    FLUXO:</span>
<span class="sd">    1. FastAPI identifica depend√™ncias</span>
<span class="sd">    2. Executa get_database_service() (singleton)</span>
<span class="sd">    3. Executa get_db_connection() (factory)</span>
<span class="sd">    4. Injeta conex√£o no endpoint</span>
<span class="sd">    5. Executa endpoint</span>
<span class="sd">    6. Cleanup autom√°tico da conex√£o</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_book</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>

<span class="c1"># EXEMPLO: Validation Customizada Complexa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">root_validator</span><span class="p">,</span> <span class="n">Field</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BookOrderRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    VALIDA√á√ÉO CROSS-FIELD: Regras que envolvem m√∫ltiplos campos.</span>
<span class="sd">    </span>
<span class="sd">    CEN√ÅRIO: Pedido de livros com diferentes tipos de desconto</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">book_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">quantity_per_book</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;book_id -&gt; quantity&quot;</span><span class="p">)</span>
    <span class="n">discount_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s2">&quot;^(percentage|fixed|bulk)$&quot;</span><span class="p">)</span>
    <span class="n">discount_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">customer_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s2">&quot;^(regular|premium|student)$&quot;</span><span class="p">)</span>
    
    <span class="nd">@root_validator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_order_consistency</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO COMPLEXA: Regras de neg√≥cio customizadas.</span>
<span class="sd">        </span>
<span class="sd">        REGRAS:</span>
<span class="sd">        1. quantity_per_book deve conter todos os book_ids</span>
<span class="sd">        2. Desconto percentual n√£o pode exceder 100%</span>
<span class="sd">        3. Desconto bulk s√≥ para quantidade &gt;= 5</span>
<span class="sd">        4. Estudantes s√≥ podem ter desconto percentual</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">book_ids</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;book_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">quantities</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quantity_per_book&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">discount_type</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_type&#39;</span><span class="p">)</span>
        <span class="n">discount_value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discount_value&#39;</span><span class="p">)</span>
        <span class="n">customer_type</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customer_type&#39;</span><span class="p">)</span>
        
        <span class="c1"># REGRA 1: Consist√™ncia entre livros e quantidades</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">book_id</span> <span class="ow">in</span> <span class="n">quantities</span> <span class="k">for</span> <span class="n">book_id</span> <span class="ow">in</span> <span class="n">book_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quantidade deve ser especificada para todos os livros&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">book_id</span> <span class="ow">in</span> <span class="n">book_ids</span> <span class="k">for</span> <span class="n">book_id</span> <span class="ow">in</span> <span class="n">quantities</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quantidade especificada para livros n√£o solicitados&#39;</span><span class="p">)</span>
        
        <span class="c1"># REGRA 2: Limite de desconto percentual</span>
        <span class="k">if</span> <span class="n">discount_type</span> <span class="o">==</span> <span class="s1">&#39;percentage&#39;</span> <span class="ow">and</span> <span class="n">discount_value</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Desconto percentual n√£o pode exceder 100%&#39;</span><span class="p">)</span>
        
        <span class="c1"># REGRA 3: Desconto bulk requer quantidade m√≠nima</span>
        <span class="k">if</span> <span class="n">discount_type</span> <span class="o">==</span> <span class="s1">&#39;bulk&#39;</span><span class="p">:</span>
            <span class="n">total_quantity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">quantities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">total_quantity</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Desconto bulk requer pelo menos 5 livros&#39;</span><span class="p">)</span>
        
        <span class="c1"># REGRA 4: Restri√ß√µes por tipo de cliente</span>
        <span class="k">if</span> <span class="n">customer_type</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span> <span class="ow">and</span> <span class="n">discount_type</span> <span class="o">!=</span> <span class="s1">&#39;percentage&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Estudantes s√≥ podem ter desconto percentual&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">values</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;quantity_per_book&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_quantities</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;VALIDA√á√ÉO DE QUANTIDADES: Limites por livro.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">book_id</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantidade deve ser positiva para livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Quantidade m√°xima √© 100 por livro (livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</pre></div>
</div>
</section>
<section id="ferramentas-bibliotecas-e-ecossistema">
<h3>3.3. Ferramentas, Bibliotecas e Ecossistema<a class="headerlink" href="#ferramentas-bibliotecas-e-ecossistema" title="Link to this heading">#</a></h3>
<p>Para nossa implementa√ß√£o da Biblioteca API, utilizamos exclusivamente as seguintes ferramentas e bibliotecas que foram efetivamente demonstradas no c√≥digo:</p>
<section id="dependencias-principais">
<h4>Depend√™ncias Principais<a class="headerlink" href="#dependencias-principais" title="Link to this heading">#</a></h4>
<p><strong>FastAPI 0.104.1</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Framework principal para cria√ß√£o da API REST</p></li>
<li><p><strong>Por que escolhemos</strong>: Documenta√ß√£o autom√°tica, valida√ß√£o via type hints, alta performance</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Cria√ß√£o de todos os endpoints, dependency injection, middleware</p></li>
</ul>
<p><strong>Pydantic 2.5.0</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Valida√ß√£o e serializa√ß√£o de dados</p></li>
<li><p><strong>Por que escolhemos</strong>: Integra√ß√£o nativa com FastAPI, valida√ß√µes complexas, type safety</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Modelos de dados (Book, Author), valida√ß√£o de ISBN, cross-field validation</p></li>
</ul>
<p><strong>httpx 0.25.2</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Cliente HTTP ass√≠ncrono para consumo de APIs externas</p></li>
<li><p><strong>Por que escolhemos</strong>: Suporte async/await, timeout configur√°vel, pool de conex√µes</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Integra√ß√£o com Google Books API e OpenLibrary API</p></li>
</ul>
<p><strong>Tenacity 8.2.3</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Implementa√ß√£o de retry policies com backoff exponencial</p></li>
<li><p><strong>Por que escolhemos</strong>: Configura√ß√£o flex√≠vel, diferentes estrat√©gias de retry</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Retry autom√°tico para falhas de rede em APIs externas</p></li>
</ul>
</section>
<section id="dependencias-de-desenvolvimento-e-teste">
<h4>Depend√™ncias de Desenvolvimento e Teste<a class="headerlink" href="#dependencias-de-desenvolvimento-e-teste" title="Link to this heading">#</a></h4>
<p><strong>pytest 7.4.3 + pytest-asyncio 0.21.1</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Framework de testes para valida√ß√£o da API</p></li>
<li><p><strong>Por que escolhemos</strong>: Suporte a testes ass√≠ncronos, fixtures poderosas</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Testes de endpoints, mocking de APIs externas, valida√ß√£o de regras de neg√≥cio</p></li>
</ul>
<p><strong>Uvicorn 0.24.0</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Servidor ASGI para desenvolvimento e produ√ß√£o</p></li>
<li><p><strong>Por que escolhemos</strong>: Performance superior, suporte nativo a FastAPI</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Servidor de desenvolvimento com hot reload</p></li>
</ul>
</section>
<section id="dependencias-de-infraestrutura">
<h4>Depend√™ncias de Infraestrutura<a class="headerlink" href="#dependencias-de-infraestrutura" title="Link to this heading">#</a></h4>
<p><strong>Redis 5.0.1</strong></p>
<ul class="simple">
<li><p><strong>Fun√ß√£o no projeto</strong>: Sistema de cache para otimiza√ß√£o de performance</p></li>
<li><p><strong>Por que escolhemos</strong>: Cache distribu√≠do, TTL autom√°tico, high performance</p></li>
<li><p><strong>Uso espec√≠fico</strong>: Cache de listagens de livros, dados de APIs externas</p></li>
</ul>
</section>
<section id="recursos-nativos-do-python">
<h4>Recursos Nativos do Python<a class="headerlink" href="#recursos-nativos-do-python" title="Link to this heading">#</a></h4>
<p>Para valida√ß√µes avan√ßadas e l√≥gica de neg√≥cio, utilizamos apenas recursos nativos do Python 3.12+:</p>
<p><strong>M√≥dulos padr√£o utilizados:</strong></p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">re</span></code></strong>: Valida√ß√£o de formatos (ISBN, email, nomes)</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">datetime</span></code></strong>: Manipula√ß√£o de datas e timestamps</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">json</span></code></strong>: Serializa√ß√£o para cache</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">pickle</span></code></strong>: Serializa√ß√£o eficiente de objetos complexos</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">logging</span></code></strong>: Sistema de logs estruturado</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">asyncio</span></code></strong>: Programa√ß√£o ass√≠ncrona para paraleliza√ß√£o</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">uuid</span></code></strong>: Gera√ß√£o de IDs √∫nicos para requisi√ß√µes</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">time</span></code></strong>: Medi√ß√£o de performance e timeouts</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">enum</span></code></strong>: Type safety para status de livros</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">typing</span></code></strong>: Annotations avan√ßadas para melhor IDE support</p></li>
</ul>
</section>
<section id="decisoes-arquiteturais">
<h4>Decis√µes Arquiteturais<a class="headerlink" href="#decisoes-arquiteturais" title="Link to this heading">#</a></h4>
<p><strong>Por que n√£o outras bibliotecas populares?</strong></p>
<ul class="simple">
<li><p><strong>Requests vs httpx</strong>: httpx oferece suporte nativo async/await essencial para alta concorr√™ncia</p></li>
<li><p><strong>Flask vs FastAPI</strong>: FastAPI oferece documenta√ß√£o autom√°tica e valida√ß√£o sem c√≥digo adicional</p></li>
<li><p><strong>SQLAlchemy</strong>: N√£o inclu√≠do no exemplo para manter foco nos conceitos REST, mas seria adicionado em produ√ß√£o</p></li>
<li><p><strong>Celery</strong>: Para este exemplo, processamento s√≠ncrono atende aos requisitos</p></li>
</ul>
<p><strong>Configura√ß√£o de Produ√ß√£o recomendada:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Servidor de produ√ß√£o</span>
gunicorn<span class="w"> </span>app.main:app<span class="w"> </span>-w<span class="w"> </span><span class="m">4</span><span class="w"> </span>-k<span class="w"> </span>uvicorn.workers.UvicornWorker

<span class="c1"># Monitoramento</span>
prometheus<span class="w"> </span>+<span class="w"> </span>grafana

<span class="c1"># Load balancer</span>
nginx<span class="w"> </span>ou<span class="w"> </span>traefik

<span class="c1"># Container</span>
docker<span class="w"> </span>+<span class="w"> </span>docker-compose
</pre></div>
</div>
<p>Esta configura√ß√£o demonstra como construir APIs robustas usando ferramentas modernas e pr√°ticas recomendadas, mantendo o foco na simplicidade e manutenibilidade do c√≥digo.</p>
</section>
</section>
</section>
<section id="topicos-avancados-e-nuances">
<h2>4. T√≥picos Avan√ßados e Nuances<a class="headerlink" href="#topicos-avancados-e-nuances" title="Link to this heading">#</a></h2>
<p>Esta se√ß√£o explora aspectos avan√ßados da constru√ß√£o e consumo de APIs REST que s√£o fundamentais para aplica√ß√µes de produ√ß√£o robustas. Abordaremos autentica√ß√£o, estrat√©gias de resili√™ncia, otimiza√ß√£o de performance e desafios pr√°ticos encontrados no mundo real.</p>
<section id="autenticacao-e-autorizacao">
<h3>4.1. Autentica√ß√£o e Autoriza√ß√£o<a class="headerlink" href="#autenticacao-e-autorizacao" title="Link to this heading">#</a></h3>
<section id="implementacao-de-jwt-json-web-tokens">
<h4>4.1.1. Implementa√ß√£o de JWT (JSON Web Tokens)<a class="headerlink" href="#implementacao-de-jwt-json-web-tokens" title="Link to this heading">#</a></h4>
<p>A autentica√ß√£o baseada em tokens √© essencial para APIs modernas, especialmente em arquiteturas distribu√≠das onde sess√µes tradicionais n√£o s√£o adequadas.</p>
<p><strong>Conceitos Fundamentais:</strong></p>
<ul class="simple">
<li><p><strong>Stateless Authentication</strong>: JWT permite autentica√ß√£o sem manter estado no servidor</p></li>
<li><p><strong>Token Structure</strong>: Header.Payload.Signature - cada parte tem fun√ß√£o espec√≠fica</p></li>
<li><p><strong>Claims</strong>: Informa√ß√µes codificadas no token (iss, exp, sub, custom claims)</p></li>
<li><p><strong>Refresh Tokens</strong>: Estrat√©gia para renova√ß√£o segura de tokens expirados</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/security.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">passlib.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CryptContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBearer</span><span class="p">,</span> <span class="n">HTTPAuthorizationCredentials</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AuthenticationService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Servi√ßo de autentica√ß√£o com JWT para APIs REST.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS IMPLEMENTADOS:</span>
<span class="sd">    - Gera√ß√£o e valida√ß√£o de JWT tokens</span>
<span class="sd">    - Hash seguro de senhas com bcrypt</span>
<span class="sd">    - Refresh token mechanism</span>
<span class="sd">    - Role-based access control (RBAC)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;HS256&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONFIGURA√á√ÉO SEGURA: Inicializa servi√ßo com par√¢metros criptogr√°ficos.</span>
<span class="sd">        </span>
<span class="sd">        SECURITY NOTES:</span>
<span class="sd">        - secret_key deve ser forte (256+ bits)</span>
<span class="sd">        - algorithm HS256 √© adequado para single-service</span>
<span class="sd">        - Para microservices, considerar RS256 (assinatura assim√©trica)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwd_context</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bcrypt&quot;</span><span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bearer</span> <span class="o">=</span> <span class="n">HTTPBearer</span><span class="p">(</span><span class="n">auto_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">create_access_token</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> 
        <span class="n">expires_delta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        GERA√á√ÉO DE TOKEN: Cria JWT com claims personalizados.</span>
<span class="sd">        </span>
<span class="sd">        ESTRUTURA DO TOKEN:</span>
<span class="sd">        - sub (subject): user_id</span>
<span class="sd">        - exp (expiration): timestamp de expira√ß√£o</span>
<span class="sd">        - iat (issued at): timestamp de cria√ß√£o</span>
<span class="sd">        - type: &quot;access&quot; para diferencia√ß√£o</span>
<span class="sd">        - roles: lista de roles do usu√°rio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_encode</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># CONFIGURA√á√ÉO DE EXPIRA√á√ÉO</span>
        <span class="k">if</span> <span class="n">expires_delta</span><span class="p">:</span>
            <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">expires_delta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Padr√£o: 15min</span>
        
        <span class="c1"># CLAIMS PADR√ÉO</span>
        <span class="n">to_encode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">expire</span><span class="p">,</span>
            <span class="s2">&quot;iat&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;access&quot;</span>
        <span class="p">})</span>
        
        <span class="c1"># ASSINATURA: Codifica payload com secret</span>
        <span class="n">encoded_jwt</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to_encode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access token created for user </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encoded_jwt</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">create_refresh_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        REFRESH TOKEN: Token de longa dura√ß√£o para renova√ß√£o.</span>
<span class="sd">        </span>
<span class="sd">        SECURITY: Refresh tokens t√™m menos claims e maior TTL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;exp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># 30 dias</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ÉO DE TOKEN: Decodifica e valida JWT.</span>
<span class="sd">        </span>
<span class="sd">        VALIDA√á√ïES:</span>
<span class="sd">        - Assinatura v√°lida</span>
<span class="sd">        - Token n√£o expirado</span>
<span class="sd">        - Formato correto</span>
<span class="sd">        - Tipo de token apropriado</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># DECODIFICA√á√ÉO: Verifica assinatura e expira√ß√£o</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> 
                <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
            <span class="p">)</span>
            
            <span class="c1"># VALIDA√á√ÉO DE CLAIMS OBRIGAT√ìRIOS</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
            <span class="n">token_type</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token inv√°lido: sub claim ausente&quot;</span>
                <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">token_type</span> <span class="o">!=</span> <span class="s2">&quot;access&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Tipo de token inv√°lido&quot;</span>
                <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">payload</span>
            
        <span class="k">except</span> <span class="n">JWTError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JWT validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token inv√°lido ou expirado&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">}</span>
            <span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HASH DE SENHA: bcrypt com salt autom√°tico.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd_context</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plain_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;VERIFICA√á√ÉO DE SENHA: Compara hash com senha plain.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwd_context</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">plain_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>

<span class="c1"># Inst√¢ncia global do servi√ßo</span>
<span class="n">auth_service</span> <span class="o">=</span> <span class="n">AuthenticationService</span><span class="p">(</span><span class="n">secret_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">secret_key</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_user</span><span class="p">(</span>
    <span class="n">credentials</span><span class="p">:</span> <span class="n">HTTPAuthorizationCredentials</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">auth_service</span><span class="o">.</span><span class="n">bearer</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPENDENCY DE AUTENTICA√á√ÉO: Extrai e valida usu√°rio atual.</span>
<span class="sd">    </span>
<span class="sd">    FLUXO:</span>
<span class="sd">    1. Extrai token do header Authorization</span>
<span class="sd">    2. Valida token JWT</span>
<span class="sd">    3. Retorna payload com dados do usu√°rio</span>
<span class="sd">    4. Falha com 401 se token inv√°lido</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">credentials</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token de acesso requerido&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;WWW-Authenticate&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">}</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">verify_token</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">credentials</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_active_user</span><span class="p">(</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPENDENCY DE USU√ÅRIO ATIVO: Valida se usu√°rio est√° ativo.</span>
<span class="sd">    </span>
<span class="sd">    REGRA DE NEG√ìCIO: Usu√°rios inativos n√£o podem acessar recursos</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Em produ√ß√£o, verificar status no banco de dados</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">]</span>
    
    <span class="c1"># Simula√ß√£o de verifica√ß√£o de usu√°rio ativo</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_user_active</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Usu√°rio inativo&quot;</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">current_user</span>

<span class="k">def</span><span class="w"> </span><span class="nf">require_roles</span><span class="p">(</span><span class="o">*</span><span class="n">required_roles</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FACTORY DE DEPENDENCY: Cria dependency para verifica√ß√£o de roles.</span>
<span class="sd">    </span>
<span class="sd">    USO:</span>
<span class="sd">    @app.get(&quot;/admin/users&quot;)</span>
<span class="sd">    async def admin_endpoint(user = Depends(require_roles(&quot;admin&quot;))):</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">role_checker</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">user_roles</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;roles&quot;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">role</span> <span class="ow">in</span> <span class="n">user_roles</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">required_roles</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_403_FORBIDDEN</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Acesso negado. Roles requeridas: </span><span class="si">{</span><span class="n">required_roles</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">current_user</span>
    
    <span class="k">return</span> <span class="n">role_checker</span>

<span class="c1"># EXEMPLOS DE USO EM ENDPOINTS</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/auth/login&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="n">LoginRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT DE LOGIN: Autentica usu√°rio e retorna tokens.</span>
<span class="sd">    </span>
<span class="sd">    FLUXO:</span>
<span class="sd">    1. Valida credenciais</span>
<span class="sd">    2. Gera access e refresh tokens</span>
<span class="sd">    3. Retorna tokens + user info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># VALIDA√á√ÉO DE CREDENCIAIS</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">_authenticate_user</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">credentials</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Credenciais inv√°lidas&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># GERA√á√ÉO DE TOKENS</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">)</span>
    
    <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">create_refresh_token</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
        <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>  <span class="c1"># 15 minutos</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
            <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/auth/refresh&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">refresh_access_token</span><span class="p">(</span><span class="n">refresh_request</span><span class="p">:</span> <span class="n">RefreshTokenRequest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT DE REFRESH: Renova access token usando refresh token.</span>
<span class="sd">    </span>
<span class="sd">    SECURITY: Refresh tokens s√£o validados separadamente</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
            <span class="n">refresh_request</span><span class="o">.</span><span class="n">refresh_token</span><span class="p">,</span>
            <span class="n">auth_service</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
            <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="n">auth_service</span><span class="o">.</span><span class="n">algorithm</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;refresh&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Token de refresh inv√°lido&quot;</span>
            <span class="p">)</span>
        
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">_get_user_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
        
        <span class="c1"># GERA√á√ÉO DE NOVO ACCESS TOKEN</span>
        <span class="n">new_access_token</span> <span class="o">=</span> <span class="n">auth_service</span><span class="o">.</span><span class="n">create_access_token</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
                <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;access_token&quot;</span><span class="p">:</span> <span class="n">new_access_token</span><span class="p">,</span>
            <span class="s2">&quot;token_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bearer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;expires_in&quot;</span><span class="p">:</span> <span class="mi">900</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Refresh token inv√°lido ou expirado&quot;</span>
        <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/books/admin&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">admin_books_endpoint</span><span class="p">(</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">require_roles</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;librarian&quot;</span><span class="p">))</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT PROTEGIDO: Requer roles espec√≠ficas.</span>
<span class="sd">    </span>
<span class="sd">    AUTHORIZATION: Apenas admins e bibliotec√°rios podem acessar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Dados administrativos de livros&quot;</span><span class="p">,</span>
        <span class="s2">&quot;accessed_by&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
        <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">]</span>
    <span class="p">}</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/profile&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile</span><span class="p">(</span><span class="n">current_user</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_active_user</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT DE PERFIL: Requer apenas autentica√ß√£o b√°sica.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;sub&quot;</span><span class="p">],</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span>
        <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="n">current_user</span><span class="p">[</span><span class="s2">&quot;roles&quot;</span><span class="p">],</span>
        <span class="s2">&quot;authenticated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="api-keys-e-rate-limiting">
<h4>4.1.2. API Keys e Rate Limiting<a class="headerlink" href="#api-keys-e-rate-limiting" title="Link to this heading">#</a></h4>
<p>Para APIs p√∫blicas ou B2B, API keys combinadas com rate limiting s√£o essenciais:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/rate_limiting.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">redis.asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">redis</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rate Limiter avan√ßado com m√∫ltiplas estrat√©gias.</span>
<span class="sd">    </span>
<span class="sd">    ALGORITMOS IMPLEMENTADOS:</span>
<span class="sd">    - Token Bucket: Para rajadas controladas</span>
<span class="sd">    - Sliding Window: Para distribui√ß√£o uniforme</span>
<span class="sd">    - Fixed Window: Para simplicidade</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONFIGURA√á√ÉO: Permite rate limiting distribu√≠do via Redis.</span>
<span class="sd">        </span>
<span class="sd">        FALLBACK: Se Redis n√£o dispon√≠vel, usa mem√≥ria local</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_windows</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">deque</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">deque</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_buckets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_allowed</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sliding_window&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VERIFICA√á√ÉO DE RATE LIMIT: Determina se requisi√ß√£o √© permitida.</span>
<span class="sd">        </span>
<span class="sd">        RETORNO:</span>
<span class="sd">        - bool: True se permitida</span>
<span class="sd">        - dict: Metadados (remaining, reset_time, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;sliding_window&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sliding_window_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_requests</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;token_bucket&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_bucket_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_requests</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="s2">&quot;fixed_window&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fixed_window_check</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">max_requests</span><span class="p">,</span> <span class="n">window_seconds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Algoritmo n√£o suportado: </span><span class="si">{</span><span class="n">algorithm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sliding_window_check</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
        <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
        <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SLIDING WINDOW: Janela deslizante para distribui√ß√£o uniforme.</span>
<span class="sd">        </span>
<span class="sd">        FUNCIONAMENTO:</span>
<span class="sd">        - Mant√©m timestamps das √∫ltimas requisi√ß√µes</span>
<span class="sd">        - Remove requisi√ß√µes fora da janela</span>
<span class="sd">        - Permite se n√£o exceder limite</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">window_start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">window_seconds</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="p">:</span>
            <span class="c1"># IMPLEMENTA√á√ÉO DISTRIBU√çDA COM REDIS</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
            
            <span class="c1"># Remove requisi√ß√µes antigas</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">zremrangebyscore</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rate_limit:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">window_start</span><span class="p">)</span>
            
            <span class="c1"># Conta requisi√ß√µes na janela atual</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">zcard</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rate_limit:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Adiciona requisi√ß√£o atual</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rate_limit:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">now</span><span class="p">):</span> <span class="n">now</span><span class="p">})</span>
            
            <span class="c1"># Define expira√ß√£o da chave</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rate_limit:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">window_seconds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="n">current_requests</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># IMPLEMENTA√á√ÉO LOCAL (DESENVOLVIMENTO)</span>
            <span class="n">requests_window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_windows</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            
            <span class="c1"># Remove requisi√ß√µes antigas</span>
            <span class="k">while</span> <span class="n">requests_window</span> <span class="ow">and</span> <span class="n">requests_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">window_start</span><span class="p">:</span>
                <span class="n">requests_window</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            
            <span class="n">current_requests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">requests_window</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">current_requests</span> <span class="o">&lt;</span> <span class="n">max_requests</span><span class="p">:</span>
                <span class="n">requests_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        
        <span class="c1"># C√ÅLCULO DE METADADOS</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_requests</span> <span class="o">-</span> <span class="n">current_requests</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">reset_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">window_seconds</span>
        
        <span class="n">is_allowed</span> <span class="o">=</span> <span class="n">current_requests</span> <span class="o">&lt;</span> <span class="n">max_requests</span>
        
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">max_requests</span><span class="p">,</span>
            <span class="s2">&quot;remaining&quot;</span><span class="p">:</span> <span class="n">remaining</span><span class="p">,</span>
            <span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">reset_time</span><span class="p">),</span>
            <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">is_allowed</span> <span class="k">else</span> <span class="n">window_seconds</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">is_allowed</span><span class="p">,</span> <span class="n">metadata</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_token_bucket_check</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">refill_rate_per_second</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TOKEN BUCKET: Permite rajadas at√© o limite do bucket.</span>
<span class="sd">        </span>
<span class="sd">        CONCEITO:</span>
<span class="sd">        - Bucket tem capacidade m√°xima de tokens</span>
<span class="sd">        - Tokens s√£o adicionados continuamente</span>
<span class="sd">        - Cada requisi√ß√£o consome 1 token</span>
<span class="sd">        - Permite rajadas se bucket tem tokens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="p">:</span>
            <span class="c1"># IMPLEMENTA√á√ÉO REDIS COM LUA SCRIPT para atomicidade</span>
            <span class="n">lua_script</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            local key = KEYS[1]</span>
<span class="s2">            local max_tokens = tonumber(ARGV[1])</span>
<span class="s2">            local refill_rate = tonumber(ARGV[2])</span>
<span class="s2">            local now = tonumber(ARGV[3])</span>
<span class="s2">            </span>
<span class="s2">            local bucket = redis.call(&#39;HMGET&#39;, key, &#39;tokens&#39;, &#39;last_refill&#39;)</span>
<span class="s2">            local tokens = tonumber(bucket[1]) or max_tokens</span>
<span class="s2">            local last_refill = tonumber(bucket[2]) or now</span>
<span class="s2">            </span>
<span class="s2">            -- Calcula tokens a adicionar</span>
<span class="s2">            local time_passed = now - last_refill</span>
<span class="s2">            local tokens_to_add = math.floor(time_passed * refill_rate)</span>
<span class="s2">            tokens = math.min(max_tokens, tokens + tokens_to_add)</span>
<span class="s2">            </span>
<span class="s2">            local allowed = tokens &gt; 0</span>
<span class="s2">            if allowed then</span>
<span class="s2">                tokens = tokens - 1</span>
<span class="s2">            end</span>
<span class="s2">            </span>
<span class="s2">            -- Atualiza bucket</span>
<span class="s2">            redis.call(&#39;HMSET&#39;, key, &#39;tokens&#39;, tokens, &#39;last_refill&#39;, now)</span>
<span class="s2">            redis.call(&#39;EXPIRE&#39;, key, 3600)  -- 1 hora</span>
<span class="s2">            </span>
<span class="s2">            return {allowed and 1 or 0, tokens}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
                <span class="n">lua_script</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;bucket:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">max_tokens</span><span class="p">,</span>
                <span class="n">refill_rate_per_second</span><span class="p">,</span>
                <span class="n">now</span>
            <span class="p">)</span>
            
            <span class="n">is_allowed</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">remaining_tokens</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># IMPLEMENTA√á√ÉO LOCAL</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_buckets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="s2">&quot;tokens&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
                <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_tokens</span>
                <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;last_refill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            
            <span class="c1"># REFILL DE TOKENS</span>
            <span class="n">time_passed</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;last_refill&quot;</span><span class="p">]</span>
            <span class="n">tokens_to_add</span> <span class="o">=</span> <span class="n">time_passed</span> <span class="o">*</span> <span class="n">refill_rate_per_second</span>
            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_tokens</span><span class="p">,</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tokens_to_add</span><span class="p">)</span>
            <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;last_refill&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
            
            <span class="c1"># CONSUMO DE TOKEN</span>
            <span class="n">is_allowed</span> <span class="o">=</span> <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">is_allowed</span><span class="p">:</span>
                <span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            
            <span class="n">remaining_tokens</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bucket</span><span class="p">[</span><span class="s2">&quot;tokens&quot;</span><span class="p">])</span>
        
        <span class="c1"># METADADOS</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">max_tokens</span><span class="p">,</span>
            <span class="s2">&quot;remaining&quot;</span><span class="p">:</span> <span class="n">remaining_tokens</span><span class="p">,</span>
            <span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Token bucket n√£o tem reset fixo</span>
            <span class="s2">&quot;retry_after&quot;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">is_allowed</span> <span class="k">else</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">refill_rate_per_second</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">is_allowed</span><span class="p">,</span> <span class="n">metadata</span>

<span class="c1"># DEPENDENCY PARA RATE LIMITING</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_rate_limiter</span><span class="p">(</span>
    <span class="n">max_requests</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">window_seconds</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">algorithm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sliding_window&quot;</span><span class="p">,</span>
    <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FACTORY: Cria dependency de rate limiting customizado.</span>
<span class="sd">    </span>
<span class="sd">    EXEMPLO:</span>
<span class="sd">    @app.get(&quot;/api/books&quot;)</span>
<span class="sd">    async def get_books(</span>
<span class="sd">        request: Request,</span>
<span class="sd">        _: dict = Depends(create_rate_limiter(100, 3600))  # 100/hora</span>
<span class="sd">    ):</span>
<span class="sd">        ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="n">redis_client</span><span class="o">=</span><span class="n">get_redis_client</span><span class="p">())</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_dependency</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
        <span class="c1"># IDENTIFICA√á√ÉO DO CLIENTE</span>
        <span class="k">if</span> <span class="n">key_func</span><span class="p">:</span>
            <span class="n">client_key</span> <span class="o">=</span> <span class="n">key_func</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Padr√£o: IP + User-Agent</span>
            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">host</span>
            <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user-agent&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="n">client_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">user_agent</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># VERIFICA√á√ÉO DE LIMITE</span>
        <span class="n">is_allowed</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="n">rate_limiter</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span>
            <span class="n">client_key</span><span class="p">,</span>
            <span class="n">max_requests</span><span class="p">,</span>
            <span class="n">window_seconds</span><span class="p">,</span>
            <span class="n">algorithm</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_allowed</span><span class="p">:</span>
            <span class="c1"># HEADERS DE RATE LIMITING (padr√£o RFC)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;X-RateLimit-Limit&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;remaining&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;X-RateLimit-Reset&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Retry-After&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;retry_after&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;retry_after&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">}</span>
            
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Rate limit excedido. Tente novamente mais tarde.&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
            <span class="p">)</span>
        
        <span class="c1"># ADICIONA HEADERS INFORMATIVOS</span>
        <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">rate_limit_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        
        <span class="k">return</span> <span class="n">metadata</span>
    
    <span class="k">return</span> <span class="n">rate_limit_dependency</span>

<span class="c1"># MIDDLEWARE PARA ADICIONAR HEADERS DE RATE LIMIT</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">rate_limit_headers_middleware</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MIDDLEWARE: Adiciona headers de rate limiting √†s respostas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    
    <span class="c1"># ADICIONA HEADERS SE METADATA DISPON√çVEL</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;rate_limit_metadata&quot;</span><span class="p">):</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">rate_limit_metadata</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-RateLimit-Limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">])</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-RateLimit-Remaining&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;remaining&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">]:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-RateLimit-Reset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;reset&quot;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># EXEMPLO DE USO COM API KEYS</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/public/books&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">public_books_endpoint</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">validate_api_key</span><span class="p">),</span>
    <span class="n">_</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">create_rate_limiter</span><span class="p">(</span>
        <span class="n">max_requests</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># 1000 requests</span>
        <span class="n">window_seconds</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># por hora</span>
        <span class="n">key_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">req</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;api_key:</span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-API-Key&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;anonymous&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">))</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT P√öBLICO: Protegido por API key e rate limiting.</span>
<span class="sd">    </span>
<span class="sd">    ESTRAT√âGIA:</span>
<span class="sd">    - Rate limiting por API key (n√£o por IP)</span>
<span class="sd">    - Diferentes limites por tier de API key</span>
<span class="sd">    - Monitoramento de uso para billing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;books&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;api_key_tier&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">[</span><span class="s2">&quot;tier&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</section>
</section>
<section id="estrategias-de-resiliencia-e-confiabilidade">
<h3>4.2. Estrat√©gias de Resili√™ncia e Confiabilidade<a class="headerlink" href="#estrategias-de-resiliencia-e-confiabilidade" title="Link to this heading">#</a></h3>
<section id="circuit-breaker-pattern">
<h4>4.2.1. Circuit Breaker Pattern<a class="headerlink" href="#circuit-breaker-pattern" title="Link to this heading">#</a></h4>
<p>O Circuit Breaker protege seu sistema quando servi√ßos externos falham:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/circuit_breaker.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estados do Circuit Breaker.&quot;&quot;&quot;</span>
    <span class="n">CLOSED</span> <span class="o">=</span> <span class="s2">&quot;closed&quot;</span>        <span class="c1"># Funcionamento normal</span>
    <span class="n">OPEN</span> <span class="o">=</span> <span class="s2">&quot;open&quot;</span>           <span class="c1"># Circuito aberto (falhas detectadas)</span>
    <span class="n">HALF_OPEN</span> <span class="o">=</span> <span class="s2">&quot;half_open&quot;</span> <span class="c1"># Teste de recupera√ß√£o</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configura√ß√£o do Circuit Breaker.&quot;&quot;&quot;</span>
    <span class="n">failure_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>          <span class="c1"># Falhas para abrir circuito</span>
    <span class="n">recovery_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>          <span class="c1"># Segundos para tentar recupera√ß√£o</span>
    <span class="n">success_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>          <span class="c1"># Sucessos para fechar circuito</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span>              <span class="c1"># Timeout para opera√ß√µes</span>
    <span class="n">expected_exception</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="ne">Exception</span> <span class="c1"># Tipo de exce√ß√£o que conta como falha</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerStats</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estat√≠sticas do Circuit Breaker.&quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">record_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registra opera√ß√£o bem-sucedida.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_request</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">record_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Registra falha de opera√ß√£o.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_request</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_failure_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adiciona requisi√ß√£o √† janela deslizante.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
            <span class="c1"># Remove requisi√ß√£o mais antiga</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">success_count</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">failure_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Taxa de falha na janela atual.&quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">/</span> <span class="n">total</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total de requisi√ß√µes na janela.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Circuit Breaker para prote√ß√£o contra falhas em cascata.</span>
<span class="sd">    </span>
<span class="sd">    FUNCIONAMENTO:</span>
<span class="sd">    1. CLOSED: Requisi√ß√µes passam normalmente</span>
<span class="sd">    2. OPEN: Requisi√ß√µes falham imediatamente</span>
<span class="sd">    3. HALF_OPEN: Testa recupera√ß√£o com requisi√ß√µes limitadas</span>
<span class="sd">    </span>
<span class="sd">    BENEF√çCIOS:</span>
<span class="sd">    - Evita sobrecarga em servi√ßos com falha</span>
<span class="sd">    - Recupera√ß√£o autom√°tica</span>
<span class="sd">    - M√©tricas detalhadas</span>
<span class="sd">    - Fallback configur√°vel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">CircuitBreakerConfig</span><span class="p">,</span>
        <span class="n">fallback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">fallback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">CircuitBreakerStats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EXECU√á√ÉO PROTEGIDA: Executa fun√ß√£o com prote√ß√£o do circuit breaker.</span>
<span class="sd">        </span>
<span class="sd">        FLUXO:</span>
<span class="sd">        1. Verifica estado do circuito</span>
<span class="sd">        2. Executa fun√ß√£o se permitido</span>
<span class="sd">        3. Atualiza estat√≠sticas</span>
<span class="sd">        4. Transiciona estado se necess√°rio</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_state_transition</span><span class="p">()</span>
            
            <span class="c1"># CIRCUITO ABERTO: Falha imediata</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is OPEN - request rejected&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_fallback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CircuitBreakerOpenException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> is open&quot;</span><span class="p">)</span>
            
            <span class="c1"># EXECU√á√ÉO DA FUN√á√ÉO</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>
                
                <span class="c1"># SUCESSO: Atualiza estat√≠sticas</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_success</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span>
                
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">expected_exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># FALHA ESPERADA: Atualiza estat√≠sticas</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_failure</span><span class="p">()</span>
                <span class="k">raise</span>
            
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                <span class="c1"># TIMEOUT: Tratado como falha</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_failure</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">CircuitBreakerTimeoutException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Operation timed out after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span>
                <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_state_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        M√ÅQUINA DE ESTADOS: Gerencia transi√ß√µes entre estados.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="c1"># TENTATIVA DE RECUPERA√á√ÉO</span>
            <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recovery_timeout</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: OPEN -&gt; HALF_OPEN&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">=</span> <span class="n">now</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
            <span class="c1"># VERIFICA√á√ÉO DE FALHAS</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">failure_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">failure_threshold</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">total_requests</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">failure_threshold</span><span class="p">):</span>
                
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: CLOSED -&gt; OPEN &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(failure rate: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">failure_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">=</span> <span class="n">now</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_on_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TRATAMENTO DE SUCESSO: Atualiza estado e estat√≠sticas.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">record_success</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># RECUPERA√á√ÉO COMPLETA</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">success_threshold</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: HALF_OPEN -&gt; CLOSED&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TRATAMENTO DE FALHA: Atualiza estado e estat√≠sticas.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">HALF_OPEN</span><span class="p">:</span>
            <span class="c1"># FALHA DURANTE TESTE: Volta para OPEN</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: HALF_OPEN -&gt; OPEN&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">half_open_success_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;EXECU√á√ÉO DE FALLBACK: Fun√ß√£o alternativa quando circuito aberto.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fallback failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;M√âTRICAS: Retorna estat√≠sticas atuais do circuit breaker.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;failure_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">failure_rate</span><span class="p">,</span>
            <span class="s2">&quot;failure_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">failure_count</span><span class="p">,</span>
            <span class="s2">&quot;success_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">success_count</span><span class="p">,</span>
            <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">total_requests</span><span class="p">,</span>
            <span class="s2">&quot;last_state_change&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_state_change</span><span class="p">,</span>
            <span class="s2">&quot;last_failure_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">last_failure_time</span>
        <span class="p">}</span>

<span class="c1"># EXCE√á√ïES CUSTOMIZADAS</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o base para circuit breaker.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerOpenException</span><span class="p">(</span><span class="n">CircuitBreakerException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o quando circuito est√° aberto.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CircuitBreakerTimeoutException</span><span class="p">(</span><span class="n">CircuitBreakerException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exce√ß√£o de timeout.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="c1"># IMPLEMENTA√á√ÉO PR√ÅTICA COM APIs EXTERNAS</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ResilientBookEnrichmentService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Servi√ßo de enriquecimento com circuit breakers para cada API externa.</span>
<span class="sd">    </span>
<span class="sd">    ESTRAT√âGIA:</span>
<span class="sd">    - Circuit breaker separado para cada API</span>
<span class="sd">    - Fallbacks diferentes por API</span>
<span class="sd">    - M√©tricas agregadas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
        
        <span class="c1"># CIRCUIT BREAKERS POR API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">google_books_cb</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;google_books&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">CircuitBreakerConfig</span><span class="p">(</span>
                <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">recovery_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                <span class="n">expected_exception</span><span class="o">=</span><span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">fallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_google_books_fallback</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">openlibrary_cb</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;openlibrary&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">CircuitBreakerConfig</span><span class="p">(</span>
                <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">recovery_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
                <span class="n">expected_exception</span><span class="o">=</span><span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">fallback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_openlibrary_fallback</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">enrich_book_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ENRIQUECIMENTO RESILIENTE: Usa circuit breakers para cada API.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIA:</span>
<span class="sd">        - Executa APIs em paralelo com prote√ß√£o</span>
<span class="sd">        - Combina resultados dispon√≠veis</span>
<span class="sd">        - Falha gracefully se todas as APIs estiverem indispon√≠veis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># GOOGLE BOOKS COM CIRCUIT BREAKER</span>
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">google_books_cb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_google_books</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># OPENLIBRARY COM CIRCUIT BREAKER</span>
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">openlibrary_cb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_openlibrary</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># EXECU√á√ÉO PARALELA COM TRATAMENTO DE ERROS</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CircuitBreakerOpenException</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Circuit breaker open - skipping API call&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API call failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># CONSOLIDA√á√ÉO DE RESULTADOS</span>
        <span class="n">consolidated</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">consolidated</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">consolidated</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_google_books</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Busca dados na API Google Books.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.googleapis.com/books/v1/volumes&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;isbn:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;totalItems&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">book_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;volumeInfo&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
                <span class="s2">&quot;authors&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
                <span class="s2">&quot;cover_url&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imageLinks&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thumbnail&quot;</span><span class="p">),</span>
                <span class="s2">&quot;page_count&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pageCount&quot;</span><span class="p">),</span>
                <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">),</span>
                <span class="s2">&quot;published_date&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publishedDate&quot;</span><span class="p">),</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;google_books&quot;</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_openlibrary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Busca dados na API OpenLibrary.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://openlibrary.org/api/books&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bibkeys&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ISBN:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;jscmd&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span>
        <span class="p">}</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">isbn_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ISBN:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="k">if</span> <span class="n">isbn_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">book_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">isbn_key</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
                <span class="s2">&quot;authors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">author</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="p">[])],</span>
                <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publishers&quot;</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
                <span class="s2">&quot;publish_date&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publish_date&quot;</span><span class="p">),</span>
                <span class="s2">&quot;subjects&quot;</span><span class="p">:</span> <span class="n">book_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subjects&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;openlibrary&quot;</span>
            <span class="p">}</span>
        
        <span class="k">return</span> <span class="p">{}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_google_books_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback para Google Books API.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Livro ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Informa√ß√µes n√£o dispon√≠veis temporariamente&quot;</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_google&quot;</span>
        <span class="p">}</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_openlibrary_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback para OpenLibrary API.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Literatura&quot;</span><span class="p">],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;fallback_openlibrary&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_circuit_breaker_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;M√âTRICAS: Estat√≠sticas de todos os circuit breakers.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;google_books&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">google_books_cb</span><span class="o">.</span><span class="n">get_stats</span><span class="p">(),</span>
            <span class="s2">&quot;openlibrary&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openlibrary_cb</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>
        <span class="p">}</span>

<span class="c1"># ENDPOINT PARA MONITORAMENTO</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health/circuit-breakers&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">circuit_breaker_health</span><span class="p">(</span>
    <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">ResilientBookEnrichmentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">()</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    HEALTH CHECK: Estado dos circuit breakers.</span>
<span class="sd">    </span>
<span class="sd">    USO: Monitoramento e alertas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">enrichment_service</span><span class="o">.</span><span class="n">get_circuit_breaker_stats</span><span class="p">()</span>
    
    <span class="c1"># C√ÅLCULO DE STATUS GERAL</span>
    <span class="n">all_healthy</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">cb</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;closed&quot;</span> 
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span> <span class="k">if</span> <span class="n">all_healthy</span> <span class="k">else</span> <span class="s2">&quot;degraded&quot;</span><span class="p">,</span>
        <span class="s2">&quot;circuit_breakers&quot;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bulk-operations-e-otimizacao-de-performance">
<h4>4.2.2. Bulk Operations e Otimiza√ß√£o de Performance<a class="headerlink" href="#bulk-operations-e-otimizacao-de-performance" title="Link to this heading">#</a></h4>
<p>Para aplica√ß√µes de produ√ß√£o, opera√ß√µes em lote s√£o essenciais para efici√™ncia:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/routers/bulk_operations.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">BackgroundTasks</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/bulk&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bulk&quot;</span><span class="p">])</span>

<span class="c1"># MODELOS PARA OPERA√á√ïES EM LOTE</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BulkBookCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modelo para cria√ß√£o em lote de livros.&quot;&quot;&quot;</span>
    <span class="n">books</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BookCreate</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">enrichment_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Enriquecer dados via APIs externas&quot;</span><span class="p">)</span>
    <span class="n">parallel_processing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Processamento paralelo&quot;</span><span class="p">)</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;books&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_unique_isbns</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Valida que ISBNs s√£o √∫nicos no lote.&quot;&quot;&quot;</span>
        <span class="n">isbns</span> <span class="o">=</span> <span class="p">[</span><span class="n">book</span><span class="o">.</span><span class="n">isbn</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">isbn</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">isbns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">isbns</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ISBNs duplicados encontrados no lote&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BulkBookUpdate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Modelo para atualiza√ß√£o em lote.&quot;&quot;&quot;</span>
    <span class="n">updates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    
    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;updates&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_updates</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Valida formato das atualiza√ß√µes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cada atualiza√ß√£o deve conter &#39;id&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">update</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># id + pelo menos um campo</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cada atualiza√ß√£o deve conter pelo menos um campo para alterar&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BulkOperationResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resultado de opera√ß√£o em lote.&quot;&quot;&quot;</span>
    <span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">total_items</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">successful_items</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">failed_items</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">processing_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">items_per_second</span><span class="p">:</span> <span class="nb">float</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BulkOperationService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Servi√ßo para opera√ß√µes em lote otimizadas.</span>
<span class="sd">    </span>
<span class="sd">    OTIMIZA√á√ïES IMPLEMENTADAS:</span>
<span class="sd">    - Processamento paralelo com asyncio</span>
<span class="sd">    - Chunking para controle de mem√≥ria</span>
<span class="sd">    - Progress tracking para opera√ß√µes longas</span>
<span class="sd">    - Error collection sem interrup√ß√£o</span>
<span class="sd">    - Rate limiting autom√°tico</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span> <span class="o">=</span> <span class="n">max_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_operations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_pool</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_create_books</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bulk_request</span><span class="p">:</span> <span class="n">BulkBookCreate</span><span class="p">,</span>
        <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BulkOperationResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CRIA√á√ÉO EM LOTE: Processamento paralelo otimizado.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIAS:</span>
<span class="sd">        1. Chunking para controle de mem√≥ria</span>
<span class="sd">        2. Sem√°foro para controle de concorr√™ncia</span>
<span class="sd">        3. Coleta de erros sem interrup√ß√£o</span>
<span class="sd">        4. Progress tracking</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">bulk_request</span><span class="o">.</span><span class="n">books</span>
        
        <span class="c1"># INICIALIZA√á√ÉO DE TRACKING</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_operations</span><span class="p">[</span><span class="n">operation_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;processing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">),</span>
            <span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="n">start_time</span>
        <span class="p">}</span>
        
        <span class="n">successful_books</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># PROCESSAMENTO EM CHUNKS</span>
        <span class="k">for</span> <span class="n">chunk_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">chunk_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunk_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">books</span><span class="p">[</span><span class="n">chunk_start</span><span class="p">:</span><span class="n">chunk_end</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">bulk_request</span><span class="o">.</span><span class="n">parallel_processing</span><span class="p">:</span>
                <span class="c1"># PROCESSAMENTO PARALELO DO CHUNK</span>
                <span class="n">chunk_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_chunk_parallel</span><span class="p">(</span>
                    <span class="n">chunk</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">,</span> <span class="n">bulk_request</span><span class="o">.</span><span class="n">enrichment_enabled</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># PROCESSAMENTO SEQUENCIAL (PARA DEBUGGING)</span>
                <span class="n">chunk_results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_chunk_sequential</span><span class="p">(</span>
                    <span class="n">chunk</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">,</span> <span class="n">bulk_request</span><span class="o">.</span><span class="n">enrichment_enabled</span>
                <span class="p">)</span>
            
            <span class="c1"># CONSOLIDA√á√ÉO DE RESULTADOS</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">chunk_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
                    <span class="n">successful_books</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;book&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
            
            <span class="c1"># UPDATE PROGRESS</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_operations</span><span class="p">[</span><span class="n">operation_id</span><span class="p">][</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk_end</span>
            
            <span class="c1"># PAUSA PARA EVITAR SOBRECARGA</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        
        <span class="c1"># C√ÅLCULOS FINAIS</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">processing_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">)</span>
        <span class="n">successful_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_books</span><span class="p">)</span>
        <span class="n">failed_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
        <span class="n">items_per_second</span> <span class="o">=</span> <span class="n">total_items</span> <span class="o">/</span> <span class="n">processing_time</span> <span class="k">if</span> <span class="n">processing_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="c1"># CLEANUP</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_operations</span><span class="p">[</span><span class="n">operation_id</span><span class="p">]</span>
        
        <span class="c1"># PERSIST√äNCIA DOS LIVROS CRIADOS</span>
        <span class="k">global</span> <span class="n">books_db</span>
        <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">successful_books</span><span class="p">:</span>
            <span class="n">books_db</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Bulk create completed: </span><span class="si">{</span><span class="n">successful_items</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_items</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;successful in </span><span class="si">{</span><span class="n">processing_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s (</span><span class="si">{</span><span class="n">items_per_second</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> items/s)&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">BulkOperationResult</span><span class="p">(</span>
            <span class="n">operation_id</span><span class="o">=</span><span class="n">operation_id</span><span class="p">,</span>
            <span class="n">total_items</span><span class="o">=</span><span class="n">total_items</span><span class="p">,</span>
            <span class="n">successful_items</span><span class="o">=</span><span class="n">successful_items</span><span class="p">,</span>
            <span class="n">failed_items</span><span class="o">=</span><span class="n">failed_items</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">processing_time</span><span class="o">=</span><span class="n">processing_time</span><span class="p">,</span>
            <span class="n">items_per_second</span><span class="o">=</span><span class="n">items_per_second</span>
        <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_chunk_parallel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chunk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BookCreate</span><span class="p">],</span>
        <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span><span class="p">,</span>
        <span class="n">enrichment_enabled</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PROCESSAMENTO PARALELO: Usa sem√°foro para controle de concorr√™ncia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_workers</span><span class="p">)</span>
        
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_single_book</span><span class="p">(</span><span class="n">book_data</span><span class="p">:</span> <span class="n">BookCreate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_single_book</span><span class="p">(</span>
                        <span class="n">book_data</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">,</span> <span class="n">enrichment_enabled</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">book_data</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                            <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
        
        <span class="c1"># EXECU√á√ÉO PARALELA</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_single_book</span><span class="p">(</span><span class="n">book</span><span class="p">)</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">]</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_chunk_sequential</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chunk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BookCreate</span><span class="p">],</span>
        <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span><span class="p">,</span>
        <span class="n">enrichment_enabled</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PROCESSAMENTO SEQUENCIAL: Para debugging ou APIs com rate limiting rigoroso.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">book_data</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_single_book</span><span class="p">(</span>
                    <span class="n">book_data</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">,</span> <span class="n">enrichment_enabled</span>
                <span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">book_data</span><span class="o">.</span><span class="n">dict</span><span class="p">(),</span>
                        <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                        <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            
            <span class="c1"># Rate limiting interno</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create_single_book</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">book_data</span><span class="p">:</span> <span class="n">BookCreate</span><span class="p">,</span>
        <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span><span class="p">,</span>
        <span class="n">enrichment_enabled</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CRIA√á√ÉO INDIVIDUAL: L√≥gica de cria√ß√£o de um livro com enriquecimento.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">next_book_id</span>
        
        <span class="c1"># VALIDA√á√ÉO DE NEG√ìCIO</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_author_exists</span><span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">author_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Autor </span><span class="si">{</span><span class="n">book_data</span><span class="o">.</span><span class="n">author_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span><span class="p">)</span>
        
        <span class="c1"># ENRIQUECIMENTO OPCIONAL</span>
        <span class="n">enriched_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">enrichment_enabled</span> <span class="ow">and</span> <span class="n">book_data</span><span class="o">.</span><span class="n">isbn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">enriched_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">enrichment_service</span><span class="o">.</span><span class="n">enrich_book_data</span><span class="p">(</span>
                    <span class="n">book_data</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">book_data</span><span class="o">.</span><span class="n">isbn</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enrichment failed for </span><span class="si">{</span><span class="n">book_data</span><span class="o">.</span><span class="n">isbn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># CRIA√á√ÉO DO LIVRO</span>
        <span class="n">new_book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">next_book_id</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">isbn</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">isbn</span><span class="p">,</span>
            <span class="n">author_id</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">author_id</span><span class="p">,</span>
            <span class="n">publication_year</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">publication_year</span><span class="p">,</span>
            <span class="n">pages</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span>
            <span class="n">genre</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">genre</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">book_data</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">(),</span>
            <span class="n">external_rating</span><span class="o">=</span><span class="n">enriched_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
            <span class="n">cover_url</span><span class="o">=</span><span class="n">enriched_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cover_url&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">next_book_id</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="n">new_book</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_operation_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;TRACKING: Status de opera√ß√£o em andamento.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">operation_id</span><span class="p">)</span>

<span class="c1"># INST√ÇNCIA DO SERVI√áO</span>
<span class="n">bulk_service</span> <span class="o">=</span> <span class="n">BulkOperationService</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/books&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_create_books</span><span class="p">(</span>
    <span class="n">bulk_request</span><span class="p">:</span> <span class="n">BulkBookCreate</span><span class="p">,</span>
    <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
    <span class="n">enrichment_service</span><span class="p">:</span> <span class="n">BookEnrichmentService</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_enrichment_service</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENDPOINT DE CRIA√á√ÉO EM LOTE: Processa m√∫ltiplos livros.</span>
<span class="sd">    </span>
<span class="sd">    CARACTER√çSTICAS:</span>
<span class="sd">    - Valida√ß√£o de lote antes do processamento</span>
<span class="sd">    - Processamento paralelo otimizado</span>
<span class="sd">    - Progress tracking para opera√ß√µes longas</span>
<span class="sd">    - Error collection detalhada</span>
<span class="sd">    - Rate limiting autom√°tico</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># VALIDA√á√ÉO PR√âVIA</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bulk_request</span><span class="o">.</span><span class="n">books</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_413_REQUEST_ENTITY_TOO_LARGE</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;M√°ximo 1000 livros por lote&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># EXECU√á√ÉO DA OPERA√á√ÉO</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bulk_service</span><span class="o">.</span><span class="n">bulk_create_books</span><span class="p">(</span><span class="n">bulk_request</span><span class="p">,</span> <span class="n">enrichment_service</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Processamento conclu√≠do: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">successful_items</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">total_items</span><span class="si">}</span><span class="s2"> livros criados&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operation_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">operation_id</span><span class="p">,</span>
            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;total_items&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">total_items</span><span class="p">,</span>
                <span class="s2">&quot;successful_items&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">successful_items</span><span class="p">,</span>
                <span class="s2">&quot;failed_items&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">failed_items</span><span class="p">,</span>
                <span class="s2">&quot;processing_time_seconds&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">processing_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;items_per_second&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items_per_second</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>  <span class="c1"># Primeiros 10 erros apenas</span>
            <span class="s2">&quot;has_more_errors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bulk operation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Falha no processamento em lote&quot;</span>
        <span class="p">)</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;/books&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_update_books</span><span class="p">(</span><span class="n">bulk_update</span><span class="p">:</span> <span class="n">BulkBookUpdate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ATUALIZA√á√ÉO EM LOTE: Atualiza m√∫ltiplos livros de forma otimizada.</span>
<span class="sd">    </span>
<span class="sd">    ESTRAT√âGIA:</span>
<span class="sd">    - Valida√ß√£o pr√©via de exist√™ncia</span>
<span class="sd">    - Agrupamento por tipo de atualiza√ß√£o</span>
<span class="sd">    - Rollback em caso de falha cr√≠tica</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">successful_updates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_updates</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># VALIDA√á√ÉO DE EXIST√äNCIA EM LOTE</span>
    <span class="n">book_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">bulk_update</span><span class="o">.</span><span class="n">updates</span><span class="p">]</span>
    <span class="n">existing_books</span> <span class="o">=</span> <span class="p">{</span><span class="n">book</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">book</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">books_db</span> <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">book_ids</span><span class="p">}</span>
    
    <span class="k">for</span> <span class="n">update_data</span> <span class="ow">in</span> <span class="n">bulk_update</span><span class="o">.</span><span class="n">updates</span><span class="p">:</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="n">update_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># VERIFICA√á√ÉO DE EXIST√äNCIA</span>
            <span class="k">if</span> <span class="n">book_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_books</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Livro </span><span class="si">{</span><span class="n">book_id</span><span class="si">}</span><span class="s2"> n√£o encontrado&quot;</span><span class="p">)</span>
            
            <span class="c1"># APLICA√á√ÉO DA ATUALIZA√á√ÉO</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">existing_books</span><span class="p">[</span><span class="n">book_id</span><span class="p">]</span>
            <span class="n">update_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">update_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">}</span>
            
            <span class="c1"># VALIDA√á√ÉO DE CAMPOS</span>
            <span class="n">valid_book_update</span> <span class="o">=</span> <span class="n">BookUpdate</span><span class="p">(</span><span class="o">**</span><span class="n">update_fields</span><span class="p">)</span>
            
            <span class="c1"># ATUALIZA√á√ÉO EFETIVA</span>
            <span class="n">book_dict</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
            <span class="n">book_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">valid_book_update</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">exclude_unset</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">book_dict</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            
            <span class="n">updated_book</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="o">**</span><span class="n">book_dict</span><span class="p">)</span>
            
            <span class="c1"># SUBSTITUI√á√ÉO NO &quot;BANCO&quot;</span>
            <span class="n">book_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">books_db</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">book_id</span><span class="p">)</span>
            <span class="n">books_db</span><span class="p">[</span><span class="n">book_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_book</span>
            
            <span class="n">successful_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">failed_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;book_id&quot;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">})</span>
    
    <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Atualiza√ß√£o em lote conclu√≠da: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_updates</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bulk_update</span><span class="o">.</span><span class="n">updates</span><span class="p">)</span><span class="si">}</span><span class="s2"> atualiza√ß√µes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;total_updates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">bulk_update</span><span class="o">.</span><span class="n">updates</span><span class="p">),</span>
            <span class="s2">&quot;successful_updates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_updates</span><span class="p">),</span>
            <span class="s2">&quot;failed_updates&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_updates</span><span class="p">),</span>
            <span class="s2">&quot;processing_time_seconds&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">processing_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="s2">&quot;successful_ids&quot;</span><span class="p">:</span> <span class="n">successful_updates</span><span class="p">,</span>
        <span class="s2">&quot;failed_updates&quot;</span><span class="p">:</span> <span class="n">failed_updates</span>
    <span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/books&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_delete_books</span><span class="p">(</span><span class="n">book_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_items</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_items</span><span class="o">=</span><span class="mi">100</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DELE√á√ÉO EM LOTE: Remove m√∫ltiplos livros com valida√ß√£o de regras de neg√≥cio.</span>
<span class="sd">    </span>
<span class="sd">    VALIDA√á√ïES:</span>
<span class="sd">    - Livros existem</span>
<span class="sd">    - Livros n√£o est√£o emprestados</span>
<span class="sd">    - Limite de quantidade por opera√ß√£o</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">book_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_413_REQUEST_ENTITY_TOO_LARGE</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;M√°ximo 100 livros por opera√ß√£o de dele√ß√£o&quot;</span>
        <span class="p">)</span>
    
    <span class="n">successful_deletions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_deletions</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">book_id</span> <span class="ow">in</span> <span class="n">book_ids</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">_find_book_by_id</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">book</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Livro n√£o encontrado&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">book</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">BookStatus</span><span class="o">.</span><span class="n">BORROWED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;N√£o √© poss√≠vel deletar livro emprestado&quot;</span><span class="p">)</span>
            
            <span class="c1"># REMO√á√ÉO</span>
            <span class="k">global</span> <span class="n">books_db</span>
            <span class="n">books_db</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">books_db</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">book_id</span><span class="p">]</span>
            <span class="n">successful_deletions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">failed_deletions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;book_id&quot;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">})</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Dele√ß√£o em lote conclu√≠da: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_deletions</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">book_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> livros removidos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;successful_deletions&quot;</span><span class="p">:</span> <span class="n">successful_deletions</span><span class="p">,</span>
        <span class="s2">&quot;failed_deletions&quot;</span><span class="p">:</span> <span class="n">failed_deletions</span>
    <span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/operations/</span><span class="si">{operation_id}</span><span class="s2">/status&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_operation_status</span><span class="p">(</span><span class="n">operation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TRACKING DE OPERA√á√ÉO: Status de opera√ß√£o em lote em andamento.</span>
<span class="sd">    </span>
<span class="sd">    USO: Polling para opera√ß√µes longas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status_info</span> <span class="o">=</span> <span class="n">bulk_service</span><span class="o">.</span><span class="n">get_operation_status</span><span class="p">(</span><span class="n">operation_id</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">status_info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Opera√ß√£o n√£o encontrada&quot;</span>
        <span class="p">)</span>
    
    <span class="c1"># C√ÅLCULO DE PROGRESSO</span>
    <span class="n">progress_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">estimated_total_time</span> <span class="o">=</span> <span class="n">elapsed_time</span> <span class="o">*</span> <span class="p">(</span><span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">])</span>
        <span class="n">remaining_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">estimated_total_time</span> <span class="o">-</span> <span class="n">elapsed_time</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">remaining_time</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;operation_id&quot;</span><span class="p">:</span> <span class="n">operation_id</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span>
        <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;total_items&quot;</span><span class="p">:</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
            <span class="s2">&quot;processed_items&quot;</span><span class="p">:</span> <span class="n">status_info</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">],</span>
            <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">progress_percentage</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;elapsed_time_seconds&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;estimated_remaining_seconds&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">remaining_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">remaining_time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="caching-strategies-avancadas">
<h4>4.2.3. Caching Strategies Avan√ßadas<a class="headerlink" href="#caching-strategies-avancadas" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/advanced_caching.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CacheStrategy</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estrat√©gias de cache dispon√≠veis.&quot;&quot;&quot;</span>
    <span class="n">LRU</span> <span class="o">=</span> <span class="s2">&quot;lru&quot;</span>                    <span class="c1"># Least Recently Used</span>
    <span class="n">LFU</span> <span class="o">=</span> <span class="s2">&quot;lfu&quot;</span>                    <span class="c1"># Least Frequently Used</span>
    <span class="n">TTL</span> <span class="o">=</span> <span class="s2">&quot;ttl&quot;</span>                    <span class="c1"># Time To Live</span>
    <span class="n">WRITE_THROUGH</span> <span class="o">=</span> <span class="s2">&quot;write_through&quot;</span> <span class="c1"># Write-through cache</span>
    <span class="n">WRITE_BEHIND</span> <span class="o">=</span> <span class="s2">&quot;write_behind&quot;</span>   <span class="c1"># Write-behind cache</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CacheEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entrada de cache com metadados.&quot;&quot;&quot;</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">accessed_at</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">access_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifica se entrada est√° expirada.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttl</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SmartCacheManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gerenciador de cache inteligente com m√∫ltiplas estrat√©gias.</span>
<span class="sd">    </span>
<span class="sd">    FUNCIONALIDADES:</span>
<span class="sd">    - M√∫ltiplas estrat√©gias de eviction</span>
<span class="sd">    - Cache warming autom√°tico</span>
<span class="sd">    - Invalida√ß√£o inteligente</span>
<span class="sd">    - M√©tricas detalhadas</span>
<span class="sd">    - Compression autom√°tica</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">default_ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">CacheStrategy</span> <span class="o">=</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LRU</span><span class="p">,</span>
        <span class="n">enable_compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_ttl</span> <span class="o">=</span> <span class="n">default_ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_compression</span> <span class="o">=</span> <span class="n">enable_compression</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CacheEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Para LRU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Para LFU</span>
        
        <span class="c1"># M√âTRICAS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compressions</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RECUPERA√á√ÉO INTELIGENTE: Busca com update de metadados.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache miss: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># VERIFICA√á√ÉO DE EXPIRA√á√ÉO</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">misses</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache expired: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># UPDATE DE METADADOS</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">accessed_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">access_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># UPDATE DE ORDEM DE ACESSO (LRU)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LRU</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="c1"># UPDATE DE FREQU√äNCIA (LFU)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LFU</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache hit: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decompress_if_needed</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ARMAZENAMENTO INTELIGENTE: Salva com compress√£o e eviction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># VERIFICA√á√ÉO DE ESPA√áO</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evict_entries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For√ßa remo√ß√£o mesmo se cache cheio</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evict_entries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># COMPRESS√ÉO AUTOM√ÅTICA</span>
        <span class="n">compressed_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compress_if_needed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># CRIA√á√ÉO DA ENTRADA</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">CacheEntry</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">compressed_value</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">accessed_at</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">access_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_ttl</span>
        <span class="p">)</span>
        
        <span class="c1"># ARMAZENAMENTO</span>
        <span class="n">was_update</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
        
        <span class="c1"># UPDATE DE ESTRUTURAS DE CONTROLE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LRU</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LFU</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">was_update</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache set: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> (TTL: </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">ttl</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;REMO√á√ÉO: Remove entrada e cleanup de metadados.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="c1"># CLEANUP DE ESTRUTURAS</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache delete: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_evict_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EVICTION INTELIGENTE: Remove entradas baseado na estrat√©gia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LRU</span><span class="p">:</span>
            <span class="c1"># Remove menos recentemente usados</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">))):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="p">:</span>
                    <span class="n">oldest_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_order</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">oldest_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LFU</span><span class="p">:</span>
            <span class="c1"># Remove menos frequentemente usados</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">:</span>
                <span class="n">sorted_by_freq</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sorted_by_freq</span><span class="p">[:</span><span class="n">count</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">CacheStrategy</span><span class="o">.</span><span class="n">TTL</span><span class="p">:</span>
            <span class="c1"># Remove expirados primeiro, depois mais antigos</span>
            <span class="n">expired_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span>
            <span class="p">]</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expired_keys</span><span class="p">[:</span><span class="n">count</span><span class="p">]:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Se ainda precisa remover mais, remove mais antigos</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">oldest_entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">created_at</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">oldest_entries</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_compress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;COMPRESS√ÉO: Comprime valores grandes automaticamente.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_compression</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        
        <span class="c1"># Serializa para verificar tamanho</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        
        <span class="c1"># Comprime se maior que 1KB</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compressions</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressed value: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;_compressed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;_data&quot;</span><span class="p">:</span> <span class="n">compressed</span><span class="p">}</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_decompress_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DESCOMPRESS√ÉO: Descomprime valores automaticamente.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_compressed&quot;</span><span class="p">):</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
            <span class="n">decompressed_data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;_data&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decompressed_data</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">value</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;LIMPEZA: Remove entradas expiradas.&quot;&quot;&quot;</span>
        <span class="n">expired_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expired_keys</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned up </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">expired_keys</span><span class="p">)</span><span class="si">}</span><span class="s2"> expired cache entries&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;M√âTRICAS: Estat√≠sticas detalhadas do cache.&quot;&quot;&quot;</span>
        <span class="n">total_requests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">misses</span>
        <span class="n">hit_rate</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span> <span class="o">/</span> <span class="n">total_requests</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_requests</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">),</span>
            <span class="s2">&quot;max_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">,</span>
            <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">,</span>
            <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">misses</span><span class="p">,</span>
            <span class="s2">&quot;hit_rate_percentage&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">hit_rate</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;evictions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">evictions</span><span class="p">,</span>
            <span class="s2">&quot;compressions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressions</span><span class="p">,</span>
            <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s2">&quot;memory_usage_estimate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_memory_usage</span><span class="p">()</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_memory_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ESTIMATIVA: Calcula uso aproximado de mem√≥ria.&quot;&quot;&quot;</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="n">size</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">total_size</span> <span class="o">+=</span> <span class="mi">1024</span>  <span class="c1"># Estimativa padr√£o</span>
        
        <span class="c1"># Converte para formato leg√≠vel</span>
        <span class="k">if</span> <span class="n">total_size</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2"> B&quot;</span>
        <span class="k">elif</span> <span class="n">total_size</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> KB&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MB&quot;</span>

<span class="c1"># DECORATOR PARA CACHE AUTOM√ÅTICO</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cached</span><span class="p">(</span>
    <span class="n">key_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cache_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SmartCacheManager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DECORATOR DE CACHE: Automatiza cache de fun√ß√µes.</span>
<span class="sd">    </span>
<span class="sd">    EXEMPLO:</span>
<span class="sd">    @cached(key_func=lambda title, isbn: f&quot;book:{isbn}&quot;, ttl=3600)</span>
<span class="sd">    async def get_book_details(title: str, isbn: str):</span>
<span class="sd">        # Fun√ß√£o cara que busca em APIs externas</span>
<span class="sd">        return expensive_api_call(title, isbn)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># USA CACHE MANAGER GLOBAL SE N√ÉO FORNECIDO</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">cache_manager</span> <span class="ow">or</span> <span class="n">global_cache_manager</span>
            
            <span class="c1"># GERA√á√ÉO DE CHAVE</span>
            <span class="k">if</span> <span class="n">key_func</span><span class="p">:</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="n">key_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Chave padr√£o baseada em nome da fun√ß√£o e argumentos</span>
                <span class="n">args_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">kwargs_str</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">args_str</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">kwargs_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># Hash para evitar chaves muito longas</span>
                <span class="n">cache_key</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">cache_key</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            
            <span class="c1"># TENTATIVA DE CACHE</span>
            <span class="n">cached_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cached_result</span>
            
            <span class="c1"># EXECU√á√ÉO DA FUN√á√ÉO</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="c1"># ARMAZENAMENTO EM CACHE</span>
            <span class="k">await</span> <span class="n">cm</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="c1"># INST√ÇNCIA GLOBAL</span>
<span class="n">global_cache_manager</span> <span class="o">=</span> <span class="n">SmartCacheManager</span><span class="p">(</span>
    <span class="n">max_size</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
    <span class="n">default_ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="n">CacheStrategy</span><span class="o">.</span><span class="n">LRU</span><span class="p">,</span>
    <span class="n">enable_compression</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># EXEMPLO DE USO</span>
<span class="nd">@cached</span><span class="p">(</span>
    <span class="n">key_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">isbn</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;enrichment:</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="n">ttl</span><span class="o">=</span><span class="mi">7200</span>  <span class="c1"># 2 horas</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cached_book_enrichment</span><span class="p">(</span><span class="n">isbn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ENRIQUECIMENTO COM CACHE: APIs externas com cache inteligente.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enrichment_service</span> <span class="o">=</span> <span class="n">BookEnrichmentService</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">enrichment_service</span><span class="o">.</span><span class="n">enrich_book_data</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span>

<span class="c1"># ENDPOINT PARA ESTAT√çSTICAS DE CACHE</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/cache/stats&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cache_statistics</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    M√âTRICAS DE CACHE: Estat√≠sticas para monitoramento.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">global_cache_manager</span><span class="o">.</span><span class="n">get_stats</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/cache/cleanup&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cache_cleanup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LIMPEZA MANUAL: Remove entradas expiradas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="n">global_cache_manager</span><span class="o">.</span><span class="n">cleanup_expired</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Cache cleanup completed&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="otimizacao-de-performance-e-scalability">
<h3>4.3. Otimiza√ß√£o de Performance e Scalability<a class="headerlink" href="#otimizacao-de-performance-e-scalability" title="Link to this heading">#</a></h3>
<section id="database-optimization-patterns">
<h4>4.3.1. Database Optimization Patterns<a class="headerlink" href="#database-optimization-patterns" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># app/core/database_optimization.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectinload</span><span class="p">,</span> <span class="n">joinedload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">QueryOptimization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configura√ß√£o de otimiza√ß√£o de query.&quot;&quot;&quot;</span>
    <span class="n">use_eager_loading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">enable_query_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">prefetch_related</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OptimizedBookRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reposit√≥rio otimizado para opera√ß√µes de banco de dados.</span>
<span class="sd">    </span>
<span class="sd">    OTIMIZA√á√ïES IMPLEMENTADAS:</span>
<span class="sd">    - Eager loading para reduzir N+1 queries</span>
<span class="sd">    - Batch operations para bulk operations</span>
<span class="sd">    - Query optimization hints</span>
<span class="sd">    - Connection pooling inteligente</span>
<span class="sd">    - Read replicas para queries de leitura</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_books_optimized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">optimization</span><span class="p">:</span> <span class="n">QueryOptimization</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Book</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        BUSCA OTIMIZADA: Query com m√∫ltiplas otimiza√ß√µes.</span>
<span class="sd">        </span>
<span class="sd">        T√âCNICAS:</span>
<span class="sd">        - Eager loading de relacionamentos</span>
<span class="sd">        - Index hints quando apropriado</span>
<span class="sd">        - Pagina√ß√£o otimizada</span>
<span class="sd">        - Query cache</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># CONSTRU√á√ÉO DE QUERY BASE</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">BookModel</span><span class="p">)</span>
        
        <span class="c1"># EAGER LOADING DE RELACIONAMENTOS</span>
        <span class="k">if</span> <span class="n">optimization</span><span class="o">.</span><span class="n">use_eager_loading</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
                <span class="n">selectinload</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">author</span><span class="p">),</span>
                <span class="n">selectinload</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">loans</span><span class="p">),</span>
                <span class="n">selectinload</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">reviews</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># APLICA√á√ÉO DE FILTROS OTIMIZADA</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="s2">&quot;genre&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="c1"># Index on genre column</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">genre</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;genre&quot;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s2">&quot;status&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="c1"># Index on status column</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s2">&quot;author_id&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="c1"># Foreign key index</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">author_id</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;author_id&quot;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s2">&quot;publication_year_range&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">year_range</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;publication_year_range&quot;</span><span class="p">]</span>
            <span class="c1"># Composite index on (publication_year, status)</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span>
                    <span class="n">BookModel</span><span class="o">.</span><span class="n">publication_year</span> <span class="o">&gt;=</span> <span class="n">year_range</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">],</span>
                    <span class="n">BookModel</span><span class="o">.</span><span class="n">publication_year</span> <span class="o">&lt;=</span> <span class="n">year_range</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;search_text&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">search_term</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">filters</span><span class="p">[</span><span class="s1">&#39;search_text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">%&quot;</span>
            <span class="c1"># Full-text search index</span>
            <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">or_</span><span class="p">(</span>
                    <span class="n">BookModel</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="n">search_term</span><span class="p">),</span>
                    <span class="n">BookModel</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="n">search_term</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">conditions</span><span class="p">))</span>
        
        <span class="c1"># ORDENA√á√ÉO OTIMIZADA</span>
        <span class="k">if</span> <span class="s2">&quot;sort_by&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">sort_field</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;sort_by&quot;</span><span class="p">]</span>
            <span class="n">sort_order</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sort_order&quot;</span><span class="p">,</span> <span class="s2">&quot;asc&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">sort_field</span> <span class="o">==</span> <span class="s2">&quot;popularity&quot;</span><span class="p">:</span>
                <span class="c1"># Ordena√ß√£o por campo calculado</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                    <span class="n">BookModel</span><span class="o">.</span><span class="n">loan_count</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="s2">&quot;desc&quot;</span>
                    <span class="k">else</span> <span class="n">BookModel</span><span class="o">.</span><span class="n">loan_count</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">order_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">BookModel</span><span class="p">,</span> <span class="n">sort_field</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                    <span class="n">order_func</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span> <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="s2">&quot;desc&quot;</span>
                    <span class="k">else</span> <span class="n">order_func</span><span class="o">.</span><span class="n">asc</span><span class="p">()</span>
                <span class="p">)</span>
        
        <span class="c1"># PAGINA√á√ÉO COM OFFSET/LIMIT OTIMIZADO</span>
        <span class="k">if</span> <span class="s2">&quot;limit&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;offset&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">])</span>
        
        <span class="c1"># EXECU√á√ÉO COM TIMEOUT</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database query timeout&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_503_SERVICE_UNAVAILABLE</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Query timeout - try with more specific filters&quot;</span>
            <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">bulk_insert_optimized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">books_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INSER√á√ÉO EM LOTE OTIMIZADA: Usa batch insert para performance.</span>
<span class="sd">        </span>
<span class="sd">        OTIMIZA√á√ïES:</span>
<span class="sd">        - Batch insert nativo do SQLAlchemy</span>
<span class="sd">        - Transa√ß√£o √∫nica para lote completo</span>
<span class="sd">        - Retorno de IDs gerados</span>
<span class="sd">        - Error handling granular</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">inserted_ids</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># PROCESSAMENTO EM BATCHES</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">books_data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">books_data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># BULK INSERT</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">insert</span><span class="p">(</span><span class="n">BookModel</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                    <span class="n">batch</span>
                <span class="p">)</span>
                
                <span class="c1"># COLETA IDs GERADOS</span>
                <span class="n">batch_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
                <span class="n">inserted_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_ids</span><span class="p">)</span>
                
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch inserted: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> books&quot;</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch insert failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        
        <span class="k">return</span> <span class="n">inserted_ids</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_books_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">updates</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ATUALIZA√á√ÉO EM LOTE: Usa bulk update para efici√™ncia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">updated_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># AGRUPA UPDATES POR TIPO DE CAMPO</span>
        <span class="n">updates_by_field</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
            <span class="n">book_id</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">updates_by_field</span><span class="p">:</span>
                    <span class="n">updates_by_field</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">updates_by_field</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        
        <span class="c1"># EXECUTA BULK UPDATE POR CAMPO</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_updates</span> <span class="ow">in</span> <span class="n">updates_by_field</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># BULK UPDATE statement</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">BookModel</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">BookModel</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">field_updates</span><span class="p">]))</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="n">bindparam</span><span class="p">(</span><span class="n">field</span><span class="p">)})</span>
                <span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">stmt</span><span class="p">,</span>
                    <span class="n">field_updates</span>
                <span class="p">)</span>
                
                <span class="n">updated_count</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">rowcount</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bulk update failed for field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">updated_count</span>
</pre></div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="sintese-e-perspectivas-futuras">
<h2>5. S√≠ntese e Perspectivas Futuras<a class="headerlink" href="#sintese-e-perspectivas-futuras" title="Link to this heading">#</a></h2>
<p>Esta se√ß√£o final consolida todo o conhecimento adquirido e explora as tend√™ncias emergentes no desenvolvimento de APIs REST, oferecendo uma vis√£o estrat√©gica sobre o futuro da √°rea e oportunidades profissionais.</p>
<section id="recapitulacao-e-consolidacao-de-conhecimentos">
<h3>5.1. Recapitula√ß√£o e Consolida√ß√£o de Conhecimentos<a class="headerlink" href="#recapitulacao-e-consolidacao-de-conhecimentos" title="Link to this heading">#</a></h3>
<section id="jornada-de-aprendizado-percorrida">
<h4>5.1.1. Jornada de Aprendizado Percorrida<a class="headerlink" href="#jornada-de-aprendizado-percorrida" title="Link to this heading">#</a></h4>
<p>Durante este curso, constru√≠mos um entendimento abrangente sobre APIs REST modernas:</p>
<p><strong>Marco 1: Fundamentos S√≥lidos</strong></p>
<ul class="simple">
<li><p>Compreendemos os princ√≠pios REST e sua import√¢ncia na arquitetura de software moderna</p></li>
<li><p>Dominamos o protocolo HTTP e seus m√©todos, c√≥digos de status e headers</p></li>
<li><p>Implementamos valida√ß√£o robusta de dados com Pydantic</p></li>
<li><p>Estabelecemos padr√µes de nomenclatura e estrutura√ß√£o de URLs</p></li>
</ul>
<p><strong>Marco 2: Implementa√ß√£o Pr√°tica</strong></p>
<ul class="simple">
<li><p>Desenvolvemos um sistema completo de biblioteca digital demonstrando todos os conceitos</p></li>
<li><p>Implementamos CRUD operations seguindo as melhores pr√°ticas REST</p></li>
<li><p>Integramos APIs externas com tratamento resiliente de erros</p></li>
<li><p>Criamos documenta√ß√£o autom√°tica com OpenAPI/Swagger</p></li>
</ul>
<p><strong>Marco 3: Aspectos Avan√ßados</strong></p>
<ul class="simple">
<li><p>Implementamos autentica√ß√£o JWT e sistemas de autoriza√ß√£o</p></li>
<li><p>Desenvolvemos estrat√©gias de rate limiting e circuit breakers</p></li>
<li><p>Otimizamos performance com caching inteligente e opera√ß√µes em lote</p></li>
<li><p>Aplicamos patterns de resili√™ncia para sistemas distribu√≠dos</p></li>
</ul>
</section>
<section id="competencias-desenvolvidas">
<h4>5.1.2. Compet√™ncias Desenvolvidas<a class="headerlink" href="#competencias-desenvolvidas" title="Link to this heading">#</a></h4>
<p><strong>Compet√™ncias T√©cnicas Espec√≠ficas:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># RESUMO DAS HABILIDADES ADQUIRIDAS</span>

<span class="c1"># 1. DESIGN DE API RESTFUL</span>
<span class="k">class</span><span class="w"> </span><span class="nc">APIDesignSkills</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compet√™ncias em design de APIs RESTful.</span>
<span class="sd">    </span>
<span class="sd">    HABILIDADES DESENVOLVIDAS:</span>
<span class="sd">    - Modelagem de recursos e relacionamentos</span>
<span class="sd">    - Defini√ß√£o de endpoints intuitivos e consistentes</span>
<span class="sd">    - Aplica√ß√£o correta de m√©todos HTTP</span>
<span class="sd">    - Estrutura√ß√£o de respostas padronizadas</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">design_resource_endpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        APLICA√á√ÉO PR√ÅTICA:</span>
<span class="sd">        GET    /api/v1/books           # Listar livros</span>
<span class="sd">        POST   /api/v1/books           # Criar livro</span>
<span class="sd">        GET    /api/v1/books/{id}      # Obter livro espec√≠fico</span>
<span class="sd">        PUT    /api/v1/books/{id}      # Atualizar livro completo</span>
<span class="sd">        PATCH  /api/v1/books/{id}      # Atualizar livro parcial</span>
<span class="sd">        DELETE /api/v1/books/{id}      # Remover livro</span>
<span class="sd">        </span>
<span class="sd">        # Subrecursos</span>
<span class="sd">        GET    /api/v1/books/{id}/loans # Empr√©stimos do livro</span>
<span class="sd">        POST   /api/v1/books/{id}/loans # Criar empr√©stimo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">implement_filtering_pagination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONSULTAS AVAN√áADAS:</span>
<span class="sd">        GET /api/v1/books?genre=fic√ß√£o&amp;status=available&amp;limit=20&amp;offset=40</span>
<span class="sd">        GET /api/v1/books?sort=publication_year&amp;order=desc</span>
<span class="sd">        GET /api/v1/books?search=alquimista&amp;author_id=123</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1"># 2. VALIDA√á√ÉO E SERIALIZA√á√ÉO DE DADOS</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DataValidationSkills</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compet√™ncias em valida√ß√£o robusta com Pydantic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">implement_complex_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VALIDA√á√ïES IMPLEMENTADAS:</span>
<span class="sd">        - Valida√ß√£o de formato (ISBN, email, CPF)</span>
<span class="sd">        - Cross-field validation (datas consistentes)</span>
<span class="sd">        - Valida√ß√£o de regras de neg√≥cio</span>
<span class="sd">        - Custom validators para casos espec√≠ficos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_serialization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SERIALIZA√á√ÉO AVAN√áADA:</span>
<span class="sd">        - Modelos de request vs response</span>
<span class="sd">        - Campos calculados e derivados</span>
<span class="sd">        - Exclus√£o condicional de campos sens√≠veis</span>
<span class="sd">        - Transforma√ß√£o de dados para diferentes contextos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1"># 3. INTEGRA√á√ÉO COM SISTEMAS EXTERNOS</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ExternalIntegrationSkills</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compet√™ncias em consumo e integra√ß√£o de APIs externas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">implement_resilient_api_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        INTEGRA√á√ÉO RESILIENTE:</span>
<span class="sd">        - Retry policies com backoff exponencial</span>
<span class="sd">        - Circuit breakers para prote√ß√£o contra falhas</span>
<span class="sd">        - Timeouts configur√°veis e appropriados</span>
<span class="sd">        - Fallbacks para degrada√ß√£o graceful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_rate_limiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RATE LIMITING:</span>
<span class="sd">        - Sliding window para distribui√ß√£o uniforme</span>
<span class="sd">        - Token bucket para rajadas controladas</span>
<span class="sd">        - Headers informativos (X-RateLimit-*)</span>
<span class="sd">        - Estrat√©gias por tipo de cliente</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1"># 4. SEGURAN√áA E AUTENTICA√á√ÉO</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SecuritySkills</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compet√™ncias em seguran√ßa de APIs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">implement_jwt_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AUTENTICA√á√ÉO JWT:</span>
<span class="sd">        - Gera√ß√£o e valida√ß√£o de tokens</span>
<span class="sd">        - Refresh token mechanism</span>
<span class="sd">        - Role-based access control</span>
<span class="sd">        - Middleware de autentica√ß√£o</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_security_best_practices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PR√ÅTICAS DE SEGURAN√áA:</span>
<span class="sd">        - Hash seguro de senhas (bcrypt)</span>
<span class="sd">        - Valida√ß√£o de entrada rigorosa</span>
<span class="sd">        - Preven√ß√£o de injection attacks</span>
<span class="sd">        - Headers de seguran√ßa apropriados</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

<span class="c1"># 5. PERFORMANCE E ESCALABILIDADE</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceSkills</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compet√™ncias em otimiza√ß√£o de performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">implement_caching_strategies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ESTRAT√âGIAS DE CACHE:</span>
<span class="sd">        - LRU, LFU, TTL-based caching</span>
<span class="sd">        - Cache distribu√≠do com Redis</span>
<span class="sd">        - Invalida√ß√£o inteligente</span>
<span class="sd">        - Compress√£o autom√°tica</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_database_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        OTIMIZA√á√ÉO DE BANCO:</span>
<span class="sd">        - Eager loading para reduzir N+1 queries</span>
<span class="sd">        - Bulk operations para opera√ß√µes em lote</span>
<span class="sd">        - Index optimization</span>
<span class="sd">        - Query timeouts e circuit breakers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p><strong>Compet√™ncias Transversais:</strong></p>
<ol class="arabic simple">
<li><p><strong>Arquitetura de Software</strong>: Compreens√£o de patterns arquiteturais para sistemas distribu√≠dos</p></li>
<li><p><strong>DevOps Awareness</strong>: Conhecimento sobre deployment, monitoring e observabilidade</p></li>
<li><p><strong>Debugging e Troubleshooting</strong>: Habilidades para diagnosticar e resolver problemas em produ√ß√£o</p></li>
<li><p><strong>Documenta√ß√£o T√©cnica</strong>: Capacidade de criar documenta√ß√£o clara e √∫til</p></li>
<li><p><strong>Testing Strategies</strong>: Implementa√ß√£o de testes automatizados abrangentes</p></li>
</ol>
</section>
</section>
<section id="tendencias-e-tecnologias-emergentes">
<h3>5.2. Tend√™ncias e Tecnologias Emergentes<a class="headerlink" href="#tendencias-e-tecnologias-emergentes" title="Link to this heading">#</a></h3>
<section id="graphql-vs-rest-evolucao-ou-substituicao">
<h4>5.2.1. GraphQL vs REST: Evolu√ß√£o ou Substitui√ß√£o?<a class="headerlink" href="#graphql-vs-rest-evolucao-ou-substituicao" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># AN√ÅLISE COMPARATIVA: REST vs GraphQL</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APIEvolutionAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An√°lise das tend√™ncias atuais em design de APIs.</span>
<span class="sd">    </span>
<span class="sd">    CONTEXTO: GraphQL surge como alternativa ao REST,</span>
<span class="sd">    mas cada um tem seus casos de uso apropriados.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">rest_advantages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VANTAGENS DO REST (ainda relevantes):</span>
<span class="sd">        </span>
<span class="sd">        1. SIMPLICIDADE: F√°cil de entender e implementar</span>
<span class="sd">        2. CACHING: HTTP caching funciona nativamente</span>
<span class="sd">        3. TOOLING: Ecossistema maduro de ferramentas</span>
<span class="sd">        4. DEBUGGING: F√°cil de debuggar com ferramentas HTTP</span>
<span class="sd">        5. STATELESS: Alinha com princ√≠pios de arquitetura distribu√≠da</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;when_to_use_rest&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;APIs p√∫blicas simples&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sistemas com caching intensivo&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Microservices internos&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Integra√ß√£o com sistemas legados&quot;</span><span class="p">,</span>
                <span class="s2">&quot;APIs com baixa complexidade de queries&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">graphql_emergence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VANTAGENS DO GRAPHQL:</span>
<span class="sd">        </span>
<span class="sd">        1. FLEXIBILITY: Cliente especifica exatamente quais dados quer</span>
<span class="sd">        2. SINGLE ENDPOINT: Uma URL para todas as opera√ß√µes</span>
<span class="sd">        3. STRONG TYPING: Schema-first development</span>
<span class="sd">        4. INTROSPECTION: API autodescritiva</span>
<span class="sd">        5. REAL-TIME: Subscriptions nativas</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;when_to_use_graphql&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Front-end complexo com muitas varia√ß√µes de dados&quot;</span><span class="p">,</span>
                <span class="s2">&quot;APIs internas para aplica√ß√µes m√≥veis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Agrega√ß√£o de m√∫ltiplas fontes de dados&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Necessidade de real-time updates&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Teams com forte tipagem&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">hybrid_approach</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ABORDAGEM H√çBRIDA: Muitas empresas usam ambos.</span>
<span class="sd">        </span>
<span class="sd">        ESTRAT√âGIA COMUM:</span>
<span class="sd">        - REST para APIs p√∫blicas e microservices</span>
<span class="sd">        - GraphQL para agrega√ß√£o e frontend complexo</span>
<span class="sd">        - Gateway pattern para unificar protocolos</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;implementation_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # API Gateway com suporte a ambos</span>
<span class="s2">            </span>
<span class="s2">            # REST endpoints</span>
<span class="s2">            GET /api/v1/books/</span><span class="si">{id}</span>
<span class="s2">            POST /api/v1/books</span>
<span class="s2">            </span>
<span class="s2">            # GraphQL endpoint</span>
<span class="s2">            POST /graphql</span>
<span class="s2">            query {</span>
<span class="s2">              book(id: &quot;123&quot;) {</span>
<span class="s2">                title</span>
<span class="s2">                author {</span>
<span class="s2">                  name</span>
<span class="s2">                }</span>
<span class="s2">                reviews(limit: 5) {</span>
<span class="s2">                  rating</span>
<span class="s2">                  comment</span>
<span class="s2">                }</span>
<span class="s2">              }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>

<span class="c1"># EXEMPLO PR√ÅTICO: Implementa√ß√£o h√≠brida</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HybridAPIImplementation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implementa√ß√£o que suporta tanto REST quanto GraphQL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># REST com FastAPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest_app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Library REST API&quot;</span><span class="p">)</span>
        
        <span class="c1"># GraphQL com Strawberry</span>
        <span class="c1"># (apenas demonstrativo - n√£o implementado completamente)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphql_schema</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        type Book {</span>
<span class="s2">            id: ID!</span>
<span class="s2">            title: String!</span>
<span class="s2">            author: Author!</span>
<span class="s2">            genre: String</span>
<span class="s2">            publicationYear: Int</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        type Query {</span>
<span class="s2">            books(limit: Int, offset: Int): [Book!]!</span>
<span class="s2">            book(id: ID!): Book</span>
<span class="s2">        }</span>
<span class="s2">        &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_rest_endpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure REST endpoints tradicionais.&quot;&quot;&quot;</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">rest_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/books/</span><span class="si">{book_id}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_book_rest</span><span class="p">(</span><span class="n">book_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;REST endpoint tradicional.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro REST&quot;</span><span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_graphql_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure GraphQL endpoint.&quot;&quot;&quot;</span>
        
        <span class="nd">@self</span><span class="o">.</span><span class="n">rest_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/graphql&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">graphql_endpoint</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            GraphQL endpoint que coexiste com REST.</span>
<span class="sd">            </span>
<span class="sd">            BENEF√çCIO: Clientes podem escolher o protocolo</span>
<span class="sd">            mais adequado para suas necessidades.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Processamento de query GraphQL</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;book&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Livro GraphQL&quot;</span><span class="p">}}}</span>
</pre></div>
</div>
</section>
<section id="arquiteturas-serverless-e-edge-computing">
<h4>5.2.2. Arquiteturas Serverless e Edge Computing<a class="headerlink" href="#arquiteturas-serverless-e-edge-computing" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEND√äNCIA: APIs Serverless e Edge Computing</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ServerlessAPITrends</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An√°lise de tend√™ncias em arquiteturas serverless para APIs.</span>
<span class="sd">    </span>
<span class="sd">    CONTEXTO: Serverless oferece escalabilidade autom√°tica</span>
<span class="sd">    e modelo de pricing por uso, mudando paradigmas de deployment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">serverless_advantages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        VANTAGENS DO SERVERLESS:</span>
<span class="sd">        </span>
<span class="sd">        1. AUTO-SCALING: Escala automaticamente com demanda</span>
<span class="sd">        2. PAY-PER-USE: Custo apenas por requisi√ß√µes processadas</span>
<span class="sd">        3. NO INFRASTRUCTURE: Foco total na l√≥gica de neg√≥cio</span>
<span class="sd">        4. HIGH AVAILABILITY: SLA gerenciado pelo provedor</span>
<span class="sd">        5. FAST DEPLOYMENT: Deploy r√°pido e rollback f√°cil</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;aws_lambda_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # FastAPI em AWS Lambda</span>
<span class="s2">            from mangum import Mangum</span>
<span class="s2">            from fastapi import FastAPI</span>
<span class="s2">            </span>
<span class="s2">            app = FastAPI()</span>
<span class="s2">            </span>
<span class="s2">            @app.get(&quot;/books/</span><span class="si">{book_id}</span><span class="s2">&quot;)</span>
<span class="s2">            async def get_book(book_id: int):</span>
<span class="s2">                return {&quot;id&quot;: book_id, &quot;title&quot;: &quot;Serverless Book&quot;}</span>
<span class="s2">            </span>
<span class="s2">            # Handler para Lambda</span>
<span class="s2">            handler = Mangum(app)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;deployment_config&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # serverless.yml</span>
<span class="s2">            service: biblioteca-api</span>
<span class="s2">            </span>
<span class="s2">            provider:</span>
<span class="s2">              name: aws</span>
<span class="s2">              runtime: python3.9</span>
<span class="s2">              </span>
<span class="s2">            functions:</span>
<span class="s2">              api:</span>
<span class="s2">                handler: main.handler</span>
<span class="s2">                events:</span>
<span class="s2">                  - http:</span>
<span class="s2">                      path: /{proxy+}</span>
<span class="s2">                      method: ANY</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">edge_computing_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EDGE COMPUTING: APIs mais pr√≥ximas dos usu√°rios.</span>
<span class="sd">        </span>
<span class="sd">        BENEF√çCIOS:</span>
<span class="sd">        - Menor lat√™ncia</span>
<span class="sd">        - Melhor experi√™ncia do usu√°rio</span>
<span class="sd">        - Conformidade com regulamenta√ß√µes regionais</span>
<span class="sd">        - Redu√ß√£o de custos de bandwidth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;edge_api_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Cloudflare Workers example</span>
<span class="s2">            export default {</span>
<span class="s2">              async fetch(request) {</span>
<span class="s2">                const url = new URL(request.url);</span>
<span class="s2">                </span>
<span class="s2">                if (url.pathname.startsWith(&#39;/api/books&#39;)) {</span>
<span class="s2">                  // Processar no edge</span>
<span class="s2">                  return new Response(JSON.stringify({</span>
<span class="s2">                    message: &quot;Response from edge&quot;,</span>
<span class="s2">                    location: request.cf.colo</span>
<span class="s2">                  }));</span>
<span class="s2">                }</span>
<span class="s2">                </span>
<span class="s2">                return fetch(request);</span>
<span class="s2">              }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;APIs de autentica√ß√£o&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Valida√ß√£o de dados simples&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;Cache warming&quot;</span><span class="p">,</span>
                <span class="s2">&quot;A/B testing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Request routing baseado em geolocaliza√ß√£o&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">considerations_and_limitations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONSIDERA√á√ïES IMPORTANTES:</span>
<span class="sd">        </span>
<span class="sd">        LIMITA√á√ïES SERVERLESS:</span>
<span class="sd">        - Cold start latency</span>
<span class="sd">        - Timeout limits (normalmente 15min)</span>
<span class="sd">        - Memory e CPU limits</span>
<span class="sd">        - Vendor lock-in</span>
<span class="sd">        - Debugging mais complexo</span>
<span class="sd">        </span>
<span class="sd">        QUANDO N√ÉO USAR:</span>
<span class="sd">        - Aplica√ß√µes com estado persistente</span>
<span class="sd">        - Processamento de longa dura√ß√£o</span>
<span class="sd">        - Opera√ß√µes que exigem recursos espec√≠ficos</span>
<span class="sd">        - Sistemas com lat√™ncia ultra-baixa</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hybrid_recommendation&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            ESTRAT√âGIA H√çBRIDA RECOMENDADA:</span>
<span class="s2">            </span>
<span class="s2">            1. Serverless para:</span>
<span class="s2">               - APIs p√∫blicas com tr√°fego vari√°vel</span>
<span class="s2">               - Webhooks e event processing</span>
<span class="s2">               - APIs de autentica√ß√£o</span>
<span class="s2">               - Processamento de imagens/dados</span>
<span class="s2">            </span>
<span class="s2">            2. Containers tradicionais para:</span>
<span class="s2">               - APIs com estado</span>
<span class="s2">               - Processamento de longa dura√ß√£o</span>
<span class="s2">               - Sistemas com requisitos espec√≠ficos</span>
<span class="s2">               - Aplica√ß√µes com tr√°fego constante</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ai-ml-integration-em-apis">
<h4>5.2.3. AI/ML Integration em APIs<a class="headerlink" href="#ai-ml-integration-em-apis" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TEND√äNCIA: Integra√ß√£o de AI/ML em APIs</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AIMLAPIIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An√°lise de como AI/ML est√° sendo integrado em APIs modernas.</span>
<span class="sd">    </span>
<span class="sd">    CONTEXTO: APIs est√£o se tornando mais inteligentes,</span>
<span class="sd">    oferecendo funcionalidades de AI como servi√ßo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">ai_enhanced_apis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        APIs APRIMORADAS COM IA:</span>
<span class="sd">        </span>
<span class="sd">        CASOS DE USO COMUNS:</span>
<span class="sd">        1. Content moderation autom√°tica</span>
<span class="sd">        2. Recomenda√ß√µes personalizadas</span>
<span class="sd">        3. An√°lise de sentimento</span>
<span class="sd">        4. Processamento de linguagem natural</span>
<span class="sd">        5. Reconhecimento de imagem/texto</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;smart_library_api_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # API de Biblioteca com IA integrada</span>
<span class="s2">            </span>
<span class="s2">            @app.post(&quot;/books/</span><span class="si">{book_id}</span><span class="s2">/recommend&quot;)</span>
<span class="s2">            async def get_recommendations(</span>
<span class="s2">                book_id: int,</span>
<span class="s2">                user_id: int,</span>
<span class="s2">                ai_service: AIService = Depends()</span>
<span class="s2">            ):</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                ENDPOINT INTELIGENTE: Recomenda√ß√µes baseadas em ML.</span>
<span class="s2">                </span>
<span class="s2">                FUNCIONALIDADES:</span>
<span class="s2">                - An√°lise do hist√≥rico do usu√°rio</span>
<span class="s2">                - Similaridade entre livros</span>
<span class="s2">                - Tend√™ncias de leitura</span>
<span class="s2">                - Personaliza√ß√£o contextual</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                </span>
<span class="s2">                # Buscar dados do usu√°rio e livro</span>
<span class="s2">                user_profile = await get_user_reading_profile(user_id)</span>
<span class="s2">                book_features = await extract_book_features(book_id)</span>
<span class="s2">                </span>
<span class="s2">                # Gerar recomenda√ß√µes com IA</span>
<span class="s2">                recommendations = await ai_service.generate_recommendations(</span>
<span class="s2">                    user_profile=user_profile,</span>
<span class="s2">                    current_book_features=book_features,</span>
<span class="s2">                    max_recommendations=10</span>
<span class="s2">                )</span>
<span class="s2">                </span>
<span class="s2">                return {</span>
<span class="s2">                    &quot;book_id&quot;: book_id,</span>
<span class="s2">                    &quot;recommendations&quot;: recommendations,</span>
<span class="s2">                    &quot;confidence_scores&quot;: [r.confidence for r in recommendations],</span>
<span class="s2">                    &quot;explanation&quot;: ai_service.explain_recommendations(recommendations)</span>
<span class="s2">                }</span>
<span class="s2">            </span>
<span class="s2">            @app.post(&quot;/books/content-analysis&quot;)</span>
<span class="s2">            async def analyze_book_content(</span>
<span class="s2">                content: BookContentRequest,</span>
<span class="s2">                ai_service: AIService = Depends()</span>
<span class="s2">            ):</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                AN√ÅLISE AUTOM√ÅTICA DE CONTE√öDO:</span>
<span class="s2">                - Classifica√ß√£o de g√™nero</span>
<span class="s2">                - Detec√ß√£o de temas</span>
<span class="s2">                - An√°lise de complexidade</span>
<span class="s2">                - Sugest√£o de idade apropriada</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                </span>
<span class="s2">                analysis = await ai_service.analyze_content(content.text)</span>
<span class="s2">                </span>
<span class="s2">                return {</span>
<span class="s2">                    &quot;genre_classification&quot;: analysis.genre,</span>
<span class="s2">                    &quot;themes&quot;: analysis.detected_themes,</span>
<span class="s2">                    &quot;reading_level&quot;: analysis.complexity_score,</span>
<span class="s2">                    &quot;age_recommendation&quot;: analysis.appropriate_age,</span>
<span class="s2">                    &quot;content_warnings&quot;: analysis.warnings</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">ml_ops_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MLOPS EM APIS: Integra√ß√£o de modelos ML em produ√ß√£o.</span>
<span class="sd">        </span>
<span class="sd">        DESAFIOS:</span>
<span class="sd">        - Model versioning</span>
<span class="sd">        - A/B testing de modelos</span>
<span class="sd">        - Monitoring de model drift</span>
<span class="sd">        - Performance optimization</span>
<span class="sd">        - Fallback strategies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;model_serving_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Serving de modelo ML na API</span>
<span class="s2">            </span>
<span class="s2">            class MLModelService:</span>
<span class="s2">                def __init__(self):</span>
<span class="s2">                    self.models = {</span>
<span class="s2">                        &quot;recommendation_v1&quot;: self.load_model(&quot;rec_v1.pkl&quot;),</span>
<span class="s2">                        &quot;recommendation_v2&quot;: self.load_model(&quot;rec_v2.pkl&quot;)</span>
<span class="s2">                    }</span>
<span class="s2">                    self.active_model = &quot;recommendation_v1&quot;</span>
<span class="s2">                </span>
<span class="s2">                async def predict(self, features: dict, model_version: str = None):</span>
<span class="s2">                    &#39;&#39;&#39;</span>
<span class="s2">                    PREDI√á√ÉO COM VERSIONAMENTO:</span>
<span class="s2">                    - Suporte a m√∫ltiplas vers√µes</span>
<span class="s2">                    - A/B testing</span>
<span class="s2">                    - Fallback autom√°tico</span>
<span class="s2">                    &#39;&#39;&#39;</span>
<span class="s2">                    </span>
<span class="s2">                    version = model_version or self.active_model</span>
<span class="s2">                    </span>
<span class="s2">                    try:</span>
<span class="s2">                        model = self.models[version]</span>
<span class="s2">                        prediction = await model.predict(features)</span>
<span class="s2">                        </span>
<span class="s2">                        # Log para monitoramento</span>
<span class="s2">                        await self.log_prediction(version, features, prediction)</span>
<span class="s2">                        </span>
<span class="s2">                        return prediction</span>
<span class="s2">                        </span>
<span class="s2">                    except Exception as e:</span>
<span class="s2">                        # Fallback para vers√£o est√°vel</span>
<span class="s2">                        logging.error(f&quot;Model </span><span class="si">{version}</span><span class="s2"> failed: </span><span class="si">{e}</span><span class="s2">&quot;)</span>
<span class="s2">                        if version != &quot;recommendation_v1&quot;:</span>
<span class="s2">                            return await self.predict(features, &quot;recommendation_v1&quot;)</span>
<span class="s2">                        raise</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;monitoring_example&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Monitoramento de ML models</span>
<span class="s2">            </span>
<span class="s2">            @app.middleware(&quot;http&quot;)</span>
<span class="s2">            async def ml_monitoring_middleware(request: Request, call_next):</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                MIDDLEWARE DE MONITORAMENTO:</span>
<span class="s2">                - Lat√™ncia de predi√ß√µes</span>
<span class="s2">                - Taxa de erro de modelos</span>
<span class="s2">                - Drift detection</span>
<span class="s2">                - Feature distribution analysis</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                </span>
<span class="s2">                if &quot;/predict&quot; in str(request.url):</span>
<span class="s2">                    start_time = time.time()</span>
<span class="s2">                    </span>
<span class="s2">                    response = await call_next(request)</span>
<span class="s2">                    </span>
<span class="s2">                    prediction_time = time.time() - start_time</span>
<span class="s2">                    </span>
<span class="s2">                    # Enviar m√©tricas para sistema de monitoramento</span>
<span class="s2">                    await send_ml_metrics({</span>
<span class="s2">                        &quot;prediction_latency&quot;: prediction_time,</span>
<span class="s2">                        &quot;model_version&quot;: response.headers.get(&quot;Model-Version&quot;),</span>
<span class="s2">                        &quot;endpoint&quot;: str(request.url)</span>
<span class="s2">                    })</span>
<span class="s2">                </span>
<span class="s2">                return response</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">ethical_ai_considerations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CONSIDERA√á√ïES √âTICAS EM APIs COM IA:</span>
<span class="sd">        </span>
<span class="sd">        RESPONSABILIDADES:</span>
<span class="sd">        1. Transpar√™ncia sobre uso de IA</span>
<span class="sd">        2. Explicabilidade de decis√µes</span>
<span class="sd">        3. Bias detection e mitigation</span>
<span class="sd">        4. Privacy e prote√ß√£o de dados</span>
<span class="sd">        5. Consent informado</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;ethical_api_design&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Design √©tico de API com IA</span>
<span class="s2">            </span>
<span class="s2">            @app.post(&quot;/books/ai-analysis&quot;)</span>
<span class="s2">            async def ai_analysis_with_ethics(</span>
<span class="s2">                request: AnalysisRequest,</span>
<span class="s2">                consent: bool = Query(..., description=&quot;User consents to AI analysis&quot;)</span>
<span class="s2">            ):</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                AN√ÅLISE COM IA √âTICA:</span>
<span class="s2">                - Consent expl√≠cito</span>
<span class="s2">                - Transpar√™ncia sobre processamento</span>
<span class="s2">                - Explicabilidade dos resultados</span>
<span class="s2">                - Auditoria de bias</span>
<span class="s2">                &#39;&#39;&#39;</span>
<span class="s2">                </span>
<span class="s2">                if not consent:</span>
<span class="s2">                    raise HTTPException(</span>
<span class="s2">                        status_code=400,</span>
<span class="s2">                        detail=&quot;User consent required for AI analysis&quot;</span>
<span class="s2">                    )</span>
<span class="s2">                </span>
<span class="s2">                # An√°lise com IA</span>
<span class="s2">                result = await ai_service.analyze(request.data)</span>
<span class="s2">                </span>
<span class="s2">                return {</span>
<span class="s2">                    &quot;analysis&quot;: result.data,</span>
<span class="s2">                    &quot;ai_disclosure&quot;: {</span>
<span class="s2">                        &quot;ai_used&quot;: True,</span>
<span class="s2">                        &quot;model_type&quot;: &quot;Natural Language Processing&quot;,</span>
<span class="s2">                        &quot;confidence_level&quot;: result.confidence,</span>
<span class="s2">                        &quot;explanation&quot;: result.explanation,</span>
<span class="s2">                        &quot;bias_check&quot;: result.bias_assessment</span>
<span class="s2">                    },</span>
<span class="s2">                    &quot;data_usage&quot;: {</span>
<span class="s2">                        &quot;stored&quot;: False,</span>
<span class="s2">                        &quot;retention_period&quot;: &quot;Not stored&quot;,</span>
<span class="s2">                        &quot;third_party_sharing&quot;: False</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="integracao-com-ecossistemas-modernos">
<h3>5.3. Integra√ß√£o com Ecossistemas Modernos<a class="headerlink" href="#integracao-com-ecossistemas-modernos" title="Link to this heading">#</a></h3>
<section id="microservices-e-service-mesh">
<h4>5.3.1. Microservices e Service Mesh<a class="headerlink" href="#microservices-e-service-mesh" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># INTEGRA√á√ÉO: APIs em Arquiteturas de Microservices</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MicroservicesAPIPatterns</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Padr√µes para APIs em arquiteturas de microservices.</span>
<span class="sd">    </span>
<span class="sd">    CONTEXTO: APIs REST s√£o fundamentais para comunica√ß√£o</span>
<span class="sd">    entre microservices, exigindo patterns espec√≠ficos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">api_gateway_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        API GATEWAY: Ponto √∫nico de entrada para clientes.</span>
<span class="sd">        </span>
<span class="sd">        RESPONSABILIDADES:</span>
<span class="sd">        - Request routing</span>
<span class="sd">        - Authentication/Authorization</span>
<span class="sd">        - Rate limiting</span>
<span class="sd">        - Request/Response transformation</span>
<span class="sd">        - Monitoring e logging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;gateway_implementation&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # API Gateway com FastAPI</span>
<span class="s2">            </span>
<span class="s2">            class APIGateway:</span>
<span class="s2">                def __init__(self):</span>
<span class="s2">                    self.app = FastAPI(title=&quot;Library API Gateway&quot;)</span>
<span class="s2">                    self.service_registry = {</span>
<span class="s2">                        &quot;books&quot;: &quot;http://books-service:8001&quot;,</span>
<span class="s2">                        &quot;users&quot;: &quot;http://users-service:8002&quot;,</span>
<span class="s2">                        &quot;loans&quot;: &quot;http://loans-service:8003&quot;</span>
<span class="s2">                    }</span>
<span class="s2">                </span>
<span class="s2">                def setup_routes(self):</span>
<span class="s2">                    &#39;&#39;&#39;Route all requests to appropriate microservices.&#39;&#39;&#39;</span>
<span class="s2">                    </span>
<span class="s2">                    @self.app.api_route(&quot;/</span><span class="si">{service}</span><span class="s2">/{path:path}&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;])</span>
<span class="s2">                    async def proxy_request(</span>
<span class="s2">                        service: str,</span>
<span class="s2">                        path: str,</span>
<span class="s2">                        request: Request</span>
<span class="s2">                    ):</span>
<span class="s2">                        # Validate service exists</span>
<span class="s2">                        if service not in self.service_registry:</span>
<span class="s2">                            raise HTTPException(404, f&quot;Service </span><span class="si">{service}</span><span class="s2"> not found&quot;)</span>
<span class="s2">                        </span>
<span class="s2">                        # Extract authentication</span>
<span class="s2">                        auth_header = request.headers.get(&quot;Authorization&quot;)</span>
<span class="s2">                        user = await self.authenticate_request(auth_header)</span>
<span class="s2">                        </span>
<span class="s2">                        # Rate limiting</span>
<span class="s2">                        await self.check_rate_limit(user.id if user else &quot;anonymous&quot;)</span>
<span class="s2">                        </span>
<span class="s2">                        # Proxy request</span>
<span class="s2">                        target_url = f&quot;</span><span class="si">{self.service_registry[service]}</span><span class="s2">/</span><span class="si">{path}</span><span class="s2">&quot;</span>
<span class="s2">                        </span>
<span class="s2">                        async with httpx.AsyncClient() as client:</span>
<span class="s2">                            response = await client.request(</span>
<span class="s2">                                method=request.method,</span>
<span class="s2">                                url=target_url,</span>
<span class="s2">                                headers=dict(request.headers),</span>
<span class="s2">                                content=await request.body()</span>
<span class="s2">                            )</span>
<span class="s2">                        </span>
<span class="s2">                        return Response(</span>
<span class="s2">                            content=response.content,</span>
<span class="s2">                            status_code=response.status_code,</span>
<span class="s2">                            headers=dict(response.headers)</span>
<span class="s2">                        )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;service_discovery&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Service Discovery integration</span>
<span class="s2">            </span>
<span class="s2">            class ServiceRegistry:</span>
<span class="s2">                def __init__(self):</span>
<span class="s2">                    self.consul_client = consul.Consul()</span>
<span class="s2">                </span>
<span class="s2">                async def discover_service(self, service_name: str) -&gt; str:</span>
<span class="s2">                    &#39;&#39;&#39;Discover service endpoint dynamically.&#39;&#39;&#39;</span>
<span class="s2">                    </span>
<span class="s2">                    services = self.consul_client.health.service(</span>
<span class="s2">                        service_name,</span>
<span class="s2">                        passing=True  # Only healthy instances</span>
<span class="s2">                    )</span>
<span class="s2">                    </span>
<span class="s2">                    if not services[1]:</span>
<span class="s2">                        raise ServiceUnavailableError(f&quot;No healthy </span><span class="si">{service_name}</span><span class="s2"> instances&quot;)</span>
<span class="s2">                    </span>
<span class="s2">                    # Load balancing - round robin</span>
<span class="s2">                    instance = random.choice(services[1])</span>
<span class="s2">                    return f&quot;http://</span><span class="si">{instance[&#39;Service&#39;][&#39;Address&#39;]}</span><span class="s2">:</span><span class="si">{instance[&#39;Service&#39;][&#39;Port&#39;]}</span><span class="s2">&quot;</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">service_mesh_integration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SERVICE MESH: Infraestrutura para comunica√ß√£o entre services.</span>
<span class="sd">        </span>
<span class="sd">        FUNCIONALIDADES:</span>
<span class="sd">        - Automatic service discovery</span>
<span class="sd">        - Load balancing</span>
<span class="sd">        - Circuit breaking</span>
<span class="sd">        - Mutual TLS</span>
<span class="sd">        - Observability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;istio_configuration&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Istio configuration for FastAPI service</span>
<span class="s2">            </span>
<span class="s2">            apiVersion: networking.istio.io/v1beta1</span>
<span class="s2">            kind: VirtualService</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api</span>
<span class="s2">            spec:</span>
<span class="s2">              http:</span>
<span class="s2">              - match:</span>
<span class="s2">                - uri:</span>
<span class="s2">                    prefix: /api/v1/books</span>
<span class="s2">                route:</span>
<span class="s2">                - destination:</span>
<span class="s2">                    host: books-service</span>
<span class="s2">                    port:</span>
<span class="s2">                      number: 8000</span>
<span class="s2">                fault:</span>
<span class="s2">                  delay:</span>
<span class="s2">                    percentage:</span>
<span class="s2">                      value: 0.1</span>
<span class="s2">                    fixedDelay: 5s</span>
<span class="s2">                retries:</span>
<span class="s2">                  attempts: 3</span>
<span class="s2">                  perTryTimeout: 10s</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;circuit_breaker_config&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Circuit breaker with Istio</span>
<span class="s2">            </span>
<span class="s2">            apiVersion: networking.istio.io/v1beta1</span>
<span class="s2">            kind: DestinationRule</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-service-cb</span>
<span class="s2">            spec:</span>
<span class="s2">              host: books-service</span>
<span class="s2">              trafficPolicy:</span>
<span class="s2">                circuitBreaker:</span>
<span class="s2">                  consecutiveErrors: 3</span>
<span class="s2">                  interval: 30s</span>
<span class="s2">                  baseEjectionTime: 30s</span>
<span class="s2">                  maxEjectionPercent: 50</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">distributed_tracing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DISTRIBUTED TRACING: Rastreamento de requests entre services.</span>
<span class="sd">        </span>
<span class="sd">        IMPLEMENTA√á√ÉO: OpenTelemetry + Jaeger/Zipkin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;tracing_implementation&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # OpenTelemetry integration</span>
<span class="s2">            </span>
<span class="s2">            from opentelemetry import trace</span>
<span class="s2">            from opentelemetry.exporter.jaeger.thrift import JaegerExporter</span>
<span class="s2">            from opentelemetry.sdk.trace import TracerProvider</span>
<span class="s2">            from opentelemetry.sdk.trace.export import BatchSpanProcessor</span>
<span class="s2">            </span>
<span class="s2">            # Configure tracing</span>
<span class="s2">            trace.set_tracer_provider(TracerProvider())</span>
<span class="s2">            tracer = trace.get_tracer(__name__)</span>
<span class="s2">            </span>
<span class="s2">            jaeger_exporter = JaegerExporter(</span>
<span class="s2">                agent_host_name=&quot;jaeger&quot;,</span>
<span class="s2">                agent_port=6831,</span>
<span class="s2">            )</span>
<span class="s2">            </span>
<span class="s2">            span_processor = BatchSpanProcessor(jaeger_exporter)</span>
<span class="s2">            trace.get_tracer_provider().add_span_processor(span_processor)</span>
<span class="s2">            </span>
<span class="s2">            @app.middleware(&quot;http&quot;)</span>
<span class="s2">            async def tracing_middleware(request: Request, call_next):</span>
<span class="s2">                &#39;&#39;&#39;Add distributed tracing to all requests.&#39;&#39;&#39;</span>
<span class="s2">                </span>
<span class="s2">                with tracer.start_as_current_span(f&quot;</span><span class="si">{request.method}</span><span class="s2"> </span><span class="si">{request.url.path}</span><span class="s2">&quot;) as span:</span>
<span class="s2">                    # Add request attributes</span>
<span class="s2">                    span.set_attribute(&quot;http.method&quot;, request.method)</span>
<span class="s2">                    span.set_attribute(&quot;http.url&quot;, str(request.url))</span>
<span class="s2">                    span.set_attribute(&quot;service.name&quot;, &quot;books-api&quot;)</span>
<span class="s2">                    </span>
<span class="s2">                    response = await call_next(request)</span>
<span class="s2">                    </span>
<span class="s2">                    # Add response attributes</span>
<span class="s2">                    span.set_attribute(&quot;http.status_code&quot;, response.status_code)</span>
<span class="s2">                    </span>
<span class="s2">                    return response</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="cloud-native-e-kubernetes">
<h4>5.3.2. Cloud Native e Kubernetes<a class="headerlink" href="#cloud-native-e-kubernetes" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CLOUD NATIVE: APIs em ambientes Kubernetes</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CloudNativeAPIDeployment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deployment de APIs em ambientes cloud native.</span>
<span class="sd">    </span>
<span class="sd">    CONCEITOS:</span>
<span class="sd">    - Containeriza√ß√£o</span>
<span class="sd">    - Orchestration com Kubernetes</span>
<span class="sd">    - Auto-scaling</span>
<span class="sd">    - Health checks</span>
<span class="sd">    - Configuration management</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">kubernetes_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPLOYMENT COMPLETO: API em Kubernetes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;dockerfile&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Multi-stage Dockerfile para produ√ß√£o</span>
<span class="s2">            FROM python:3.11-slim as builder</span>
<span class="s2">            </span>
<span class="s2">            WORKDIR /app</span>
<span class="s2">            COPY requirements.txt .</span>
<span class="s2">            RUN pip install --user --no-cache-dir -r requirements.txt</span>
<span class="s2">            </span>
<span class="s2">            FROM python:3.11-slim</span>
<span class="s2">            </span>
<span class="s2">            # Create non-root user</span>
<span class="s2">            RUN useradd --create-home --shell /bin/bash app</span>
<span class="s2">            </span>
<span class="s2">            WORKDIR /app</span>
<span class="s2">            </span>
<span class="s2">            # Copy dependencies</span>
<span class="s2">            COPY --from=builder /root/.local /home/app/.local</span>
<span class="s2">            </span>
<span class="s2">            # Copy application</span>
<span class="s2">            COPY . .</span>
<span class="s2">            RUN chown -R app:app /app</span>
<span class="s2">            </span>
<span class="s2">            USER app</span>
<span class="s2">            </span>
<span class="s2">            # Health check</span>
<span class="s2">            HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 </span><span class="se">\</span>
<span class="s2">              CMD curl -f http://localhost:8000/health || exit 1</span>
<span class="s2">            </span>
<span class="s2">            EXPOSE 8000</span>
<span class="s2">            </span>
<span class="s2">            CMD [&quot;uvicorn&quot;, &quot;app.main:app&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;8000&quot;]</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;k8s_deployment&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Kubernetes Deployment</span>
<span class="s2">            apiVersion: apps/v1</span>
<span class="s2">            kind: Deployment</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api</span>
<span class="s2">              labels:</span>
<span class="s2">                app: books-api</span>
<span class="s2">            spec:</span>
<span class="s2">              replicas: 3</span>
<span class="s2">              selector:</span>
<span class="s2">                matchLabels:</span>
<span class="s2">                  app: books-api</span>
<span class="s2">              template:</span>
<span class="s2">                metadata:</span>
<span class="s2">                  labels:</span>
<span class="s2">                    app: books-api</span>
<span class="s2">                spec:</span>
<span class="s2">                  containers:</span>
<span class="s2">                  - name: books-api</span>
<span class="s2">                    image: books-api:latest</span>
<span class="s2">                    ports:</span>
<span class="s2">                    - containerPort: 8000</span>
<span class="s2">                    env:</span>
<span class="s2">                    - name: DATABASE_URL</span>
<span class="s2">                      valueFrom:</span>
<span class="s2">                        secretKeyRef:</span>
<span class="s2">                          name: db-credentials</span>
<span class="s2">                          key: url</span>
<span class="s2">                    - name: REDIS_URL</span>
<span class="s2">                      value: &quot;redis://redis-service:6379&quot;</span>
<span class="s2">                    livenessProbe:</span>
<span class="s2">                      httpGet:</span>
<span class="s2">                        path: /health</span>
<span class="s2">                        port: 8000</span>
<span class="s2">                      initialDelaySeconds: 30</span>
<span class="s2">                      periodSeconds: 10</span>
<span class="s2">                    readinessProbe:</span>
<span class="s2">                      httpGet:</span>
<span class="s2">                        path: /health</span>
<span class="s2">                        port: 8000</span>
<span class="s2">                      initialDelaySeconds: 5</span>
<span class="s2">                      periodSeconds: 5</span>
<span class="s2">                    resources:</span>
<span class="s2">                      requests:</span>
<span class="s2">                        memory: &quot;256Mi&quot;</span>
<span class="s2">                        cpu: &quot;250m&quot;</span>
<span class="s2">                      limits:</span>
<span class="s2">                        memory: &quot;512Mi&quot;</span>
<span class="s2">                        cpu: &quot;500m&quot;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;k8s_service&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Kubernetes Service</span>
<span class="s2">            apiVersion: v1</span>
<span class="s2">            kind: Service</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api-service</span>
<span class="s2">            spec:</span>
<span class="s2">              selector:</span>
<span class="s2">                app: books-api</span>
<span class="s2">              ports:</span>
<span class="s2">              - protocol: TCP</span>
<span class="s2">                port: 80</span>
<span class="s2">                targetPort: 8000</span>
<span class="s2">              type: ClusterIP</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;k8s_ingress&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Kubernetes Ingress</span>
<span class="s2">            apiVersion: networking.k8s.io/v1</span>
<span class="s2">            kind: Ingress</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api-ingress</span>
<span class="s2">              annotations:</span>
<span class="s2">                nginx.ingress.kubernetes.io/rewrite-target: /</span>
<span class="s2">                cert-manager.io/cluster-issuer: letsencrypt-prod</span>
<span class="s2">            spec:</span>
<span class="s2">              tls:</span>
<span class="s2">              - hosts:</span>
<span class="s2">                - api.biblioteca.com</span>
<span class="s2">                secretName: books-api-tls</span>
<span class="s2">              rules:</span>
<span class="s2">              - host: api.biblioteca.com</span>
<span class="s2">                http:</span>
<span class="s2">                  paths:</span>
<span class="s2">                  - path: /</span>
<span class="s2">                    pathType: Prefix</span>
<span class="s2">                    backend:</span>
<span class="s2">                      service:</span>
<span class="s2">                        name: books-api-service</span>
<span class="s2">                        port:</span>
<span class="s2">                          number: 80</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">auto_scaling_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AUTO-SCALING: Escalabilidade autom√°tica baseada em m√©tricas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hpa_config&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Horizontal Pod Autoscaler</span>
<span class="s2">            apiVersion: autoscaling/v2</span>
<span class="s2">            kind: HorizontalPodAutoscaler</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api-hpa</span>
<span class="s2">            spec:</span>
<span class="s2">              scaleTargetRef:</span>
<span class="s2">                apiVersion: apps/v1</span>
<span class="s2">                kind: Deployment</span>
<span class="s2">                name: books-api</span>
<span class="s2">              minReplicas: 2</span>
<span class="s2">              maxReplicas: 10</span>
<span class="s2">              metrics:</span>
<span class="s2">              - type: Resource</span>
<span class="s2">                resource:</span>
<span class="s2">                  name: cpu</span>
<span class="s2">                  target:</span>
<span class="s2">                    type: Utilization</span>
<span class="s2">                    averageUtilization: 70</span>
<span class="s2">              - type: Resource</span>
<span class="s2">                resource:</span>
<span class="s2">                  name: memory</span>
<span class="s2">                  target:</span>
<span class="s2">                    type: Utilization</span>
<span class="s2">                    averageUtilization: 80</span>
<span class="s2">              behavior:</span>
<span class="s2">                scaleDown:</span>
<span class="s2">                  stabilizationWindowSeconds: 300</span>
<span class="s2">                  policies:</span>
<span class="s2">                  - type: Percent</span>
<span class="s2">                    value: 10</span>
<span class="s2">                    periodSeconds: 60</span>
<span class="s2">                scaleUp:</span>
<span class="s2">                  stabilizationWindowSeconds: 60</span>
<span class="s2">                  policies:</span>
<span class="s2">                  - type: Percent</span>
<span class="s2">                    value: 50</span>
<span class="s2">                    periodSeconds: 30</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;vpa_config&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Vertical Pod Autoscaler</span>
<span class="s2">            apiVersion: autoscaling.k8s.io/v1</span>
<span class="s2">            kind: VerticalPodAutoscaler</span>
<span class="s2">            metadata:</span>
<span class="s2">              name: books-api-vpa</span>
<span class="s2">            spec:</span>
<span class="s2">              targetRef:</span>
<span class="s2">                apiVersion: apps/v1</span>
<span class="s2">                kind: Deployment</span>
<span class="s2">                name: books-api</span>
<span class="s2">              updatePolicy:</span>
<span class="s2">                updateMode: &quot;Auto&quot;</span>
<span class="s2">              resourcePolicy:</span>
<span class="s2">                containerPolicies:</span>
<span class="s2">                - containerName: books-api</span>
<span class="s2">                  maxAllowed:</span>
<span class="s2">                    memory: 1Gi</span>
<span class="s2">                    cpu: 1</span>
<span class="s2">                  minAllowed:</span>
<span class="s2">                    memory: 128Mi</span>
<span class="s2">                    cpu: 100m</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">monitoring_and_observability</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        OBSERVABILIDADE: Monitoring completo da aplica√ß√£o.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;prometheus_config&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Prometheus monitoring</span>
<span class="s2">            from prometheus_client import Counter, Histogram, generate_latest</span>
<span class="s2">            </span>
<span class="s2">            # M√©tricas customizadas</span>
<span class="s2">            REQUEST_COUNT = Counter(</span>
<span class="s2">                &#39;api_requests_total&#39;,</span>
<span class="s2">                &#39;Total API requests&#39;,</span>
<span class="s2">                [&#39;method&#39;, &#39;endpoint&#39;, &#39;status&#39;]</span>
<span class="s2">            )</span>
<span class="s2">            </span>
<span class="s2">            REQUEST_DURATION = Histogram(</span>
<span class="s2">                &#39;api_request_duration_seconds&#39;,</span>
<span class="s2">                &#39;API request duration&#39;,</span>
<span class="s2">                [&#39;method&#39;, &#39;endpoint&#39;]</span>
<span class="s2">            )</span>
<span class="s2">            </span>
<span class="s2">            @app.middleware(&quot;http&quot;)</span>
<span class="s2">            async def metrics_middleware(request: Request, call_next):</span>
<span class="s2">                start_time = time.time()</span>
<span class="s2">                </span>
<span class="s2">                response = await call_next(request)</span>
<span class="s2">                </span>
<span class="s2">                duration = time.time() - start_time</span>
<span class="s2">                </span>
<span class="s2">                REQUEST_COUNT.labels(</span>
<span class="s2">                    method=request.method,</span>
<span class="s2">                    endpoint=request.url.path,</span>
<span class="s2">                    status=response.status_code</span>
<span class="s2">                ).inc()</span>
<span class="s2">                </span>
<span class="s2">                REQUEST_DURATION.labels(</span>
<span class="s2">                    method=request.method,</span>
<span class="s2">                    endpoint=request.url.path</span>
<span class="s2">                ).observe(duration)</span>
<span class="s2">                </span>
<span class="s2">                return response</span>
<span class="s2">            </span>
<span class="s2">            @app.get(&quot;/metrics&quot;)</span>
<span class="s2">            async def metrics():</span>
<span class="s2">                return Response(generate_latest(), media_type=&quot;text/plain&quot;)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
            
            <span class="s2">&quot;grafana_dashboard&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # Grafana Dashboard (JSON snippet)</span>
<span class="s2">            {</span>
<span class="s2">              &quot;dashboard&quot;: {</span>
<span class="s2">                &quot;title&quot;: &quot;Books API Dashboard&quot;,</span>
<span class="s2">                &quot;panels&quot;: [</span>
<span class="s2">                  {</span>
<span class="s2">                    &quot;title&quot;: &quot;Request Rate&quot;,</span>
<span class="s2">                    &quot;type&quot;: &quot;stat&quot;,</span>
<span class="s2">                    &quot;targets&quot;: [</span>
<span class="s2">                      {</span>
<span class="s2">                        &quot;expr&quot;: &quot;rate(api_requests_total[5m])&quot;,</span>
<span class="s2">                        &quot;legendFormat&quot;: &quot;Requests/sec&quot;</span>
<span class="s2">                      }</span>
<span class="s2">                    ]</span>
<span class="s2">                  },</span>
<span class="s2">                  {</span>
<span class="s2">                    &quot;title&quot;: &quot;Response Time P95&quot;,</span>
<span class="s2">                    &quot;type&quot;: &quot;stat&quot;, </span>
<span class="s2">                    &quot;targets&quot;: [</span>
<span class="s2">                      {</span>
<span class="s2">                        &quot;expr&quot;: &quot;histogram_quantile(0.95, api_request_duration_seconds_bucket)&quot;,</span>
<span class="s2">                        &quot;legendFormat&quot;: &quot;P95 Latency&quot;</span>
<span class="s2">                      }</span>
<span class="s2">                    ]</span>
<span class="s2">                  },</span>
<span class="s2">                  {</span>
<span class="s2">                    &quot;title&quot;: &quot;Error Rate&quot;,</span>
<span class="s2">                    &quot;type&quot;: &quot;stat&quot;,</span>
<span class="s2">                    &quot;targets&quot;: [</span>
<span class="s2">                      {</span>
<span class="s2">                        &quot;expr&quot;: &quot;rate(api_requests_total{status=~&#39;5..&#39;}[5m]) / rate(api_requests_total[5m])&quot;,</span>
<span class="s2">                        &quot;legendFormat&quot;: &quot;Error Rate&quot;</span>
<span class="s2">                      }</span>
<span class="s2">                    ]</span>
<span class="s2">                  }</span>
<span class="s2">                ]</span>
<span class="s2">              }</span>
<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="oportunidades-de-carreira-e-mercado">
<h3>5.4. Oportunidades de Carreira e Mercado<a class="headerlink" href="#oportunidades-de-carreira-e-mercado" title="Link to this heading">#</a></h3>
<section id="panorama-do-mercado-de-apis">
<h4>5.4.1. Panorama do Mercado de APIs<a class="headerlink" href="#panorama-do-mercado-de-apis" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># AN√ÅLISE: Mercado de trabalho para APIs REST</span>

<span class="k">class</span><span class="w"> </span><span class="nc">APICareerLandscape</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An√°lise do mercado de trabalho e oportunidades em APIs REST.</span>
<span class="sd">    </span>
<span class="sd">    CONTEXTO: APIs s√£o fundamentais na economia digital moderna,</span>
<span class="sd">    criando diversas oportunidades profissionais.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">market_demand_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEMANDA DO MERCADO: An√°lise de tend√™ncias e oportunidades.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;high_demand_roles&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;Backend Developer&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Desenvolvimento de APIs e microservices&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;salary_range&quot;</span><span class="p">:</span> <span class="s2">&quot;R$ 4.000 - R$ 15.000&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;FastAPI/Django/Flask&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Database design&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;REST API principles&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Testing and debugging&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Cloud platforms&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;growth_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;25% nos pr√≥ximos 5 anos&quot;</span>
                <span class="p">},</span>
                
                <span class="s2">&quot;API Platform Engineer&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Infraestrutura e tooling para APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;salary_range&quot;</span><span class="p">:</span> <span class="s2">&quot;R$ 8.000 - R$ 20.000&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;API Gateway management&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Kubernetes/Docker&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Service mesh (Istio)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Monitoring e observability&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;DevOps practices&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;growth_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;35% nos pr√≥ximos 5 anos&quot;</span>
                <span class="p">},</span>
                
                <span class="s2">&quot;API Product Manager&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Estrat√©gia e roadmap de produtos API&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;salary_range&quot;</span><span class="p">:</span> <span class="s2">&quot;R$ 10.000 - R$ 25.000&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;API strategy&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Developer experience&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;API monetization&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Technical communication&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Market analysis&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;growth_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;40% nos pr√≥ximos 5 anos&quot;</span>
                <span class="p">},</span>
                
                <span class="s2">&quot;DevOps/SRE Engineer&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Reliability e performance de APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;salary_range&quot;</span><span class="p">:</span> <span class="s2">&quot;R$ 6.000 - R$ 18.000&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;key_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Infrastructure as Code&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;CI/CD pipelines&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Monitoring e alerting&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Incident response&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Capacity planning&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;growth_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;30% nos pr√≥ximos 5 anos&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;emerging_opportunities&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;API Security Specialist&quot;</span><span class="p">,</span>
                <span class="s2">&quot;AI/ML API Engineer&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;Edge Computing API Developer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Blockchain API Developer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;IoT API Architect&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">industry_applications</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SETORES COM ALTA DEMANDA: Ind√∫strias que mais contratam profissionais de API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;fintech&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Payment processing APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Open banking integration&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Cryptocurrency exchanges&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Risk assessment APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Regulatory compliance APIs&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;companies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Nubank&quot;</span><span class="p">,</span> <span class="s2">&quot;Stone&quot;</span><span class="p">,</span> <span class="s2">&quot;PagSeguro&quot;</span><span class="p">,</span> <span class="s2">&quot;Inter&quot;</span><span class="p">,</span> <span class="s2">&quot;Picpay&quot;</span><span class="p">],</span>
                <span class="s2">&quot;salary_premium&quot;</span><span class="p">:</span> <span class="s2">&quot;15-25</span><span class="si">% a</span><span class="s2">cima da m√©dia&quot;</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;e_commerce&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Product catalog APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Payment gateway integration&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Logistics and shipping APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Inventory management&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Recommendation engines&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;companies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Amazon&quot;</span><span class="p">,</span> <span class="s2">&quot;Mercado Livre&quot;</span><span class="p">,</span> <span class="s2">&quot;Magazine Luiza&quot;</span><span class="p">,</span> <span class="s2">&quot;B2W&quot;</span><span class="p">,</span> <span class="s2">&quot;Via&quot;</span><span class="p">],</span>
                <span class="s2">&quot;market_size&quot;</span><span class="p">:</span> <span class="s2">&quot;Crescimento de 20</span><span class="si">% a</span><span class="s2">o ano&quot;</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;healthcare&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Electronic health records&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Telemedicine platforms&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Medical device integration&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Insurance APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Regulatory compliance (HIPAA)&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;companies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Dasa&quot;</span><span class="p">,</span> <span class="s2">&quot;Fleury&quot;</span><span class="p">,</span> <span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="s2">&quot;Teladoc&quot;</span><span class="p">,</span> <span class="s2">&quot;Philips&quot;</span><span class="p">],</span>
                <span class="s2">&quot;regulatory_requirements&quot;</span><span class="p">:</span> <span class="s2">&quot;Alta conformidade necess√°ria&quot;</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;logistics&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;use_cases&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Route optimization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Real-time tracking&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fleet management&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Warehouse automation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Last-mile delivery&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;companies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Loggi&quot;</span><span class="p">,</span> <span class="s2">&quot;Rappi&quot;</span><span class="p">,</span> <span class="s2">&quot;iFood&quot;</span><span class="p">,</span> <span class="s2">&quot;99&quot;</span><span class="p">,</span> <span class="s2">&quot;Uber&quot;</span><span class="p">],</span>
                <span class="s2">&quot;growth_driver&quot;</span><span class="p">:</span> <span class="s2">&quot;E-commerce boom&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">skill_development_roadmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ROADMAP DE DESENVOLVIMENTO: Plano de carreira estruturado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;beginner_level&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;3-6 meses&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skills_to_develop&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;HTTP fundamentals&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;REST principles&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;FastAPI basics&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Database fundamentals&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Git version control&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;projects_to_build&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;CRUD API simples&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API com autentica√ß√£o&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Integration com APIs externas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Documenta√ß√£o OpenAPI&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;target_roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Junior Backend Developer&quot;</span><span class="p">,</span> <span class="s2">&quot;API Developer&quot;</span><span class="p">]</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;intermediate_level&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;6-12 meses&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skills_to_develop&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Advanced FastAPI features&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Database optimization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Caching strategies&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Testing automation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Docker containerization&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;projects_to_build&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Microservices architecture&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API with complex business logic&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Performance optimized API&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;CI/CD pipeline&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;target_roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Backend Developer&quot;</span><span class="p">,</span> <span class="s2">&quot;API Engineer&quot;</span><span class="p">]</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;advanced_level&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="s2">&quot;12+ meses&quot;</span><span class="p">,</span>
                <span class="s2">&quot;skills_to_develop&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;System architecture design&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Kubernetes orchestration&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Service mesh implementation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API governance&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Team leadership&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;projects_to_build&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Distributed system design&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API platform from scratch&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Large-scale performance optimization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Open source contributions&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;target_roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Senior Engineer&quot;</span><span class="p">,</span> <span class="s2">&quot;Tech Lead&quot;</span><span class="p">,</span> <span class="s2">&quot;API Architect&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="preparacao-para-o-mercado-de-trabalho">
<h4>5.4.2. Prepara√ß√£o para o Mercado de Trabalho<a class="headerlink" href="#preparacao-para-o-mercado-de-trabalho" title="Link to this heading">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># PREPARA√á√ÉO: Estrat√©gias para inser√ß√£o no mercado</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CareerPreparationStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estrat√©gias pr√°ticas para prepara√ß√£o profissional.</span>
<span class="sd">    </span>
<span class="sd">    FOCO: Constru√ß√£o de portf√≥lio e desenvolvimento de compet√™ncias</span>
<span class="sd">    valorizadas pelo mercado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">portfolio_development</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PORTF√ìLIO T√âCNICO: Projetos que impressionam recrutadores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;essential_projects&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;1_comprehensive_api&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;API completa com todas as funcionalidades estudadas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technologies&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;FastAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;PostgreSQL&quot;</span><span class="p">,</span> <span class="s2">&quot;Redis&quot;</span><span class="p">,</span> <span class="s2">&quot;Docker&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;JWT Authentication&quot;</span><span class="p">,</span> <span class="s2">&quot;OpenAPI docs&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;features_to_include&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;CRUD operations&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;User authentication&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Role-based permissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Rate limiting&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;Caching&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Error handling&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Comprehensive tests&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;API documentation&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;deployment&quot;</span><span class="p">:</span> <span class="s2">&quot;Heroku, AWS, ou DigitalOcean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;github_best_practices&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;README detalhado&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Code documentation&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;CI/CD setup&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Issue templates&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Contributing guidelines&quot;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                
                <span class="s2">&quot;2_microservices_project&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Arquitetura de microservices comunicando via APIs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;services&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;User service&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Product service&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;Order service&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Notification service&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;API Gateway&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;technologies&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;FastAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;Docker Compose&quot;</span><span class="p">,</span> <span class="s2">&quot;PostgreSQL&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Redis&quot;</span><span class="p">,</span> <span class="s2">&quot;RabbitMQ/Kafka&quot;</span><span class="p">,</span> <span class="s2">&quot;Nginx&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;advanced_features&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Service discovery&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Circuit breakers&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Distributed tracing&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Centralized logging&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Health checks&quot;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                
                <span class="s2">&quot;3_real_world_integration&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;API que integra com servi√ßos reais&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;integrations&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;Payment gateway (Stripe/PagSeguro)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Email service (SendGrid/Mailgun)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;SMS service (Twilio)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;File storage (AWS S3)&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;External APIs (Google Maps, Weather)&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;business_value&quot;</span><span class="p">:</span> <span class="s2">&quot;Demonstra capacidade de trabalhar com sistemas reais&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;open_source_contributions&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;benefits&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Visibilidade na comunidade&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Experi√™ncia com codebases grandes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Networking com outros desenvolvedores&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Demonstra√ß√£o de c√≥digo de qualidade&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;strategies&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Contribuir para FastAPI ecosystem&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Criar plugins √∫teis&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Escrever tutorials e documenta√ß√£o&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Reportar e corrigir bugs&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Manter projetos pr√≥prios ativos&quot;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">interview_preparation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PREPARA√á√ÉO PARA ENTREVISTAS: T√≥picos e pr√°ticas essenciais.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;technical_topics&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;fundamentals&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;REST principles e Richardson Maturity Model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;HTTP methods e status codes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Authentication vs Authorization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API versioning strategies&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Error handling best practices&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;intermediate&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Database design e optimization&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Caching strategies&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Rate limiting implementation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API security considerations&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Testing strategies (unit, integration, e2e)&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;advanced&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Microservices communication patterns&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Circuit breaker e bulkhead patterns&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Event-driven architecture&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API governance e standards&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Performance optimization at scale&quot;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;practical_exercises&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;coding_challenges&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Design uma API para sistema de e-commerce&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Implemente rate limiting sem bibliotecas externas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Crie um sistema de cache com invalida√ß√£o inteligente&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Desenhe arquitetura para 1M+ requests/day&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Refatore c√≥digo legacy para FastAPI&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;system_design&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;API Gateway para microservices&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Sistema de notifica√ß√µes em tempo real&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Plataforma de streaming de dados&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Sistema de pagamentos distribu√≠do&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API analytics platform&quot;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;soft_skills_preparation&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Comunica√ß√£o t√©cnica clara&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Capacidade de explicar trade-offs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Experi√™ncia com trabalho em equipe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Resolu√ß√£o de problemas complexos&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mentoring e knowledge sharing&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">continuous_learning_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        APRENDIZADO CONT√çNUO: Mantendo-se atualizado na √°rea.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;learning_resources&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;books&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Building APIs with Node.js - Caio Ribeiro Pereira&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;RESTful Web Services - Leonard Richardson&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Microservices Patterns - Chris Richardson&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Building Microservices - Sam Newman&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API Design Patterns - JJ Geewax&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;online_courses&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;FastAPI courses on Udemy/Coursera&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Microservices architecture courses&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;AWS/Azure API management&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Kubernetes for developers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;System design courses&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;communities&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;FastAPI Discord/GitHub&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Python Brasil community&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Stack Overflow contributions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Reddit r/webdev, r/Python&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Local Python meetups&quot;</span>
                <span class="p">]</span>
            <span class="p">},</span>
            
            <span class="s2">&quot;skill_tracking&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;technical_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;New frameworks and libraries&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Cloud platform certifications&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Security best practices&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Performance optimization techniques&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Emerging protocols (GraphQL, gRPC)&quot;</span>
                <span class="p">],</span>
                
                <span class="s2">&quot;business_skills&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;API product management&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Developer experience design&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;API monetization strategies&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Compliance e governance&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Cross-functional collaboration&quot;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="c1"># EXEMPLO PR√ÅTICO: Template de projeto para portf√≥lio</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PortfolioProjectTemplate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Template completo para projeto de portf√≥lio impressionante.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">project_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ESTRUTURA DE PROJETO: Organiza√ß√£o profissional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        biblioteca-api/</span>
<span class="s2">        ‚îú‚îÄ‚îÄ README.md                   # Documenta√ß√£o principal</span>
<span class="s2">        ‚îú‚îÄ‚îÄ requirements.txt            # Depend√™ncias</span>
<span class="s2">        ‚îú‚îÄ‚îÄ Dockerfile                  # Container configuration</span>
<span class="s2">        ‚îú‚îÄ‚îÄ docker-compose.yml          # Multi-service setup</span>
<span class="s2">        ‚îú‚îÄ‚îÄ .github/                    # GitHub workflows</span>
<span class="s2">        ‚îÇ   ‚îî‚îÄ‚îÄ workflows/</span>
<span class="s2">        ‚îÇ       ‚îú‚îÄ‚îÄ ci.yml             # Continuous integration</span>
<span class="s2">        ‚îÇ       ‚îî‚îÄ‚îÄ cd.yml             # Continuous deployment</span>
<span class="s2">        ‚îú‚îÄ‚îÄ app/                        # Application code</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ main.py                # Application entry point</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ models/                # Pydantic models</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ routers/               # API routes</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ services/              # Business logic</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ core/                  # Configuration &amp; utilities</span>
<span class="s2">        ‚îÇ   ‚îî‚îÄ‚îÄ tests/                 # Test suite</span>
<span class="s2">        ‚îú‚îÄ‚îÄ docs/                       # Additional documentation</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ api-design.md          # API design decisions</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ deployment.md          # Deployment guide</span>
<span class="s2">        ‚îÇ   ‚îî‚îÄ‚îÄ contributing.md        # Contribution guidelines</span>
<span class="s2">        ‚îú‚îÄ‚îÄ infra/                      # Infrastructure as code</span>
<span class="s2">        ‚îÇ   ‚îú‚îÄ‚îÄ terraform/             # Terraform configs</span>
<span class="s2">        ‚îÇ   ‚îî‚îÄ‚îÄ k8s/                   # Kubernetes manifests</span>
<span class="s2">        ‚îî‚îÄ‚îÄ monitoring/                 # Observability configs</span>
<span class="s2">            ‚îú‚îÄ‚îÄ grafana/               # Grafana dashboards</span>
<span class="s2">            ‚îî‚îÄ‚îÄ prometheus/            # Prometheus rules</span>
<span class="s2">        &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">readme_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        README PROFISSIONAL: Template que impressiona recrutadores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # üìö Biblioteca API - Sistema de Gerenciamento de Biblioteca Digital</span>
<span class="s2">        </span>
<span class="s2">        &gt; API REST moderna constru√≠da com FastAPI para gerenciamento completo de biblioteca digital</span>
<span class="s2">        </span>
<span class="s2">        ## ‚ú® Highlights</span>
<span class="s2">        </span>
<span class="s2">        - üöÄ **Performance**: Suporta 10,000+ requests/segundo</span>
<span class="s2">        - üîí **Seguran√ßa**: JWT authentication + role-based access control</span>
<span class="s2">        - üìä **Observabilidade**: M√©tricas Prometheus + dashboards Grafana</span>
<span class="s2">        - üß™ **Qualidade**: 95%+ test coverage</span>
<span class="s2">        - üê≥ **Deploy**: Containerizado com Docker + Kubernetes ready</span>
<span class="s2">        - üìñ **Documenta√ß√£o**: OpenAPI + postman collections</span>
<span class="s2">        </span>
<span class="s2">        ## üèóÔ∏è Arquitetura</span>
<span class="s2">        </span>
<span class="s2">        ```mermaid</span>
<span class="s2">        graph TB</span>
<span class="s2">            Client[Client Apps] --&gt; Gateway[API Gateway]</span>
<span class="s2">            Gateway --&gt; Auth[Auth Service]</span>
<span class="s2">            Gateway --&gt; Books[Books Service] </span>
<span class="s2">            Gateway --&gt; Users[Users Service]</span>
<span class="s2">            Books --&gt; DB[(PostgreSQL)]</span>
<span class="s2">            Books --&gt; Cache[(Redis)]</span>
<span class="s2">        ```</span>
<span class="s2">        </span>
<span class="s2">        ## üöÄ Quick Start</span>
<span class="s2">        </span>
<span class="s2">        ```bash</span>
<span class="s2">        # Clone e setup</span>
<span class="s2">        git clone https://github.com/seu-usuario/biblioteca-api</span>
<span class="s2">        cd biblioteca-api</span>
<span class="s2">        </span>
<span class="s2">        # Run com Docker</span>
<span class="s2">        docker-compose up -d</span>
<span class="s2">        </span>
<span class="s2">        # API dispon√≠vel em http://localhost:8000</span>
<span class="s2">        # Docs em http://localhost:8000/docs</span>
<span class="s2">        ```</span>
<span class="s2">        </span>
<span class="s2">        ## üí° Funcionalidades</span>
<span class="s2">        </span>
<span class="s2">        ### Core Features</span>
<span class="s2">        - ‚úÖ CRUD completo de livros, autores e usu√°rios</span>
<span class="s2">        - ‚úÖ Sistema de empr√©stimos com datas</span>
<span class="s2">        - ‚úÖ Busca avan√ßada com filtros</span>
<span class="s2">        - ‚úÖ Upload de capas de livros</span>
<span class="s2">        </span>
<span class="s2">        ### Advanced Features  </span>
<span class="s2">        - ‚úÖ Rate limiting (100 req/min por usu√°rio)</span>
<span class="s2">        - ‚úÖ Circuit breaker para APIs externas</span>
<span class="s2">        - ‚úÖ Cache inteligente (Redis + TTL)</span>
<span class="s2">        - ‚úÖ Bulk operations (at√© 1000 itens)</span>
<span class="s2">        - ‚úÖ Real-time notifications (WebSocket)</span>
<span class="s2">        </span>
<span class="s2">        ## üîß Tech Stack</span>
<span class="s2">        </span>
<span class="s2">        | Categoria | Tecnologia |</span>
<span class="s2">        |-----------|------------|</span>
<span class="s2">        | **Backend** | FastAPI 0.104, Python 3.11 |</span>
<span class="s2">        | **Database** | PostgreSQL 15, Redis 7 |</span>
<span class="s2">        | **Auth** | JWT, bcrypt, OAuth2 |</span>
<span class="s2">        | **Testing** | pytest, pytest-asyncio |</span>
<span class="s2">        | **Monitoring** | Prometheus, Grafana |</span>
<span class="s2">        | **Deploy** | Docker, Kubernetes, AWS |</span>
<span class="s2">        </span>
<span class="s2">        ## üìä Performance Metrics</span>
<span class="s2">        </span>
<span class="s2">        - **Lat√™ncia P95**: &lt; 100ms</span>
<span class="s2">        - **Throughput**: 10,000+ RPS</span>
<span class="s2">        - **Uptime**: 99.9% SLA</span>
<span class="s2">        - **Test Coverage**: 95%+</span>
<span class="s2">        </span>
<span class="s2">        ## üèÉ‚Äç‚ôÇÔ∏è Demo</span>
<span class="s2">        </span>
<span class="s2">        **Live API**: https://biblioteca-api.herokuapp.com</span>
<span class="s2">        **Documenta√ß√£o**: https://biblioteca-api.herokuapp.com/docs</span>
<span class="s2">        **Monitoring**: https://grafana.biblioteca-api.com</span>
<span class="s2">        </span>
<span class="s2">        ## ü§ù Contributing</span>
<span class="s2">        </span>
<span class="s2">        Contributions welcome! Veja [CONTRIBUTING.md](CONTRIBUTING.md)</span>
<span class="s2">        </span>
<span class="s2">        ## üìÑ License</span>
<span class="s2">        </span>
<span class="s2">        MIT License - veja [LICENSE](LICENSE)</span>
<span class="s2">        &quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="reflexoes-finais-e-proximos-passos">
<h3>5.5. Reflex√µes Finais e Pr√≥ximos Passos<a class="headerlink" href="#reflexoes-finais-e-proximos-passos" title="Link to this heading">#</a></h3>
<section id="sintese-da-jornada-de-aprendizado">
<h4>5.5.1. S√≠ntese da Jornada de Aprendizado<a class="headerlink" href="#sintese-da-jornada-de-aprendizado" title="Link to this heading">#</a></h4>
<p>Esta jornada atrav√©s do mundo das APIs REST representou muito mais que um curso t√©cnico - foi uma imers√£o completa no ecossistema que sustenta a economia digital moderna. Come√ßamos com conceitos fundamentais e evolu√≠mos para implementa√ß√µes de n√≠vel enterprise, demonstrando como APIs bem projetadas s√£o a espinha dorsal de sistemas escal√°veis e resilientes.</p>
<p><strong>O que conquistamos:</strong></p>
<ol class="arabic simple">
<li><p><strong>Dom√≠nio T√©cnico Completo</strong>: Desde valida√ß√£o b√°sica at√© patterns avan√ßados de resili√™ncia</p></li>
<li><p><strong>Vis√£o Arquitetural</strong>: Compreens√£o de como APIs se encaixam em sistemas distribu√≠dos</p></li>
<li><p><strong>Pr√°ticas de Produ√ß√£o</strong>: Implementa√ß√£o de solu√ß√µes prontas para ambientes reais</p></li>
<li><p><strong>Mentalidade de Qualidade</strong>: Testes, documenta√ß√£o e observabilidade como cidad√£os de primeira classe</p></li>
</ol>
</section>
<section id="mapa-mental">
<h4>5.5.2. Mapa Mental<a class="headerlink" href="#mapa-mental" title="Link to this heading">#</a></h4>
<pre  class="mermaid">
        mindmap
  root((APIs REST
    com FastAPI))
    
    üèóÔ∏è Fundamentos
      REST Principles
        Stateless
        Uniform Interface
        Cacheable
        Client-Server
        Layered System
      HTTP Protocol
        Methods (GET, POST, PUT, PATCH, DELETE)
        Status Codes (2xx, 3xx, 4xx, 5xx)
        Headers
        Content Negotiation
      Richardson Maturity Model
        Level 0: POX
        Level 1: Resources
        Level 2: HTTP Verbs
        Level 3: HATEOAS
    
    üîß FastAPI Core
      Framework Features
        Auto Documentation
        Type Hints
        Async Support
        Dependency Injection
      Pydantic Models
        Data Validation
        Serialization
        Custom Validators
        Response Models
      Request Handling
        Path Parameters
        Query Parameters
        Request Body
        File Uploads
      Response Management
        Status Codes
        Headers
        Multiple Formats
        Error Responses
    
    üìä Data Management
      Validation
        Input Validation
        Business Rules
        Format Validation
        Cross-field Validation
      Database Integration
        ORM Usage
        Query Optimization
        Transactions
        Migrations
      CRUD Operations
        Create Resources
        Read Resources
        Update Resources
        Delete Resources
      Advanced Queries
        Filtering
        Pagination
        Sorting
        Search
    
    üîí Security
      Authentication
        JWT Tokens
        OAuth2
        API Keys
        Session Management
      Authorization
        Role-Based Access
        Permission Systems
        Resource Protection
        Scope Management
      Security Best Practices
        Password Hashing
        Input Sanitization
        HTTPS Enforcement
        CORS Configuration
        Rate Limiting
    
    üåê External Integration
      API Consumption
        HTTP Clients (httpx)
        Error Handling
        Retry Policies
        Timeout Management
      Service Communication
        Synchronous Calls
        Asynchronous Calls
        Circuit Breakers
        Fallback Strategies
      Data Enrichment
        External API Integration
        Data Transformation
        Caching Strategies
        Background Tasks
    
    ‚ö° Performance
      Optimization Techniques
        Database Indexing
        Query Optimization
        Eager Loading
        Bulk Operations
      Caching Strategies
        In-Memory Cache
        Distributed Cache (Redis)
        Cache Invalidation
        TTL Management
      Scalability Patterns
        Load Balancing
        Connection Pooling
        Resource Limits
        Background Processing
      Monitoring
        Metrics Collection
        Performance Tracking
        Error Monitoring
        Resource Usage
    
    üß™ Testing
      Test Types
        Unit Tests
        Integration Tests
        End-to-End Tests
        Load Tests
      Testing Tools
        pytest
        FastAPI TestClient
        Mock Services
        Test Fixtures
      Test Strategies
        Test-Driven Development
        Behavior-Driven Development
        Contract Testing
        Continuous Testing
    
    üìã Documentation
      Auto Documentation
        OpenAPI/Swagger
        Interactive Docs
        Schema Generation
        API Explorer
      Manual Documentation
        README Files
        API Guides
        Code Examples
        Best Practices
      Client Tools
        Postman Collections
        curl Examples
        SDK Generation
        API Specifications
    
    üöÄ Production
      Deployment
        Containerization (Docker)
        Orchestration (Kubernetes)
        Cloud Platforms
        Environment Management
      DevOps Integration
        CI/CD Pipelines
        Automated Testing
        Deployment Automation
        Infrastructure as Code
      Monitoring &amp; Observability
        Application Metrics
        Log Aggregation
        Distributed Tracing
        Health Checks
      Reliability
        High Availability
        Disaster Recovery
        Backup Strategies
        Error Recovery
    
    üåü Advanced Topics
      Microservices
        Service Architecture
        API Gateway
        Service Discovery
        Inter-service Communication
      Cloud Native
        Serverless APIs
        Edge Computing
        Auto-scaling
        Service Mesh
      Emerging Technologies
        GraphQL Integration
        AI/ML APIs
        Real-time APIs
        Event-driven Architecture
    
    üíº Career &amp; Market
      Job Opportunities
        Backend Developer
        API Engineer
        Platform Engineer
        DevOps Engineer
      Skills Development
        Technical Skills
        Soft Skills
        Continuous Learning
        Portfolio Building
      Industry Applications
        Fintech
        E-commerce
        Healthcare
        Logistics
        Technology
    </pre></section>
<section id="impacto-transformador-das-apis">
<h4>5.5.3. Impacto Transformador das APIs<a class="headerlink" href="#impacto-transformador-das-apis" title="Link to this heading">#</a></h4>
<p>APIs REST transcenderam sua fun√ß√£o t√©cnica original para se tornarem enablers de transforma√ß√£o digital. Elas democratizam o acesso a funcionalidades complexas, permitem composi√ß√£o de servi√ßos e aceleram a inova√ß√£o atrav√©s de ecossistemas de desenvolvedores.</p>
<p><strong>Reflex√£o sobre o futuro:</strong></p>
<ul class="simple">
<li><p>APIs continuar√£o evoluindo com novas tecnologias (AI, edge computing, IoT)</p></li>
<li><p>A import√¢ncia da developer experience s√≥ tende a crescer</p></li>
<li><p>Seguran√ßa e privacidade se tornar√£o ainda mais cr√≠ticas</p></li>
<li><p>A necessidade de APIs sustent√°veis e eficientes energeticamente emergir√°</p></li>
</ul>
</section>
<section id="chamada-para-acao">
<h4>5.5.4. Chamada para A√ß√£o<a class="headerlink" href="#chamada-para-acao" title="Link to this heading">#</a></h4>
<p>Este conhecimento √© apenas o in√≠cio. O verdadeiro aprendizado acontece na pr√°tica, enfrentando problemas reais e construindo solu√ß√µes que impactam usu√°rios verdadeiros.</p>
<p><strong>Seus pr√≥ximos passos:</strong></p>
<ol class="arabic simple">
<li><p><strong>Aplique imediatamente</strong>: Comece um projeto pessoal usando os conceitos aprendidos</p></li>
<li><p><strong>Contribua com a comunidade</strong>: Compartilhe conhecimento atrav√©s de artigos, talks ou c√≥digo aberto</p></li>
<li><p><strong>Mantenha-se atualizado</strong>: APIs evoluem rapidamente - continue aprendendo</p></li>
<li><p><strong>Busque feedback</strong>: Pe√ßa code reviews e participe de comunidades t√©cnicas</p></li>
<li><p><strong>Ensine outros</strong>: A melhor forma de consolidar conhecimento √© ensinando</p></li>
</ol>
<p><strong>Lembre-se:</strong> Toda grande aplica√ß√£o moderna depende de APIs bem constru√≠das. Voc√™ agora possui as ferramentas e conhecimento para criar sistemas que fazem a diferen√ßa no mundo real.</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="referencias-e-leituras-adicionais">
<h2>Refer√™ncias e Leituras Adicionais<a class="headerlink" href="#referencias-e-leituras-adicionais" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://fastapi.tiangolo.com/">Documenta√ß√£o FastAPI</a></p></li>
<li><p><a class="reference external" href="https://docs.pydantic.dev/">Pydantic</a></p></li>
<li><p><a class="reference external" href="https://www.python-httpx.org/">httpx</a></p></li>
<li><p><a class="reference external" href="https://swagger.io/specification/">OpenAPI</a></p></li>
<li><p><a class="reference external" href="https://www.postman.com/">Postman</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs/aulas/aula-09-14-construcao-consumo-apis-rest"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../aula-07-08-refatoracao-code-smells-sonarcloud/README.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Refatora√ß√£o de C√≥digos, Code Smells e Integra√ß√£o com SonarCloud</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sumario">Sum√°rio</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abertura-e-engajamento">1. Abertura e Engajamento</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problema-motivador">1.1. Problema Motivador</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contexto-historico-e-relevancia-atual">1.2. Contexto Hist√≥rico e Relev√¢ncia Atual</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fundamentos-teoricos">2. Fundamentos Te√≥ricos</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definicao-e-principios-de-apis-rest">2.1. Defini√ß√£o e Princ√≠pios de APIs REST</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#terminologia-essencial-e-definicoes-formais">2.1.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-dos-principios-rest">2.1.2. Estrutura Conceitual dos Princ√≠pios REST</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-de-consequencias-e-trade-offs">2.1.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analise-critica-e-faq">2.1.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fastapi-arquitetura-e-ecossistema">2.2. FastAPI: Arquitetura e Ecossistema</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">2.2.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-do-fastapi">2.2.2. Estrutura Conceitual do FastAPI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">2.2.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">2.2.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pydantic-para-validacao-de-dados">2.3. Pydantic para Valida√ß√£o de Dados</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">2.3.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-da-validacao">2.3.2. Estrutura Conceitual da Valida√ß√£o</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">2.3.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">2.3.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tratamento-de-erros-e-consumo-de-apis-externas">2.4. Tratamento de Erros e Consumo de APIs Externas</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">2.4.1. Terminologia Essencial e Defini√ß√µes Formais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estrutura-conceitual-do-tratamento-de-erros">2.4.2. Estrutura Conceitual do Tratamento de Erros</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">2.4.3. An√°lise de Consequ√™ncias e Trade-offs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">2.4.4. An√°lise Cr√≠tica e FAQ</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aplicacao-pratica-e-implementacao">3. Aplica√ß√£o Pr√°tica e Implementa√ß√£o</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estudo-de-caso-guiado">3.1. Estudo de Caso Guiado</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-1-configuracao-do-ambiente-e-estrutura-do-projeto">Passo 1: Configura√ß√£o do Ambiente e Estrutura do Projeto</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-2-definindo-modelos-de-dados-com-pydantic">Passo 2: Definindo Modelos de Dados com Pydantic</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-3-criando-rotas-restful-com-fastapi">Passo 3: Criando Rotas RESTful com FastAPI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-4-implementando-consumo-de-apis-externas">Passo 4: Implementando Consumo de APIs Externas</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-5-implementando-sistema-de-cache">Passo 5: Implementando Sistema de Cache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-6-configuracao-da-aplicacao-principal">Passo 6: Configura√ß√£o da Aplica√ß√£o Principal</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#passo-7-testes-automatizados">Passo 7: Testes Automatizados</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exemplos-de-codigo-comentado">3.2. Exemplos de C√≥digo Comentado</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ferramentas-bibliotecas-e-ecossistema">3.3. Ferramentas, Bibliotecas e Ecossistema</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-principais">Depend√™ncias Principais</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-de-desenvolvimento-e-teste">Depend√™ncias de Desenvolvimento e Teste</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencias-de-infraestrutura">Depend√™ncias de Infraestrutura</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#recursos-nativos-do-python">Recursos Nativos do Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decisoes-arquiteturais">Decis√µes Arquiteturais</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#topicos-avancados-e-nuances">4. T√≥picos Avan√ßados e Nuances</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autenticacao-e-autorizacao">4.1. Autentica√ß√£o e Autoriza√ß√£o</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacao-de-jwt-json-web-tokens">4.1.1. Implementa√ß√£o de JWT (JSON Web Tokens)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#api-keys-e-rate-limiting">4.1.2. API Keys e Rate Limiting</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estrategias-de-resiliencia-e-confiabilidade">4.2. Estrat√©gias de Resili√™ncia e Confiabilidade</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#circuit-breaker-pattern">4.2.1. Circuit Breaker Pattern</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bulk-operations-e-otimizacao-de-performance">4.2.2. Bulk Operations e Otimiza√ß√£o de Performance</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#caching-strategies-avancadas">4.2.3. Caching Strategies Avan√ßadas</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#otimizacao-de-performance-e-scalability">4.3. Otimiza√ß√£o de Performance e Scalability</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-optimization-patterns">4.3.1. Database Optimization Patterns</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sintese-e-perspectivas-futuras">5. S√≠ntese e Perspectivas Futuras</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recapitulacao-e-consolidacao-de-conhecimentos">5.1. Recapitula√ß√£o e Consolida√ß√£o de Conhecimentos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#jornada-de-aprendizado-percorrida">5.1.1. Jornada de Aprendizado Percorrida</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#competencias-desenvolvidas">5.1.2. Compet√™ncias Desenvolvidas</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tendencias-e-tecnologias-emergentes">5.2. Tend√™ncias e Tecnologias Emergentes</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#graphql-vs-rest-evolucao-ou-substituicao">5.2.1. GraphQL vs REST: Evolu√ß√£o ou Substitui√ß√£o?</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#arquiteturas-serverless-e-edge-computing">5.2.2. Arquiteturas Serverless e Edge Computing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ai-ml-integration-em-apis">5.2.3. AI/ML Integration em APIs</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#integracao-com-ecossistemas-modernos">5.3. Integra√ß√£o com Ecossistemas Modernos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#microservices-e-service-mesh">5.3.1. Microservices e Service Mesh</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cloud-native-e-kubernetes">5.3.2. Cloud Native e Kubernetes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#oportunidades-de-carreira-e-mercado">5.4. Oportunidades de Carreira e Mercado</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#panorama-do-mercado-de-apis">5.4.1. Panorama do Mercado de APIs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#preparacao-para-o-mercado-de-trabalho">5.4.2. Prepara√ß√£o para o Mercado de Trabalho</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reflexoes-finais-e-proximos-passos">5.5. Reflex√µes Finais e Pr√≥ximos Passos</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#sintese-da-jornada-de-aprendizado">5.5.1. S√≠ntese da Jornada de Aprendizado</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mapa-mental">5.5.2. Mapa Mental</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#impacto-transformador-das-apis">5.5.3. Impacto Transformador das APIs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#chamada-para-acao">5.5.4. Chamada para A√ß√£o</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#referencias-e-leituras-adicionais">Refer√™ncias e Leituras Adicionais</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jackson Antonio do Prado Lima
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>